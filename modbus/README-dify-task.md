# Dify知识库定时任务使用说明

本功能实现了将modbus_data_latest表中的数据定期存入Dify知识库的自动化流程。系统每小时自动收集一次数据，并在每天结束时（23:00后）将当天24小时的数据合并为一个文档上传到Dify知识库。

## 功能特点

1. **每小时数据采集**：系统每小时从modbus_data_latest表获取一次数据
2. **日数据合并**：每天23:00后，系统自动将当天24小时的数据合并为一个文档
3. **清晰命名**：生成的文档使用清晰的命名格式 `Modbus数据_YYYY-MM-DD`，便于后期精准召回
4. **手动触发**：支持手动触发数据采集、合并和上传操作
5. **历史数据上传**：支持选择特定日期，手动合并并上传历史数据
6. **任务管理**：提供Web界面进行任务启停和状态监控

## 使用方法

### 1. 访问任务管理页面

有两种方式可以访问任务管理页面：
- 从主页面点击"定时任务"链接
- 从知识库管理页面点击"定时任务管理"按钮
- 或直接访问 `/dify-task-manager` 路径

### 2. 启动定时任务

1. 在任务管理页面点击"启动任务"按钮
2. 系统会立即执行一次数据采集，并设置为每小时自动执行
3. 任务状态会显示为"运行中"，并显示下次执行时间

### 3. 手动操作

页面提供多种手动操作功能：

- **立即执行一次**：不等待下一个小时，立即执行一次数据采集
- **合并并上传**：选择日期，手动将该日期的数据合并并上传到Dify
- **测试Dify连接**：测试与Dify知识库的连接状态

### 4. 查看运行日志

页面底部会显示最近的运行日志，帮助监控任务运行情况和诊断问题。

## 数据存储结构

1. **小时数据**：保存在 `data/modbus-hourly/YYYY-MM-DD/hour-HH.json` 文件中
2. **合并数据**：保存在 `data/modbus-hourly/YYYY-MM-DD/modbus_data_YYYY-MM-DD.json` 文件中
3. **运行日志**：保存在 `logs/dify-sync/dify-sync-YYYY-MM-DD.log` 文件中

## 配置说明

定时任务的配置与Dify知识库管理配置共享，您可以在知识库管理页面进行配置：
- API端点
- API密钥
- 知识库ID

## 故障排除

如果遇到问题，可以：

1. 查看任务管理页面上的运行日志
2. 使用"测试Dify连接"功能检查连接状态
3. 检查知识库管理页面的配置是否正确
4. 查看服务器日志 `logs/dify-sync/` 目录下的详细日志

## 命令行使用

也可以通过命令行直接操作定时任务：

```bash
# 启动定时任务
node modbus/modbus-data-hourly-task.js

# 测试Dify连接
node modbus/modbus-data-hourly-task.js --test

# 手动合并并上传特定日期的数据
node modbus/modbus-data-hourly-task.js --manual --date 2023-05-15
```