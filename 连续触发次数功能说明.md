# 多条件报警规则 - 连续触发次数功能说明

## 🎯 功能概述

为了避免信号传输延迟造成的误报警，新增了**连续触发次数**的限定条件。当设置的多条件满足触发规则后，需要连续满足设定次数才会真正触发报警。

## 📋 主要特性

### 1. 连续触发次数设置
- **可选范围**: 1-5次
- **默认值**: 2次（推荐）
- **最小值**: 1次（立即触发，等同于原来的行为）
- **最大值**: 5次（最严格的触发条件）

### 2. 智能计数逻辑
- **条件满足时**: 触发计数器 +1
- **条件不满足时**: 触发计数器重置为 0
- **达到阈值时**: 触发报警
- **状态改变时**: 解除报警并重置计数器

### 3. 状态管理
- **实时状态跟踪**: 每个规则独立维护状态
- **连续计数**: 记录当前连续触发次数
- **时间戳记录**: 记录最后检查和触发时间

## 🔧 使用方法

### 创建新规则
1. 进入 **告警设置** 页面
2. 点击 **添加多条件告警规则**
3. 在 **连续触发次数** 下拉框中选择所需次数
4. 设置其他条件并保存

### 修改现有规则
- 现有规则已自动设置为 **2次连续触发**
- 可通过编辑功能修改（开发中）

## 💡 功能优势

### 1. 避免误报警
- **信号抖动**: 防止因信号传输不稳定导致的误报
- **网络延迟**: 减少因网络波动造成的假报警
- **设备噪声**: 过滤设备状态短暂异常的情况

### 2. 提高可靠性
- **连续确认**: 确保报警条件持续存在
- **减少干扰**: 过滤偶发性的数据异常
- **稳定运行**: 提高监控系统的整体稳定性

### 3. 灵活配置
- **个性化设置**: 根据不同设备特性调整触发次数
- **场景适应**: 适应不同的监控环境需求
- **易于管理**: 统一的配置界面

## 📊 工作原理

### 触发逻辑流程

```
数据接收 → 条件判断 → 连续计数 → 达到阈值？ → 触发报警
     ↓           ↓          ↓           ↓
  MQTT数据   多条件检查   计数器+1      是：发送报警
     ↓           ↓          ↓           ↓
  解析数据   AND/OR逻辑   状态更新      否：继续监控
     ↓           ↓          ↓
  实时处理   结果记录   重置计数（条件不满足时）
```

### 状态转换图

```
[初始状态] → [条件满足] → [计数+1] → [未达阈值] → [继续监控]
     ↑                                      ↓
[重置计数] ← [条件不满足] ← [达到阈值] → [触发报警]
     ↑                        ↓
[解除报警] ← [条件变为不满足] ← [报警状态]
```

## 🧪 测试方法

### 使用测试脚本
```bash
# 测试连续触发次数功能
node test-consecutive-trigger.js
```

### 测试步骤
1. **初始化**: 发送不满足条件的数据
2. **第1次**: 发送满足条件的数据（不应触发报警）
3. **第2次**: 发送满足条件的数据（应该触发报警）
4. **解除**: 发送不满足条件的数据（解除报警）

### 观察要点
- 前端界面报警显示时机
- 语音播报触发时机
- 控制台日志输出

## 📈 配置建议

### 推荐设置

| 设备类型 | 推荐次数 | 说明 |
|---------|---------|------|
| 水泵 | 2次 | 避免启停过程中的误报 |
| 风机 | 2次 | 考虑风机启动延迟 |
| 阀门 | 3次 | 阀门动作可能较慢 |
| 传感器 | 2次 | 平衡响应速度和准确性 |
| 通信设备 | 1次 | 通信异常需要立即处理 |

### 特殊场景

- **关键设备**: 建议设置为 1次，确保及时响应
- **频繁波动**: 建议设置为 3-5次，避免过多干扰
- **稳定环境**: 建议设置为 2次，平衡效果最佳

## 🔍 调试信息

### 控制台日志
- 规则检查过程
- 条件满足情况
- 连续触发计数
- 状态变化记录

### 前端显示
- 规则列表中显示触发次数
- 规则详情中显示完整信息
- 报警消息中包含触发次数信息

## 🚀 未来增强

### 计划功能
1. **时间窗口**: 在指定时间窗口内的连续触发
2. **自适应调整**: 根据历史数据自动调整触发次数
3. **统计分析**: 触发次数的统计和分析功能
4. **批量设置**: 批量修改多个规则的触发次数

### 性能优化
- 状态缓存优化
- 内存使用优化
- 并发处理优化

## 📞 技术支持

如果在使用过程中遇到问题，请：
1. 检查控制台日志
2. 使用测试脚本验证功能
3. 查看规则配置是否正确
4. 联系技术支持团队

---

**更新日期**: 2025年1月27日  
**版本**: v1.0.0  
**状态**: 已部署 