# Dify知识库集成使用说明

本文档提供Dify知识库集成功能的详细使用指南，包括知识库的创建、切换、同步管理等操作，以及相关依赖安装说明。

## 1. 功能概述

Dify知识库集成功能允许系统自动将Modbus数据定时同步到Dify知识库中，实现数据的长期存储和智能检索。系统会按照配置的时间间隔（默认每小时）将最新的Modbus数据同步到Dify知识库，并可以根据需要进行手动同步。

主要功能包括：
- 创建和管理知识库
- 配置API连接参数
- 自动定时同步数据
- 手动同步数据
- 查看知识库文档列表和内容

## 2. 访问知识库管理界面

在系统中，通过访问以下URL进入知识库管理界面：
```
http://[系统地址]/dify-knowledge
```

## 3. 知识库配置

### 3.1 基本配置

在"配置信息"面板中，您可以设置以下参数：

- **启用Dify知识库同步**：勾选此选项开启知识库功能
- **API地址**：Dify API的访问地址，通常为`http://localhost/v1`或自定义地址
- **API密钥**：从Dify平台获取的API密钥
- **知识库ID**：要使用的知识库ID
- **同步间隔**：数据同步的时间间隔（毫秒），默认为3600000（1小时）
- **每天文档数量**：每天创建的文档数量，默认为24（每小时一个）

完成配置后，点击"保存配置"按钮保存设置。

### 3.2 创建新知识库

如果您还没有知识库，可以通过以下步骤创建：

1. 在"创建知识库"面板中输入知识库名称和描述
2. 点击"创建知识库"按钮
3. 创建成功后，系统会自动更新"知识库ID"字段
4. 点击"保存配置"保存设置

### 3.3 切换知识库

要切换到不同的知识库：

1. 在"配置信息"面板中修改"知识库ID"字段
2. 输入要使用的知识库ID
3. 点击"保存配置"保存设置
4. 系统会自动连接到新的知识库并更新状态信息

## 4. 知识库同步管理

### 4.1 自动同步

启用自动同步有两种方式：

1. **通过配置**：
   - 勾选"启用Dify知识库同步"选项
   - 设置合适的同步间隔
   - 点击"保存配置"

2. **通过按钮**：
   - 在"知识库状态"面板中点击"启动同步"按钮
   - 系统将按照配置的间隔定时同步数据

### 4.2 停止同步

停止自动同步：
- 在"知识库状态"面板中点击"停止同步"按钮
- 系统将停止定时同步，但不会影响已同步的数据

### 4.3 手动同步

执行一次性的手动同步：
- 在"知识库状态"面板中点击"手动同步"按钮
- 系统将立即执行一次数据同步
- 同步结果会显示在操作日志中

### 4.4 刷新知识库状态

查看最新的知识库状态：
- 点击"刷新知识库"按钮或"刷新状态"按钮
- 系统将重新获取知识库的最新状态信息

## 5. 知识库状态说明

在"知识库状态"面板中，您可以查看以下信息：

- **名称**：当前知识库的名称
- **文档数量**：知识库中的文档总数
- **最后更新**：知识库最后更新的时间
- **同步状态**：当前同步状态，可能的值包括：
  - **已同步化**：数据已成功同步
  - **同步中**：正在执行同步
  - **已初始化但未同步**：系统已连接但未开始同步
  - **未初始化**：系统未连接到知识库

## 6. 知识库文档管理

在"知识库文档列表"面板中，您可以：

- 查看所有文档的列表
- 通过"刷新文档列表"按钮获取最新文档
- 点击"查看"按钮查看文档详细内容

## 7. 依赖清单

以下是Dify知识库集成功能所需的主要依赖：

```json
{
  "dependencies": {
    "axios": "^0.27.2",
    "form-data": "^4.0.0",
    "moment": "^2.29.4",
    "node-cron": "^3.0.2",
    "fs": "0.0.1-security",
    "path": "^0.12.7"
  }
}
```

### 安装指南

如需重新安装依赖，请执行以下命令：

```bash
npm install axios@0.27.2 form-data@4.0.0 moment@2.29.4 node-cron@3.0.2 fs@0.0.1-security path@0.12.7
```

## 8. 故障排除

### 8.1 知识库无法同步

可能的原因及解决方法：
- **API连接错误**：检查API地址和密钥是否正确
- **文档索引中**：等待文档完成索引后再添加分段
- **网络问题**：确保系统能够正常访问Dify API
- **权限问题**：验证API密钥是否具有足够的权限

### 8.2 同步状态不更新

- 点击"刷新知识库"按钮手动刷新状态
- 检查系统日志了解详细错误信息
- 重新启动同步功能

## 9. 最佳实践

1. **合理设置同步间隔**：根据数据变化频率设置适当的同步间隔，避免过于频繁的API调用
2. **定期查看文档状态**：确保文档正常创建和更新
3. **保管好API密钥**：定期更换API密钥以保障系统安全
4. **备份配置**：重要配置变更前备份已有配置

## 10. 相关文件

系统中与Dify知识库集成相关的主要文件：
- `modbus/dify-knowledge-service.js`：核心服务实现
- `modbus/modbus-data-scheduler.js`：定时任务调度器
- `modbus/config.json`：配置文件
- `public/dify-knowledge.html`：管理界面 