<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±¡æ°´å¤„ç†ç«™3Då¯è§†åŒ–å¤§å±</title>
    <link rel="stylesheet" href="css/3d-dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- 3Dæ¸²æŸ“åŒºåŸŸ -->
        <div class="render-container">
            <!-- Three.js 3Dåœºæ™¯å®¹å™¨ -->
            <div id="threejs-container"></div>
            
            <!-- Canvas 2Dé™çº§å®¹å™¨ -->
            <canvas id="canvas2d-container"></canvas>
            
            <!-- æ€§èƒ½ä¿¡æ¯é¢æ¿ -->
            <div class="performance-info">
                <div class="status" id="performance-status">æ£€æµ‹ä¸­...</div>
                <div id="performance-details">
                    <div>FPS: <span id="fps-counter">0</span></div>
                    <div>æ¸²æŸ“æ¨¡å¼: <span id="render-mode">è‡ªåŠ¨</span></div>
                    <div>è®¾å¤‡æ€§èƒ½: <span id="device-performance">æ£€æµ‹ä¸­</span></div>
                </div>
            </div>
            
            <!-- æ¸²æŸ“æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <div class="render-mode-switch">
                <button id="btn-auto" class="active">è‡ªåŠ¨</button>
                <button id="btn-3d">3Dæ¨¡å¼</button>
                <button id="btn-2d">2Dæ¨¡å¼</button>
            </div>
            
            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div style="margin-top: 10px; color: #fff;">æ­£åœ¨åŠ è½½3Dåœºæ™¯...</div>
            </div>
        </div>
        
        <!-- ä¾§è¾¹æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h3>è®¾å¤‡ç›‘æ§</h3>
            
            <!-- è®¾å¤‡åˆ—è¡¨ -->
            <div class="device-list" id="device-list">
                <!-- è®¾å¤‡é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- è®¾å¤‡è¯¦æƒ…é¢æ¿ -->
            <div class="device-details" id="device-details">
                <h4>è®¾å¤‡è¯¦æƒ…</h4>
                <div id="device-info">
                    <p style="color: #adb5bd; text-align: center; margin-top: 50px;">
                        ç‚¹å‡»å·¦ä¾§è®¾å¤‡æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript åº“æ–‡ä»¶ -->
    <script>
        console.log('ğŸ¬ å¼€å§‹åˆå§‹åŒ–3Då¯è§†åŒ–å¤§å±...');
        
        // Three.jsèµ„æºåˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        const threeJSSources = [
            'https://cdnjs.cloudflare.com/ajax/libs/three.js/0.149.0/three.min.js',
            'https://unpkg.com/three@0.149.0/build/three.min.js',
            'https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js',
            'https://threejs.org/build/three.min.js',
            'js/libs/three.min.js'  // æœ¬åœ°å¤‡ç”¨æ–¹æ¡ˆ
        ];
        
        let currentSourceIndex = 0;
        let loadAttempts = 0;
        const maxAttempts = 1; // æ¯ä¸ªæºåªå°è¯•ä¸€æ¬¡ï¼Œé¿å…æ— é™å¾ªç¯
        
        // ç½‘ç»œè¯Šæ–­å‡½æ•°
        function diagnoseEnvironment() {
            console.log('ğŸ” ç¯å¢ƒè¯Šæ–­ä¿¡æ¯:');
            console.log('- é¡µé¢URL:', window.location.href);
            console.log('- åè®®:', window.location.protocol);
            console.log('- åŸŸå:', window.location.hostname);
            console.log('- ç«¯å£:', window.location.port);
            console.log('- åœ¨çº¿çŠ¶æ€:', navigator.onLine);
            console.log('- ç”¨æˆ·ä»£ç†:', navigator.userAgent.substring(0, 100) + '...');
            console.log('- è¿æ¥ç±»å‹:', navigator.connection ? navigator.connection.effectiveType : 'æœªçŸ¥');
        }
        
        // åŠ è½½Three.jsçš„ä¸»å‡½æ•°
        function loadThreeJS() {
            // é˜²æ­¢æ— é™å¾ªç¯
            if (currentSourceIndex >= threeJSSources.length) {
                console.error('âŒ æ‰€æœ‰Three.jsèµ„æºéƒ½åŠ è½½å¤±è´¥');
                diagnoseEnvironment();
                showError('æ‰€æœ‰Three.jsèµ„æºéƒ½åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
                return;
            }
            
            const currentSource = threeJSSources[currentSourceIndex];
            const isLocalFile = !currentSource.startsWith('http');
            
            console.log(`ğŸ”„ å°è¯•åŠ è½½Three.jsæº (${currentSourceIndex + 1}/${threeJSSources.length}):`);
            console.log(`   æºåœ°å€: ${currentSource}`);
            console.log(`   ç±»å‹: ${isLocalFile ? 'æœ¬åœ°æ–‡ä»¶' : 'è¿œç¨‹CDN'}`);
            
            // åˆ›å»ºscriptæ ‡ç­¾
            const script = document.createElement('script');
            script.src = currentSource;
            script.async = true;
            
            const startTime = Date.now();
            
            // è®¾ç½®è¶…æ—¶æœºåˆ¶
            const timeoutDuration = isLocalFile ? 3000 : 8000;
            const timeoutId = setTimeout(() => {
                const elapsed = Date.now() - startTime;
                console.warn(`â° åŠ è½½è¶…æ—¶ (${elapsed}ms): ${currentSource}`);
                script.remove();
                nextSource();
            }, timeoutDuration);
            
            // æˆåŠŸåŠ è½½å¤„ç†
            script.onload = function() {
                clearTimeout(timeoutId);
                const elapsed = Date.now() - startTime;
                console.log(`âœ… èµ„æºåŠ è½½æˆåŠŸ (${elapsed}ms): ${currentSource}`);
                
                // éªŒè¯THREEå¯¹è±¡
                if (typeof THREE !== 'undefined') {
                    console.log('âœ… THREEå¯¹è±¡éªŒè¯æˆåŠŸ');
                    console.log('ğŸ“¦ Three.jsç‰ˆæœ¬:', THREE.REVISION);
                    initializeApplication();
                } else {
                    console.warn('âš ï¸ THREEå¯¹è±¡æœªå®šä¹‰ï¼Œå°è¯•ä¸‹ä¸€ä¸ªèµ„æº');
                    nextSource();
                }
            };
            
            // åŠ è½½å¤±è´¥å¤„ç†
            script.onerror = function(error) {
                clearTimeout(timeoutId);
                const elapsed = Date.now() - startTime;
                console.warn(`âŒ èµ„æºåŠ è½½å¤±è´¥ (${elapsed}ms): ${currentSource}`);
                
                if (!isLocalFile) {
                    console.log('ğŸ” å¯èƒ½çš„CDNåŠ è½½å¤±è´¥åŸå› :');
                    console.log('   - ç½‘ç»œè¿æ¥é—®é¢˜');
                    console.log('   - é˜²ç«å¢™/ä»£ç†é˜»æ­¢');
                    console.log('   - DNSè§£æå¤±è´¥');
                    console.log('   - CORSç­–ç•¥é™åˆ¶');
                } else {
                    console.log('ğŸ” å¯èƒ½çš„æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥åŸå› :');
                    console.log('   - æ–‡ä»¶è·¯å¾„é”™è¯¯');
                    console.log('   - æ–‡ä»¶ä¸å­˜åœ¨æˆ–æŸå');
                    console.log('   - æœåŠ¡å™¨é…ç½®é—®é¢˜');
                }
                
                nextSource();
            };
            
            // æ·»åŠ åˆ°é¡µé¢
            document.head.appendChild(script);
        }
        
        // å°è¯•ä¸‹ä¸€ä¸ªèµ„æº
        function nextSource() {
            currentSourceIndex++;
            loadAttempts++;
            
            // é˜²æ­¢æ— é™å¾ªç¯
            if (loadAttempts > threeJSSources.length * maxAttempts) {
                console.error('âŒ è¶…å‡ºæœ€å¤§å°è¯•æ¬¡æ•°ï¼Œåœæ­¢åŠ è½½');
                diagnoseEnvironment();
                showError('Three.jsåŠ è½½å¤±è´¥<br>å·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°');
                return;
            }
            
            // çŸ­æš‚å»¶è¿Ÿåå°è¯•ä¸‹ä¸€ä¸ªèµ„æº
            setTimeout(loadThreeJS, 100);
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = `<div style="color: #ff6b6b; text-align: center;">${message}</div>`;
            }
        }
        
        // åº”ç”¨åˆå§‹åŒ–
        function initializeApplication() {
            console.log('ğŸ¯ å¼€å§‹åº”ç”¨åˆå§‹åŒ–...');
            
            // ç­‰å¾…DOMåŠ è½½å®Œæˆ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startApplication);
            } else {
                startApplication();
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        function startApplication() {
            console.log('ğŸ“„ DOMå·²å‡†å¤‡å°±ç»ª');
            
            // æœ€ç»ˆéªŒè¯THREEå¯¹è±¡
            if (typeof THREE === 'undefined') {
                console.error('âŒ æœ€ç»ˆéªŒè¯å¤±è´¥ï¼šTHREEå¯¹è±¡æœªå®šä¹‰');
                showError('Three.jsæœªæ­£ç¡®åŠ è½½<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            console.log('âœ… æœ€ç»ˆéªŒè¯æˆåŠŸï¼ŒTHREEå¯¹è±¡å¯ç”¨');
            console.log('ğŸ“¦ Three.jsç‰ˆæœ¬:', THREE.REVISION);
            
            // åŠ è½½3Då¼•æ“æ ¸å¿ƒæ¨¡å—
            loadCoreEngine();
        }
        
        // åŠ è½½3Då¼•æ“æ ¸å¿ƒæ¨¡å—
        function loadCoreEngine() {
            console.log('ğŸ”§ å¼€å§‹åŠ è½½3Då¼•æ“æ ¸å¿ƒæ¨¡å—...');
            
            const script = document.createElement('script');
            script.src = 'js/3d-engine/core.js';
            
            script.onload = function() {
                console.log('âœ… 3Då¼•æ“æ ¸å¿ƒæ¨¡å—åŠ è½½å®Œæˆ');
                initializeDashboard();
            };
            
            script.onerror = function() {
                console.error('âŒ 3Då¼•æ“æ ¸å¿ƒæ¨¡å—åŠ è½½å¤±è´¥');
                showError('3Då¼•æ“æ ¸å¿ƒæ¨¡å—åŠ è½½å¤±è´¥<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•');
            };
            
            document.head.appendChild(script);
        }
        
        // åˆå§‹åŒ–3Dä»ªè¡¨æ¿
        function initializeDashboard() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–3Dä»ªè¡¨æ¿...');
            
            // éªŒè¯THREEå¯¹è±¡ä»ç„¶å¯ç”¨
            if (typeof THREE === 'undefined') {
                console.error('âŒ THREEå¯¹è±¡åœ¨åˆå§‹åŒ–æ—¶ä¸¢å¤±');
                showError('THREE.jså¯¹è±¡ä¸¢å¤±');
                return;
            }
            
            console.log('âœ… THREEå¯¹è±¡éªŒè¯é€šè¿‡');
            
            // æ£€æŸ¥3Då¼•æ“æ˜¯å¦å¯ç”¨
            if (typeof ThreeDEngine !== 'undefined') {
                try {
                    window.dashboard = new ThreeDEngine();
                    window.dashboard.init();
                    console.log('ğŸ‰ 3Dä»ªè¡¨æ¿åˆå§‹åŒ–æˆåŠŸ');
                    
                    // éšè—åŠ è½½åŠ¨ç”»
                    const loading = document.getElementById('loading');
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('âŒ 3Dä»ªè¡¨æ¿åˆå§‹åŒ–å¤±è´¥:', error);
                    showError('3Dä»ªè¡¨æ¿åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            } else {
                console.error('âŒ 3Då¼•æ“æ ¸å¿ƒæ¨¡å—æœªåŠ è½½');
                showError('3Då¼•æ“æ ¸å¿ƒæ¨¡å—æœªåŠ è½½');
            }
            
            // è®¾ç½®UIäº‹ä»¶å¤„ç†
            setupUIEvents();
            
            // å¯åŠ¨æ•°æ®æ›´æ–°å¾ªç¯
            startDataUpdateLoop();
        }
        
        // è®¾ç½®UIäº‹ä»¶å¤„ç†
        function setupUIEvents() {
            console.log('ğŸ® è®¾ç½®UIäº‹ä»¶å¤„ç†...');
            
            // æ¸²æŸ“æ¨¡å¼åˆ‡æ¢æŒ‰é’®
            const buttons = document.querySelectorAll('.render-mode-switch button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
                    buttons.forEach(btn => btn.classList.remove('active'));
                    // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
                    this.classList.add('active');
                    
                    // åˆ‡æ¢æ¸²æŸ“æ¨¡å¼
                    const mode = this.id.replace('btn-', '');
                    if (window.dashboard) {
                        window.dashboard.setRenderMode(mode);
                    }
                });
            });
        }
        
        // å¯åŠ¨æ•°æ®æ›´æ–°å¾ªç¯
        function startDataUpdateLoop() {
            console.log('ğŸ”„ å¯åŠ¨æ•°æ®æ›´æ–°å¾ªç¯...');
            
            // å®šæœŸæ›´æ–°è®¾å¤‡æ•°æ®
            setInterval(function() {
                if (window.dashboard) {
                    window.dashboard.updateDeviceData();
                }
            }, 2000);
        }
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('ğŸ’¥ å…¨å±€é”™è¯¯:', event.error);
            if (event.error && event.error.stack) {
                console.error('é”™è¯¯å †æ ˆ:', event.error.stack);
            }
        });
        
        // åˆå§‹åŒ–è¶…æ—¶ä¿æŠ¤
        setTimeout(function() {
            if (!window.dashboard) {
                console.warn('â° åº”ç”¨åˆå§‹åŒ–è¶…æ—¶ (30ç§’)');
                diagnoseEnvironment();
                showError('åº”ç”¨åˆå§‹åŒ–è¶…æ—¶<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜');
            }
        }, 30000);
        
        // å¼€å§‹åŠ è½½æµç¨‹
        console.log('ğŸš€ å¯åŠ¨Three.jsåŠ è½½æµç¨‹...');
        loadThreeJS();
    </script>
</body>
</html> 