<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•ç‚¹æŠ¥è­¦ç³»ç»Ÿè°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }
        .status.success { background-color: #28a745; }
        .status.error { background-color: #dc3545; }
        .status.warning { background-color: #ffc107; color: #212529; }
        .status.info { background-color: #17a2b8; }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button:hover { background-color: #0056b3; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 5px;
            border-radius: 2px;
        }
        .log-entry.info { background-color: #d1ecf1; }
        .log-entry.success { background-color: #d4edda; }
        .log-entry.error { background-color: #f8d7da; }
        .log-entry.warning { background-color: #fff3cd; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>å•ç‚¹æŠ¥è­¦ç³»ç»Ÿè°ƒè¯•</h1>
    
    <div class="container">
        <h2>ç³»ç»ŸçŠ¶æ€</h2>
        <p>ç›‘æ§çŠ¶æ€: <span id="monitoringStatus" class="status info">æ£€æŸ¥ä¸­...</span></p>
        <p>APIè¿æ¥: <span id="apiStatus" class="status info">æ£€æŸ¥ä¸­...</span></p>
        <p>WebSocketè¿æ¥: <span id="wsStatus" class="status info">è¿æ¥ä¸­...</span></p>
        <button onclick="checkSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button onclick="toggleMonitoring()">å¯åŠ¨/åœæ­¢ç›‘æ§</button>
    </div>
    
    <div class="container">
        <h2>APIæµ‹è¯•</h2>
        <button onclick="testGetRules()">è·å–æŠ¥è­¦è§„åˆ™</button>
        <button onclick="testGetHistory()">è·å–æŠ¥è­¦å†å²</button>
        <button onclick="testCreateRule()">åˆ›å»ºæµ‹è¯•è§„åˆ™</button>
        <button onclick="testCreateTriggerRule()">åˆ›å»ºç«‹å³è§¦å‘è§„åˆ™</button>
        <button onclick="testManualCheck()">æ‰‹åŠ¨è§¦å‘æ£€æŸ¥</button>
        <button onclick="testDataPoints()">æµ‹è¯•æ•°æ®ç‚¹API</button>
        <button onclick="testCacheStatus()">æŸ¥çœ‹ç¼“å­˜çŠ¶æ€</button>
        <button onclick="testCacheUpdate()">æµ‹è¯•ç¼“å­˜æ›´æ–°</button>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="container">
        <h2>æŠ¥è­¦è§„åˆ™</h2>
        <div id="rulesContainer">åŠ è½½ä¸­...</div>
    </div>
    
    <div class="container">
        <h2>WebSocketæ¶ˆæ¯</h2>
        <div id="wsMessages" class="log"></div>
    </div>
    
    <div class="container">
        <h2>è°ƒè¯•æ—¥å¿—</h2>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const debugLog = document.getElementById('debugLog');
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function logWs(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const wsMessages = document.getElementById('wsMessages');
            wsMessages.appendChild(logEntry);
            wsMessages.scrollTop = wsMessages.scrollHeight;
        }
        
        // WebSocketè¿æ¥
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:3000/ws');
                
                ws.onopen = function() {
                    document.getElementById('wsStatus').textContent = 'å·²è¿æ¥';
                    document.getElementById('wsStatus').className = 'status success';
                    logWs('WebSocketè¿æ¥æˆåŠŸ', 'success');
                    reconnectAttempts = 0;
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        logWs(`æ”¶åˆ°æ¶ˆæ¯: ${data.type}`, 'info');
                        
                        if (data.type === 'single_point_alarm') {
                            logWs(`ğŸš¨ å•ç‚¹æŠ¥è­¦: ${JSON.stringify(data.data)}`, 'error');
                            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å£°éŸ³æç¤º
                            if (window.speechSynthesis) {
                                const utterance = new SpeechSynthesisUtterance('æ”¶åˆ°å•ç‚¹æŠ¥è­¦');
                                window.speechSynthesis.speak(utterance);
                            }
                        } else if (data.type === 'single_point_alarm_cleared') {
                            logWs(`âœ… å•ç‚¹æŠ¥è­¦è§£é™¤: ${JSON.stringify(data.data)}`, 'success');
                        } else {
                            logWs(`å…¶ä»–æ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
                        }
                    } catch (error) {
                        logWs(`è§£ææ¶ˆæ¯å¤±è´¥: ${event.data}`, 'error');
                    }
                };
                
                ws.onclose = function() {
                    document.getElementById('wsStatus').textContent = 'å·²æ–­å¼€';
                    document.getElementById('wsStatus').className = 'status error';
                    logWs('WebSocketè¿æ¥æ–­å¼€', 'warning');
                    
                    // è‡ªåŠ¨é‡è¿
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        logWs(`å°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})`, 'warning');
                        setTimeout(connectWebSocket, 3000);
                    }
                };
                
                ws.onerror = function(error) {
                    logWs(`WebSocketé”™è¯¯: ${error}`, 'error');
                };
            } catch (error) {
                logWs(`WebSocketè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // APIè¯·æ±‚å‡½æ•°
        async function apiRequest(url, options = {}) {
            try {
                log(`å‘èµ·APIè¯·æ±‚: ${url}`);
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`APIè¯·æ±‚æˆåŠŸ: ${url}`, 'success');
                    return { success: true, data };
                } else {
                    log(`APIè¯·æ±‚å¤±è´¥: ${url} - ${data.message || data.error}`, 'error');
                    return { success: false, error: data.message || data.error };
                }
            } catch (error) {
                log(`APIè¯·æ±‚å¼‚å¸¸: ${url} - ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            log('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            // æ£€æŸ¥ç›‘æ§çŠ¶æ€
            const statusResult = await apiRequest('/api/single-point-alarm/monitoring/status');
            if (statusResult.success) {
                const isActive = statusResult.data.data.active;
                document.getElementById('monitoringStatus').textContent = isActive ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.getElementById('monitoringStatus').className = `status ${isActive ? 'success' : 'warning'}`;
                log(`ç›‘æ§çŠ¶æ€: ${isActive ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}`, isActive ? 'success' : 'warning');
            } else {
                document.getElementById('monitoringStatus').textContent = 'æ£€æŸ¥å¤±è´¥';
                document.getElementById('monitoringStatus').className = 'status error';
            }
            
            // æ£€æŸ¥APIè¿æ¥
            const apiResult = await apiRequest('/api/single-point-alarm/rules');
            if (apiResult.success) {
                document.getElementById('apiStatus').textContent = 'æ­£å¸¸';
                document.getElementById('apiStatus').className = 'status success';
                log('APIè¿æ¥æ­£å¸¸', 'success');
            } else {
                document.getElementById('apiStatus').textContent = 'å¤±è´¥';
                document.getElementById('apiStatus').className = 'status error';
            }
        }
        
        // åˆ‡æ¢ç›‘æ§
        async function toggleMonitoring() {
            const result = await apiRequest('/api/single-point-alarm/monitoring/toggle', {
                method: 'POST'
            });
            
            if (result.success) {
                log('ç›‘æ§çŠ¶æ€åˆ‡æ¢æˆåŠŸ', 'success');
                await checkSystemStatus();
            } else {
                log('ç›‘æ§çŠ¶æ€åˆ‡æ¢å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•è·å–è§„åˆ™
        async function testGetRules() {
            const result = await apiRequest('/api/single-point-alarm/rules');
            if (result.success) {
                const rules = result.data.data;
                log(`è·å–åˆ° ${rules.length} ä¸ªæŠ¥è­¦è§„åˆ™`, 'success');
                displayRules(rules);
            }
        }
        
        // æ˜¾ç¤ºè§„åˆ™
        function displayRules(rules) {
            const container = document.getElementById('rulesContainer');
            
            if (rules.length === 0) {
                container.innerHTML = '<p>æš‚æ— æŠ¥è­¦è§„åˆ™</p>';
                return;
            }
            
            let html = '<table><tr><th>ID</th><th>åç§°</th><th>æ•°æ®ç‚¹</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>é…ç½®</th></tr>';
            rules.forEach(rule => {
                const config = typeof rule.config === 'string' ? JSON.parse(rule.config) : rule.config;
                html += `<tr>
                    <td>${rule.id}</td>
                    <td>${rule.name}</td>
                    <td>${rule.dataPointId}</td>
                    <td>${rule.alarmType}</td>
                    <td>${rule.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</td>
                    <td>${JSON.stringify(config)}</td>
                </tr>`;
            });
            html += '</table>';
            container.innerHTML = html;
        }
        
        // æµ‹è¯•è·å–å†å²
        async function testGetHistory() {
            const result = await apiRequest('/api/single-point-alarm/history');
            if (result.success) {
                const history = result.data.data;
                log(`è·å–åˆ° ${history.length} æ¡æŠ¥è­¦å†å²`, 'success');
                
                if (history.length > 0) {
                    log('æœ€è¿‘5æ¡æŠ¥è­¦è®°å½•:', 'info');
                    history.slice(0, 5).forEach((record, index) => {
                        const status = record.triggered ? 'ğŸš¨ è§¦å‘' : 'âœ… è§£é™¤';
                        const time = new Date(record.timestamp).toLocaleString('zh-CN');
                        log(`  ${index + 1}. ${status} - ${record.ruleName} (${record.dataPointId}) - ${time}`, 
                            record.triggered ? 'error' : 'success');
                    });
                } else {
                    log('æš‚æ— æŠ¥è­¦å†å²è®°å½•', 'warning');
                }
            }
        }
        
        // åˆ›å»ºæµ‹è¯•è§„åˆ™
        async function testCreateRule() {
            const testRule = {
                name: 'æµ‹è¯•æ— æ›´æ–°æŠ¥è­¦_' + Date.now(),
                dataPointId: 'test_sensor_' + Math.floor(Math.random() * 1000),
                dataPointName: 'æµ‹è¯•ä¼ æ„Ÿå™¨',
                alarmType: 'no_update',
                config: {
                    timeout: 30
                },
                level: 'medium',
                content: 'æµ‹è¯•ä¼ æ„Ÿå™¨æ•°æ®è¶…è¿‡30ç§’æœªæ›´æ–°',
                notifications: {
                    page: true,
                    sound: true
                }
            };
            
            const result = await apiRequest('/api/single-point-alarm/rules', {
                method: 'POST',
                body: JSON.stringify(testRule)
            });
            
            if (result.success) {
                log('æµ‹è¯•è§„åˆ™åˆ›å»ºæˆåŠŸ', 'success');
                await testGetRules(); // åˆ·æ–°è§„åˆ™åˆ—è¡¨
            }
        }
        
        // åˆ›å»ºç«‹å³è§¦å‘çš„æµ‹è¯•è§„åˆ™
        async function testCreateTriggerRule() {
            log('åˆ›å»ºç«‹å³è§¦å‘çš„æµ‹è¯•è§„åˆ™...', 'info');
            
            const result = await apiRequest('/api/single-point-alarm/test/create-trigger-rule', {
                method: 'POST'
            });
            
            if (result.success) {
                log('ç«‹å³è§¦å‘æµ‹è¯•è§„åˆ™åˆ›å»ºæˆåŠŸï¼Œåº”è¯¥ä¼šåœ¨1ç§’å†…è§¦å‘æŠ¥è­¦', 'success');
                log(`è§„åˆ™ä¿¡æ¯: ${result.data.message}`, 'info');
                await testGetRules(); // åˆ·æ–°è§„åˆ™åˆ—è¡¨
                
                // 10ç§’åè‡ªåŠ¨æ£€æŸ¥å†å²è®°å½•
                setTimeout(async () => {
                    log('10ç§’åè‡ªåŠ¨æ£€æŸ¥æŠ¥è­¦å†å²...', 'info');
                    await testGetHistory();
                }, 10000);
            }
        }
        
        // æ‰‹åŠ¨è§¦å‘æ£€æŸ¥
        async function testManualCheck() {
            log('æ‰‹åŠ¨è§¦å‘æŠ¥è­¦è§„åˆ™æ£€æŸ¥...', 'info');
            
            const result = await apiRequest('/api/single-point-alarm/test/manual-check', {
                method: 'POST'
            });
            
            if (result.success) {
                log('æ‰‹åŠ¨æ£€æŸ¥è§¦å‘æˆåŠŸï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹çš„æ—¥å¿—è¾“å‡º', 'success');
                
                // 5ç§’åè‡ªåŠ¨æ£€æŸ¥å†å²è®°å½•
                setTimeout(async () => {
                    log('5ç§’åè‡ªåŠ¨æ£€æŸ¥æŠ¥è­¦å†å²...', 'info');
                    await testGetHistory();
                }, 5000);
            }
        }
        
        // æµ‹è¯•æ•°æ®ç‚¹API
        async function testDataPoints() {
            const endpoints = [
                '/api/modbus/latest-values',
                '/api/modbus/values/latest', 
                '/api/modbus/values'
            ];
            
            for (const endpoint of endpoints) {
                const result = await apiRequest(endpoint);
                if (result.success) {
                    let dataCount = 0;
                    if (result.data.data && typeof result.data.data === 'object') {
                        dataCount = Object.keys(result.data.data).length;
                    } else if (Array.isArray(result.data)) {
                        dataCount = result.data.length;
                    }
                    log(`${endpoint}: æ‰¾åˆ° ${dataCount} ä¸ªæ•°æ®ç‚¹`, 'success');
                } else {
                    log(`${endpoint}: å¤±è´¥`, 'error');
                }
            }
        }
        
        // æµ‹è¯•ç¼“å­˜çŠ¶æ€
        async function testCacheStatus() {
            log('è·å–ç¼“å­˜çŠ¶æ€...', 'info');
            
            const result = await apiRequest('/api/single-point-alarm/cache/status');
            if (result.success) {
                const cache = result.data.data;
                log(`ç¼“å­˜çŠ¶æ€:`, 'success');
                log(`  - æ´»è·ƒæ•°æ®ç‚¹: ${cache.activeDataPoints.length} ä¸ª`, 'info');
                log(`  - å·²ç¼“å­˜æ•°æ®ç‚¹: ${cache.cachedDataPoints.length} ä¸ª`, 'info');
                
                // æ˜¾ç¤ºæ´»è·ƒæ•°æ®ç‚¹åˆ—è¡¨
                if (cache.activeDataPoints.length > 0) {
                    log(`æ´»è·ƒæ•°æ®ç‚¹åˆ—è¡¨: ${cache.activeDataPoints.slice(0, 10).join(', ')}${cache.activeDataPoints.length > 10 ? '...' : ''}`, 'info');
                }
                
                // æ˜¾ç¤ºç¼“å­˜è¯¦æƒ…
                const cachedCount = Object.keys(cache.cacheDetails).length;
                if (cachedCount > 0) {
                    log(`ç¼“å­˜è¯¦æƒ… (å‰5ä¸ª):`, 'info');
                    let count = 0;
                    for (const [dataPointId, details] of Object.entries(cache.cacheDetails)) {
                        if (count >= 5) break;
                        const timeAgo = Math.floor(details.timeSinceUpdate / 1000);
                        log(`  - ${dataPointId}: ${details.value} (${timeAgo}ç§’å‰æ›´æ–°)`, 'info');
                        count++;
                    }
                } else {
                    log('æš‚æ— ç¼“å­˜æ•°æ®', 'warning');
                }
            } else {
                log('è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•ç¼“å­˜æ›´æ–°
        async function testCacheUpdate() {
            log('æµ‹è¯•ç¼“å­˜æ›´æ–°...', 'info');
            
            // å…ˆè·å–ç¼“å­˜çŠ¶æ€ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ´»è·ƒçš„æ•°æ®ç‚¹
            const statusResult = await apiRequest('/api/single-point-alarm/cache/status');
            if (!statusResult.success || statusResult.data.data.activeDataPoints.length === 0) {
                log('æ²¡æœ‰æ´»è·ƒçš„æ•°æ®ç‚¹å¯ä¾›æµ‹è¯•', 'warning');
                return;
            }
            
            const testDataPointId = statusResult.data.data.activeDataPoints[0];
            const testValue = Math.random() * 100;
            
            log(`æµ‹è¯•æ›´æ–°æ•°æ®ç‚¹: ${testDataPointId} = ${testValue.toFixed(2)}`, 'info');
            
            const updateResult = await apiRequest(`/api/single-point-alarm/cache/update/${testDataPointId}`, {
                method: 'POST',
                body: JSON.stringify({
                    value: testValue,
                    timestamp: new Date().toISOString()
                })
            });
            
            if (updateResult.success) {
                log('ç¼“å­˜æ›´æ–°æˆåŠŸ', 'success');
                
                // ç­‰å¾…2ç§’åå†æ¬¡æ£€æŸ¥ç¼“å­˜çŠ¶æ€
                setTimeout(async () => {
                    log('2ç§’åæ£€æŸ¥ç¼“å­˜çŠ¶æ€...', 'info');
                    await testCacheStatus();
                }, 2000);
            } else {
                log(`ç¼“å­˜æ›´æ–°å¤±è´¥: ${updateResult.error}`, 'error');
            }
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('debugLog').innerHTML = '';
            document.getElementById('wsMessages').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...', 'info');
            connectWebSocket();
            checkSystemStatus();
            testGetRules();
        };
    </script>
</body>
</html> 