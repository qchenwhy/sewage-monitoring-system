<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modbus TCP数据监控</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/modbus.css">
  <link rel="stylesheet" href="/css/modbus-sidebar.css">
  <style>
    body {
      padding-top: 60px;
      background-color: #f8f9fa;
    }
    .card {
      margin-bottom: 20px;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      border-radius: 10px;
    }
    .card-header {
      border-radius: 10px 10px 0 0 !important;
      background-color: #f1f5f9;
    }
    .connection-status {
      font-weight: bold;
    }
    .status-connected {
      color: #198754;
    }
    .status-disconnected {
      color: #dc3545;
    }
    .data-point-table {
      font-size: 14px;
    }
    .timestamp {
      font-size: 12px;
      color: #6c757d;
    }
    #loaderContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .modal-dialog {
      max-width: 500px;
    }
    .modal-dialog.modal-lg {
      max-width: 700px;
    }
    .btn-icon {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .navbar-brand {
      font-weight: 600;
      color: #0d6efd;
    }
    .nav-item .nav-link {
      margin-right: 10px;
    }
    .btn-float {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .alarm-item {
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #fff;
      border-left: 4px solid #dc3545;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .alarm-item.warning {
      border-left-color: #ffc107;
    }
    .alarm-title {
      font-weight: bold;
      color: #dc3545;
      margin-bottom: 5px;
    }
    .alarm-desc {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    .alarm-time {
      color: #999;
      font-size: 0.8em;
    }
    .alarm-alert {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      background-color: rgba(220, 53, 69, 0.1);
    }
    #pauseAlarmsBtn.paused {
      background-color: #28a745;
      border-color: #28a745;
    }
    #pauseAlarmsBtn.paused i {
      content: "\F4A2"; /* Bootstrap Icons play icon */
    }
    /* 日报内容样式 */
    .report-content {
      font-size: 14px;
      line-height: 1.6;
    }
    .report-content h1, .report-content h2, .report-content h3 {
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }
    .report-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    .report-content table th, .report-content table td {
      border: 1px solid #dee2e6;
      padding: 0.5rem;
    }
    .report-content table th {
      background-color: #f8f9fa;
    }
    /* 表格标题居中 */
    .table-header-center th {
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- 导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="bi bi-cpu"></i> Modbus监控系统
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="切换导航">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="/modbus">
              <i class="bi bi-speedometer2"></i> 监控面板
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/modbus-data-write.html">
              <i class="bi bi-pencil-square"></i> 数据写入
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/timer">
              <i class="bi bi-alarm"></i> 定时任务
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/speech">
              <i class="bi bi-mic"></i> 语音助手
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/work-tasks">
              <i class="bi bi-list-task"></i> 工作管理
            </a>
          </li>
        </ul>
        <div class="d-flex">
          <div class="me-3">
            <span class="badge rounded-pill bg-light text-dark p-2">
              状态: 
              <span id="connectionStatus" class="connection-status status-disconnected">
                未连接
              </span>
            </span>
          </div>
          <div class="me-3">
            <span class="badge rounded-pill bg-light text-dark p-2">
              数据源: 
              <span id="dataSourceBadge" class="badge rounded-pill bg-primary text-white">
                ModbusTCP
              </span>
            </span>
          </div>
          <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleConnection()" id="connectBtn">
            <i class="bi bi-plug"></i> 连接
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="togglePolling()" id="pollBtn" disabled>
            <i class="bi bi-arrow-repeat"></i> 开始轮询
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- 全局错误/警告提示区域 -->
  <div id="errorContainer" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none; position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1050; width: 90%; max-width: 800px;">
    <div class="d-flex align-items-center">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <span id="errorMessage">错误消息</span>
    </div>
    <button type="button" class="btn-close" onclick="hideError()"></button>
  </div>

  <!-- 警告提示区域 -->
  <div id="warningContainer" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none; position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1050; width: 90%; max-width: 800px;">
    <div class="d-flex align-items-center">
      <i class="bi bi-exclamation-circle-fill me-2"></i>
      <span id="warningMessage">警告消息</span>
    </div>
    <button type="button" class="btn-close" onclick="hideWarning()"></button>
  </div>

  <!-- 页面加载指示器 -->
  <div id="loaderContainer" style="display: none;">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>

  <!-- 侧边栏导航 -->
  <div class="sidebar">
    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
        <a href="#" class="sidebar-nav-link active" data-view="data-display">
          <i class="bi bi-speedometer2 sidebar-icon"></i>
          <span class="sidebar-title">数据展示</span>
        </a>
      </li>
      <li class="sidebar-nav-item">
        <a href="#" class="sidebar-nav-link" data-view="data-create">
          <i class="bi bi-database-add sidebar-icon"></i>
          <span class="sidebar-title">数据创建</span>
        </a>
      </li>
      
      <div class="sidebar-category">智能交互</div>
      
      <li class="sidebar-nav-item">
        <a href="/chat.html" class="sidebar-nav-link">
          <i class="bi bi-chat-dots sidebar-icon"></i>
          <span class="sidebar-title">AI对话</span>
        </a>
      </li>
      
      <li class="sidebar-nav-item">
        <a href="/dify-knowledge.html" class="sidebar-nav-link">
          <i class="bi bi-database-fill-gear sidebar-icon"></i>
          <span class="sidebar-title">知识库管理</span>
        </a>
      </li>
      
      <div class="sidebar-category">定时管理</div>
      
      <li class="sidebar-nav-item">
        <a href="/timer.html" class="sidebar-nav-link">
          <i class="bi bi-alarm sidebar-icon"></i>
          <span class="sidebar-title">计时器设置</span>
        </a>
      </li>
      
      <div class="sidebar-category">告警系统</div>
      
      <li class="sidebar-nav-item">
        <a href="#" class="sidebar-nav-link" data-view="real-time-alarms">
          <i class="bi bi-exclamation-triangle sidebar-icon"></i>
          <span class="sidebar-title">实时告警</span>
        </a>
      </li>
      <li class="sidebar-nav-item">
        <a href="#" class="sidebar-nav-link" data-view="alarm-history">
          <i class="bi bi-clock-history sidebar-icon"></i>
          <span class="sidebar-title">告警历史</span>
        </a>
      </li>
      <li class="sidebar-nav-item">
        <a href="#" class="sidebar-nav-link" data-view="alarm-settings">
          <i class="bi bi-bell sidebar-icon"></i>
          <span class="sidebar-title">告警设置</span>
        </a>
      </li>
      
      <div class="sidebar-category">系统设置</div>
      
      <li class="sidebar-nav-item">
        <a href="#" class="sidebar-nav-link" data-view="user-settings">
          <i class="bi bi-person-gear sidebar-icon"></i>
          <span class="sidebar-title">个人设置</span>
        </a>
      </li>
      <li class="sidebar-nav-item">
        <a href="/web-scraper-manager.html" target="_blank" class="sidebar-nav-link">
          <i class="bi bi-globe sidebar-icon"></i>
          <span class="sidebar-title">网页爬虫管理</span>
        </a>
      </li>
      <li class="sidebar-nav-item">
        <a href="/mqtt-settings" target="_blank" class="sidebar-nav-link">
          <i class="bi bi-cloud-upload sidebar-icon"></i>
          <span class="sidebar-title">MQTT服务器设置</span>
        </a>
      </li>
      <li class="sidebar-nav-item">
        <a href="/mqtt-test.html" target="_blank" class="sidebar-nav-link">
          <i class="bi bi-cloud sidebar-icon"></i>
          <span class="sidebar-title">MQTT测试工具</span>
        </a>
      </li>
      <li class="sidebar-nav-item">
        <a href="/mqtt-guide.html" target="_blank" class="sidebar-nav-link">
          <i class="bi bi-book sidebar-icon"></i>
          <span class="sidebar-title">MQTT使用指南</span>
        </a>
      </li>

      <div class="sidebar-category">系统报表</div>
      <li class="sidebar-nav-item">
        <a href="#" class="sidebar-nav-link" data-view="daily-reports">
          <i class="bi bi-file-earmark-text sidebar-icon"></i>
          <span class="sidebar-title">日报管理</span>
        </a>
      </li>

      <div class="sidebar-category">工作管理</div>
      <li class="sidebar-nav-item">
        <a href="/work-tasks" class="sidebar-nav-link">
          <i class="bi bi-list-task sidebar-icon"></i>
          <span class="sidebar-title">工作内容管理</span>
        </a>
      </li>
    </ul>
  </div>
  
  <!-- 切换侧边栏按钮 -->
  <div class="toggle-sidebar">
    <i class="bi bi-chevron-left"></i>
  </div>

  <div class="content-wrapper">
    <!-- 数据展示视图 -->
    <div class="view-container active" id="data-display">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Modbus数据展示</h2>
          <div>
            <span class="d-inline-block me-4">
              轮询状态: 
              <span id="pollingStatus" class="connection-status status-disconnected">
                未开启
              </span>
              <span id="pollingInterval" class="ms-2 small"></span>
            </span>
            <div class="btn-group">
              <button class="btn btn-primary btn-icon" onclick="showSettingsModal()">
                <i class="bi bi-gear"></i> 连接设置
              </button>
            </div>
          </div>
        </div>
        
        <!-- 数据点卡片容器 -->
        <div class="row mb-4" id="dataPointsContainer">
          <!-- 数据点卡片将动态添加到这里 -->
        </div>
        
        <!-- 数据点列表卡片 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-list me-2"></i>实时数据点列表
            </div>
            <div>
              <button class="btn btn-sm btn-outline-secondary me-2" onclick="debugDataPointsTable()">
                <i class="bi bi-bug"></i> 调试表格
              </button>
              <button class="btn btn-sm btn-outline-info me-2" onclick="showDataPointConfigs()">
                <i class="bi bi-info-circle"></i> 查看数据点配置
              </button>
              <button class="btn btn-sm btn-outline-success me-2" onclick="testMQTTDataPoint()">
                <i class="bi bi-cloud-arrow-up"></i> 测试MQTT数据
              </button>
              <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshDataPoints()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="loadLatestFromDB()">
                <i class="bi bi-database"></i> 从数据库加载
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="noDataPoints" class="alert alert-info" style="display: none;">
              <i class="bi bi-info-circle me-2"></i>未配置任何数据点，请在数据点管理中添加
            </div>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>名称</th>
                    <th>标识符</th>
                    <th>数值</th>
                    <th>更新时间</th>
                    <th class="text-end">操作</th>
                  </tr>
                </thead>
                <tbody id="dataPointsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 数据历史视图（添加到数据管理视图后） -->
    <div class="view-container" id="data-history">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">数据历史记录</h2>
          <div>
            <span class="d-inline-block me-4">
              连接状态: 
              <span id="connectionStatus" class="connection-status status-disconnected">
                未连接
              </span>
            </span>
            <div class="btn-group">
              <button id="connectBtn" class="btn btn-outline-primary btn-sm me-2" onclick="toggleConnection()">
                <i class="bi bi-plug"></i> 连接
              </button>
              <button id="pollBtn" class="btn btn-outline-success btn-sm" onclick="togglePolling()" disabled>
                <i class="bi bi-arrow-repeat"></i> 开始轮询
              </button>
            </div>
          </div>
        </div>
        
        <!-- 数据点选择和时间范围 -->
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <i class="bi bi-search me-2"></i>查询条件
          </div>
          <div class="card-body">
            <form id="historyQueryForm" class="row g-3">
              <div class="col-md-4">
                <label for="dataPointSelect" class="form-label">数据点</label>
                <select id="dataPointSelect" class="form-select">
                  <option value="">-- 选择数据点 --</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="startTimeInput" class="form-label">开始时间</label>
                <input type="datetime-local" class="form-control" id="startTimeInput">
              </div>
              <div class="col-md-3">
                <label for="endTimeInput" class="form-label">结束时间</label>
                <input type="datetime-local" class="form-control" id="endTimeInput">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" onclick="queryHistory()">
                  <i class="bi bi-search"></i> 查询
                </button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- 历史数据结果表格 -->
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-clock-history me-2"></i>历史数据记录
            </div>
            <div id="historyResultInfo" class="small">
              <!-- 查询结果信息会在这里显示 -->
            </div>
          </div>
          <div class="card-body">
            <div id="noHistoryData" class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>请选择数据点并点击查询按钮
            </div>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>时间戳</th>
                    <th>变化描述</th>
                    <th>数值</th>
                    <th>格式化值</th>
                    <th>质量</th>
                    <th>读取耗时(ms)</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 数据创建视图 -->
    <div class="view-container" id="data-create">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">数据点创建</h2>
          <div class="btn-group">
            <button class="btn btn-outline-primary btn-icon" onclick="downloadTemplate()">
              <i class="bi bi-download"></i> 下载模板
            </button>
            <button class="btn btn-outline-success btn-icon" onclick="showBatchImportModal()">
              <i class="bi bi-upload"></i> 批量导入
            </button>
            <button class="btn btn-outline-info btn-icon" onclick="exportDataPoints()">
              <i class="bi bi-file-earmark-excel"></i> 导出Excel
            </button>
            <button class="btn btn-success btn-icon" onclick="showAddDataPointModal()">
              <i class="bi bi-plus-lg"></i> 添加数据点
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">数据点管理</h5>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">在此页面您可以创建、编辑和删除数据点。添加数据点后，系统将在轮询过程中自动读取其值。</p>
            
            <div class="table-responsive">
              <table class="table table-hover data-point-table">
                <thead class="table-light">
                  <tr>
                    <th>名称</th>
                    <th>标识符</th>
                    <th>地址/主题</th>
                    <th>功能码</th>
                    <th>模式</th>
                    <th>数据格式</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="dataPointsManageTableBody">
                  <!-- 数据点管理表格会动态添加到这里 -->
                </tbody>
              </table>
            </div>
            <div id="noDataPointsManage" class="text-center py-4 text-muted" style="display: none;">
              <i class="bi bi-database-x fs-2 mb-3 d-block"></i>
              <p>暂无数据点，请点击"添加数据点"按钮创建</p>
            </div>
            
            <div class="alert alert-info">
              <h5 class="alert-heading"><i class="bi bi-info-circle"></i> 如何创建数据点？</h5>
              <p>要创建数据点，请点击右上角的"添加数据点"按钮，并填写必要的信息：</p>
              <ul>
                <li>名称：人类可读的数据点名称</li>
                <li>标识符：唯一标识符，用于程序访问</li>
                <li>地址：Modbus寄存器地址</li>
                <li>功能码：读取或写入寄存器的功能码</li>
                <li>数据格式：数值格式，如INT16、UINT16、FLOAT32等</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- AI对话视图 -->
    <div class="view-container" id="ai-chat">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">AI助手对话</h2>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">智能助手</h5>
          </div>
          <div class="card-body">
            <div class="chat-container">
              <div class="chat-messages" id="chatMessages">
                <div class="message message-ai">
                  你好！我是Modbus监控系统的AI助手。有任何问题都可以问我。
                </div>
              </div>
              <div class="chat-input-container">
                <input type="text" class="chat-input form-control" id="chatInput" placeholder="输入您的问题...">
                <button class="btn btn-primary chat-send-btn" id="sendChatBtn">
                  <i class="bi bi-send"></i> 发送
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 计时器设置视图 -->
    <div class="view-container" id="timer-settings">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">计时器设置</h2>
          <button class="btn btn-primary" id="addTimerBtn">
            <i class="bi bi-plus-lg"></i> 添加定时任务
          </button>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">定时任务列表</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>任务名称</th>
                    <th>执行动作</th>
                    <th>执行时间</th>
                    <th>重复</th>
                    <th>状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="timerTableBody">
                  <!-- 定时任务列表将动态添加 -->
                </tbody>
              </table>
            </div>
            <div id="noTimers" class="text-center py-4 text-muted">
              <i class="bi bi-calendar-x fs-2 mb-3 d-block"></i>
              <p>暂无定时任务，请点击"添加定时任务"按钮创建</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 实时告警视图 -->
    <div class="view-container" id="real-time-alarms">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">实时告警</h2>
          <div>
            <button class="btn btn-warning me-2" id="pauseAlarmsBtn" onclick="toggleAlarmPause()">
              <i class="bi bi-pause-circle"></i> 暂停告警
            </button>
            <button class="btn btn-danger" id="stopAlarmsBtn" onclick="stopAlarmLoop()">
              <i class="bi bi-x-circle"></i> 停止告警
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">当前告警</h5>
          </div>
          <div class="card-body">
            <!-- 全新的独立告警显示区域 -->
            <div id="newAlarmsContainer" style="min-height: 100px;">
              <!-- 新的告警列表容器 -->
              <div id="newAlarmsList" style="display: block; visibility: visible;">
                <!-- 告警项将通过JavaScript动态添加 -->
            </div>
              <!-- 新的无告警提示 -->
              <div id="newNoAlarms" style="display: block; text-align: center; padding: 40px 0; color: #6c757d;">
                <i class="bi bi-emoji-smile" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                <p style="margin: 0;">当前没有告警信息</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 告警历史查询视图 -->
    <div class="view-container" id="alarm-history">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">告警历史查询</h2>
          <button class="btn btn-primary" id="refreshAlarmHistoryBtn" onclick="queryAlarmHistory()">
            <i class="bi bi-arrow-clockwise"></i> 刷新数据
          </button>
        </div>
        
        <!-- 查询条件卡片 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">查询条件</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="mb-3">
                  <label for="alarmStartTimeInput" class="form-label">开始时间</label>
                  <input type="datetime-local" class="form-control" id="alarmStartTimeInput">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label for="alarmEndTimeInput" class="form-label">结束时间</label>
                  <input type="datetime-local" class="form-control" id="alarmEndTimeInput">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label for="alarmStatusSelect" class="form-label">告警状态</label>
                  <select class="form-select" id="alarmStatusSelect">
                    <option value="">全部</option>
                    <option value="active">未解除</option>
                    <option value="cleared">已解除</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary w-100 mb-3" onclick="queryAlarmHistory()">
                  <i class="bi bi-search"></i> 查询
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 告警历史列表卡片 -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">告警历史列表</h5>
              <div>
                <span id="alarmHistoryResultInfo">共 0 条记录</span>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="alarmHistoryList">
              <!-- 历史告警将动态添加 -->
            </div>
            <div id="noAlarmHistory" class="text-center py-4 text-muted" style="display:none;">
              <i class="bi bi-search fs-2 mb-3 d-block"></i>
              <p>未找到符合条件的告警记录</p>
            </div>
            
            <!-- 分页控制 -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                显示 <span id="alarmHistoryStart">0</span> 到 <span id="alarmHistoryEnd">0</span>，共 <span id="alarmHistoryTotal">0</span> 条
              </div>
              <div>
                <button id="alarmHistoryPrevBtn" class="btn btn-sm btn-outline-secondary" onclick="prevAlarmHistoryPage()" disabled>
                  <i class="bi bi-chevron-left"></i> 上一页
                </button>
                <button id="alarmHistoryNextBtn" class="btn btn-sm btn-outline-secondary" onclick="nextAlarmHistoryPage()" disabled>
                  下一页 <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 告警设置视图 -->
    <div class="view-container" id="alarm-settings">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">告警设置</h2>
          <div>
            <button class="btn btn-success me-2" id="addMultiConditionAlarmBtn">
              <i class="bi bi-plus-circle"></i> 添加多条件告警规则
            </button>
            <button class="btn btn-info me-2" id="singlePointAlarmManageBtn">
              <i class="bi bi-bell-fill"></i> 单点报警管理
            </button>
            <button class="btn btn-warning me-2" id="debugSinglePointAlarmBtn" style="font-size: 0.8em;">
              <i class="bi bi-bug"></i> 调试
            </button>
            <button class="btn btn-primary" id="addAlarmRuleBtn">
              <i class="bi bi-plus-lg"></i> 添加告警规则
            </button>
          </div>
        </div>
        
        <!-- 多条件告警规则卡片 -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">多条件告警规则</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>规则名称</th>
                    <th>条件数量</th>
                    <th>告警分类</th>
                    <th>触发次数</th>
                    <th>告警内容</th>
                    <th>状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="multiConditionAlarmRulesTableBody">
                  <!-- 多条件告警规则将动态添加 -->
                </tbody>
              </table>
            </div>
            <div id="noMultiConditionAlarmRules" class="text-center py-4 text-muted">
              <i class="bi bi-gear-wide-connected fs-2 mb-3 d-block"></i>
              <p>暂无多条件告警规则，请点击"添加多条件告警规则"按钮创建</p>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">单点告警规则</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>数据点</th>
                    <th>告警类型</th>
                    <th>阈值</th>
                    <th>告警级别</th>
                    <th>通知方式</th>
                    <th>状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="alarmRulesTableBody">
                  <!-- 告警规则将动态添加 -->
                </tbody>
              </table>
            </div>
            <div id="noAlarmRules" class="text-center py-4 text-muted">
              <i class="bi bi-bell-slash fs-2 mb-3 d-block"></i>
              <p>暂无告警规则，请点击"添加告警规则"按钮创建</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 个人设置视图 -->
    <div class="view-container" id="user-settings">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">个人设置</h2>
          <button class="btn btn-primary" id="saveUserSettingsBtn">
            <i class="bi bi-save"></i> 保存设置
          </button>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">用户偏好设置</h5>
          </div>
          <div class="card-body">
            <form id="userSettingsForm">
              <div class="mb-3">
                <label for="userNameInput" class="form-label">用户名</label>
                <input type="text" class="form-control" id="userNameInput" placeholder="您的用户名">
              </div>
              <div class="mb-3">
                <label for="themeSelect" class="form-label">界面主题</label>
                <select class="form-select" id="themeSelect">
                  <option value="light">浅色</option>
                  <option value="dark">深色</option>
                  <option value="system">跟随系统</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="languageSelect" class="form-label">语言</label>
                <select class="form-select" id="languageSelect">
                  <option value="zh-CN">简体中文</option>
                  <option value="en-US">English (US)</option>
                </select>
              </div>
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="notificationsCheck" checked>
                <label class="form-check-label" for="notificationsCheck">启用通知</label>
              </div>
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="soundCheck" checked>
                <label class="form-check-label" for="soundCheck">启用声音提示</label>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 日报管理视图 -->
    <div class="view-container" id="daily-reports">
      <div class="container-fluid pb-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">系统日报管理</h2>
          <button class="btn btn-primary" id="generateReportBtn">
            <i class="bi bi-plus-circle"></i> 生成日报
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="form-group">
              <label for="reportStartDateInput" class="form-label">开始日期</label>
              <input type="date" class="form-control" id="reportStartDateInput">
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="form-group">
              <label for="reportEndDateInput" class="form-label">结束日期</label>
              <input type="date" class="form-control" id="reportEndDateInput">
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="form-group">
              <label for="reportTypeSelect" class="form-label">报告类型</label>
              <select class="form-select" id="reportTypeSelect">
                <option value="">全部类型</option>
                <option value="daily">日报</option>
                <option value="weekly">周报</option>
                <option value="monthly">月报</option>
              </select>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="form-group">
              <label class="form-label">&nbsp;</label>
              <button class="btn btn-primary w-100 mb-3" id="queryReportsBtn">
                <i class="bi bi-search"></i> 查询
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header position-relative">
            <div class="text-center fw-bold fs-5">日报列表</div>
            <div class="position-absolute end-0 top-50 translate-middle-y me-3">
              <span id="reportResultInfo">共 0 条记录</span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-header-center">
                  <tr>
                    <th>ID</th>
                    <th>日期</th>
                    <th>类型</th>
                    <th style="width: 25%;">内容预览</th>
                    <th>生成时间</th>
                    <th style="width: 270px;">操作</th>
                  </tr>
                </thead>
                <tbody id="reportsTableBody">
                  <!-- 这里将动态填充数据 -->
                </tbody>
              </table>
              <div id="noReports" class="text-center py-4 d-none">
                <p class="text-muted mb-0">暂无日报数据</p>
              </div>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
              显示 <span id="reportStart">0</span> 到 <span id="reportEnd">0</span>，共 <span id="reportTotal">0</span> 条
            </div>
            <div>
              <button id="reportPrevBtn" class="btn btn-sm btn-outline-secondary" disabled>
                <i class="bi bi-chevron-left"></i> 上一页
              </button>
              <button id="reportNextBtn" class="btn btn-sm btn-outline-secondary" disabled>
                下一页 <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 数据点写入模态框 -->
  <div class="modal fade" id="writeValueModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil-square"></i> 写入数据点值
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="writeDataPointId">
          <input type="hidden" id="writeDataPointIdentifier">
          
          <div class="mb-3">
            <label class="form-label">数据点名称</label>
            <input type="text" class="form-control" id="dataPointNameText" readonly>
          </div>
          
          <div class="mb-3">
            <label class="form-label">当前值</label>
            <input type="text" class="form-control" id="currentValueText" readonly>
          </div>
          
          <div class="mb-3">
            <label for="newValueInput" class="form-label">新值</label>
            <input type="text" class="form-control" id="newValueInput" placeholder="输入新值">
            <div class="form-text" id="valueFormatHelp">根据数据格式输入适当的值</div>
          </div>
          
          <!-- 添加状态显示区域 -->
          <div id="writeStatus" class="alert alert-info d-none">
            <!-- 状态消息将通过JavaScript动态添加 -->
          </div>
          
          <!-- 添加帮助信息 -->
          <div class="mb-3 mt-4">
            <h6 class="text-muted">
              <i class="bi bi-info-circle"></i> 写入提示
            </h6>
            <ul class="small text-muted">
              <li>写入值必须与数据点的格式匹配</li>
              <li>写入操作将立即发送到设备</li>
              <li>写入后，系统会自动刷新显示的值</li>
              <li>写入历史可通过顶部导航栏的"写入历史"查看</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="writeDataPointValue()">
            <i class="bi bi-check-lg"></i> 写入
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 连接设置弹窗 -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">
            <i class="bi bi-gear"></i> 连接设置
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <form id="settingsForm">
            <div class="mb-4">
              <h6 class="border-bottom pb-2 mb-3">PLC连接参数</h6>
              <div class="mb-3">
                <label for="hostInput" class="form-label">主机地址</label>
                <input type="text" class="form-control" id="hostInput" placeholder="192.168.1.100">
              </div>
              <div class="mb-3">
                <label for="portInput" class="form-label">端口</label>
                <input type="number" class="form-control" id="portInput" placeholder="502">
              </div>
              <div class="mb-3">
                <label for="unitIdInput" class="form-label">单元ID</label>
                <input type="number" class="form-control" id="unitIdInput" placeholder="1">
              </div>
              <div class="mb-3">
                <label for="timeoutInput" class="form-label">超时(毫秒)</label>
                <input type="number" class="form-control" id="timeoutInput" placeholder="5000">
              </div>
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="autoConnectCheck">
                <label class="form-check-label" for="autoConnectCheck">启动时自动连接</label>
              </div>
            </div>
            
            <div class="mb-4">
              <h6 class="border-bottom pb-2 mb-3">轮询设置</h6>
              <div class="mb-3">
                <label for="pollingIntervalInput" class="form-label">轮询间隔(毫秒)</label>
                <input type="number" class="form-control" id="pollingIntervalInput" placeholder="1000">
                <div id="minIntervalInfo" class="form-text text-warning"></div>
              </div>
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="autoPollingCheck">
                <label class="form-check-label" for="autoPollingCheck">连接后自动启动轮询</label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveSettings()">
            <i class="bi bi-save"></i> 保存设置
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加/编辑数据点弹窗 -->
  <div class="modal fade" id="dataPointModal" tabindex="-1" aria-labelledby="dataPointModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dataPointModalTitle">
            <i class="bi bi-database-add"></i> 添加数据点
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <form id="dataPointForm">
            <input type="hidden" id="dataPointId">
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle me-2"></i> <span id="currentDataSourceType">当前数据源类型: Modbus TCP</span>
            </div>
            <div class="row">
              <div class="col-md-6">
            <div class="mb-3">
              <label for="nameInput" class="form-label">名称</label>
              <input type="text" class="form-control" id="nameInput" placeholder="输入数据点名称">
            </div>
              </div>
              <div class="col-md-6">
            <div class="mb-3">
              <label for="identifierInput" class="form-label">唯一标识符 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="identifierInput" placeholder="输入唯一标识符(字母数字下划线)">
              <div class="form-text">标识符用于程序读取该数据点值，例如：temp_sensor_1</div>
            </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
            <div class="mb-3">
              <label for="accessModeSelect" class="form-label">访问模式</label>
              <select class="form-select" id="accessModeSelect" onchange="updateFunctionCodeOptions()">
                <option value="read">只读</option>
                <option value="write">只写</option>
                <option value="readwrite">读写</option>
              </select>
              <div class="form-text">读取将使用功能码3(读保持寄存器)，写入将使用功能码6(写单个寄存器)</div>
            </div>
            </div>
              <div class="col-md-6">
            <div class="mb-3">
                  <label for="addressInput" class="form-label">地址</label>
                  <input type="number" class="form-control" id="addressInput" min="0" max="65535" placeholder="输入Modbus地址（可选）">
                  <div class="form-text">Modbus寄存器地址，留空表示不指定地址</div>
            </div>
            </div>
              <!-- 隐藏的功能码输入，不再显示给用户 -->
              <input type="hidden" id="readFunctionCodeSelect" value="3">
              <input type="hidden" id="writeFunctionCodeSelect" value="6">
              <input type="hidden" id="functionCodeSelect" value="3">
            </div>
            
            <div class="row">
              <div class="col-md-4">
            <div class="mb-3">
              <label for="formatSelect" class="form-label">数据格式</label>
              <select class="form-select" id="formatSelect" onchange="handleFormatChange()">
                    <option value="BIT">BIT - 位</option>
                    <option value="POINT">POINT - 点位</option>
                    <option value="UINT16" selected>UINT16 - 无符号16位整数</option>
                <option value="INT16">INT16 - 有符号16位整数</option>
                <option value="UINT32">UINT32 - 无符号32位整数</option>
                <option value="INT32">INT32 - 有符号32位整数</option>
                <option value="FLOAT32">FLOAT32 - 32位浮点数</option>
                    <option value="FLOAT64">FLOAT64 - 64位浮点数</option>
                    <option value="STRING">STRING - 字符串</option>
              </select>
            </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3" id="bitPositionDiv" style="display: none;">
              <label for="bitPositionSelect" class="form-label">位位置</label>
              <select class="form-select" id="bitPositionSelect">
                <option value="0">位 0</option>
                <option value="1">位 1</option>
                <option value="2">位 2</option>
                <option value="3">位 3</option>
                <option value="4">位 4</option>
                <option value="5">位 5</option>
                <option value="6">位 6</option>
                <option value="7">位 7</option>
                <option value="8">位 8</option>
                <option value="9">位 9</option>
                <option value="10">位 10</option>
                <option value="11">位 11</option>
                <option value="12">位 12</option>
                <option value="13">位 13</option>
                <option value="14">位 14</option>
                <option value="15">位 15</option>
              </select>
            </div>
              </div>
              <div class="col-md-4">
            <div class="mb-3">
              <label for="scaleInput" class="form-label">缩放因子</label>
                  <input type="number" class="form-control" id="scaleInput" value="1" step="0.001">
                  <div class="form-text">原始值将乘以此因子得到显示值</div>
            </div>
              </div>
            </div>
            
            <!-- 点位数据解析设置 -->
            <div id="pointParsingDiv" style="display: none;">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i> 点位数据解析：将关联的16位数据点的值转换为二进制，并根据选择的位位置赋值给当前点位数据点
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="sourceDataPointSelect" class="form-label">关联的16位数据点</label>
                    <select class="form-select" id="sourceDataPointSelect">
                      <option value="">请选择16位数据点</option>
                    </select>
                    <div class="form-text">选择要解析的16位数据点标识符</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="pointBitPositionSelect" class="form-label">点位位置</label>
                    <select class="form-select" id="pointBitPositionSelect">
                      <option value="0">位 0</option>
                      <option value="1">位 1</option>
                      <option value="2">位 2</option>
                      <option value="3">位 3</option>
                      <option value="4">位 4</option>
                      <option value="5">位 5</option>
                      <option value="6">位 6</option>
                      <option value="7">位 7</option>
                      <option value="8">位 8</option>
                      <option value="9">位 9</option>
                      <option value="10">位 10</option>
                      <option value="11">位 11</option>
                      <option value="12">位 12</option>
                      <option value="13">位 13</option>
                      <option value="14">位 14</option>
                      <option value="15">位 15</option>
                    </select>
                    <div class="form-text">选择要提取的位位置</div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div class="mb-3">
                    <label class="form-label">实时预览</label>
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4">
                            <small class="text-muted">源数据点值:</small>
                            <div id="sourceValuePreview" class="fw-bold">--</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted">二进制表示:</small>
                            <div id="binaryPreview" class="font-monospace">----------------</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted">点位值:</small>
                            <div id="pointValuePreview" class="fw-bold text-primary">--</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Modbus设置 -->
            <div id="modbusSettings">
              <!-- Modbus设置内容，这里已经在上方表单中实现了 -->
            </div>
            
            <!-- MQTT设置 -->
            <div id="mqttSettings" style="display: none;">
              <div class="mb-3">
                <label for="mqttTopicInput" class="form-label">MQTT主题</label>
                <input type="text" class="form-control" id="mqttTopicInput" placeholder="输入MQTT主题，例如：sensors/temperature">
                <div class="form-text">指定从哪个MQTT主题获取数据</div>
              </div>
              
              <div class="mb-3">
                <label for="mqttKeyInput" class="form-label">数据键名</label>
                <input type="text" class="form-control" id="mqttKeyInput" placeholder="JSON数据中的键名，例如：temp">
                <div class="form-text">如果MQTT消息是JSON格式，指定要提取的键名，留空表示使用整个消息</div>
              </div>
              
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="mqttJSONCheck">
                <label class="form-check-label" for="mqttJSONCheck">
                  消息是JSON格式
                </label>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
            <div class="mb-3">
              <label for="unitInput" class="form-label">单位</label>
                  <input type="text" class="form-control" id="unitInput" placeholder="例如: °C, kg, m³">
            </div>
              </div>
              <div class="col-md-6">
            <div class="mb-3">
              <label for="descriptionInput" class="form-label">描述</label>
                  <input type="text" class="form-control" id="descriptionInput" placeholder="输入额外描述信息">
                </div>
              </div>
            </div>
            
            <hr class="my-3">
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="alarmEnabledCheck" onchange="toggleAlarmSettings()">
              <label class="form-check-label" for="alarmEnabledCheck">
                启用告警监控
              </label>
            </div>
            
            <div id="alarmSettingsDiv" style="display: none;">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i> 告警将在特定条件满足时触发，并可选择播放声音提示。
              </div>
              
              <div id="bitAlarmSettings" style="display: none;">
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="alarmTypeSelect" class="form-label">告警类型</label>
                      <select class="form-select" id="alarmTypeSelect" onchange="updateAlarmContent()">
                        <option value="1">类型1 - 电流异常</option>
                        <option value="2">类型2 - 热保护停机</option>
                        <option value="3">类型3 - 程序异常</option>
                        <option value="4">类型4 - 水流异常</option>
                        <option value="5">类型5 - 手动操作</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="alarmContentInput" class="form-label">告警内容</label>
                      <input type="text" class="form-control" id="alarmContentInput">
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="checkbox" id="lowLevelAlarmCheck">
                      <label class="form-check-label" for="lowLevelAlarmCheck">
                        <i class="bi bi-arrow-down-circle text-warning me-1"></i>
                        低位报警 (从1到0时触发报警，从0到1时解除报警)
                      </label>
                      <div class="form-text">
                        启用后，当数据点值从1变为0时触发报警，从0变为1时解除报警
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveDataPoint()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加日报生成模态框 -->
  <div class="modal fade" id="generateReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">生成日报</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <form id="generateReportForm">
            <div class="mb-3">
              <label for="reportDateInput" class="form-label">选择日期</label>
              <input type="date" class="form-control" id="reportDateInput" required>
              <div class="form-text">选择要生成日报的日期</div>
            </div>
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> 系统将自动汇总选定日期的数据并生成日报
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="confirmGenerateReportBtn">生成日报</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 查看报告模态框 -->
  <div class="modal fade" id="viewReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <div class="d-flex align-items-center">
            <h5 class="modal-title" id="reportTitle">日报详情</h5>
            <div class="ms-3">
              <span class="badge bg-secondary" id="reportDateBadge">2023-01-01</span>
              <span class="badge bg-primary" id="reportTypeBadge">日报</span>
              <span class="badge bg-secondary" id="reportIdBadge"></span>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="reportContent" class="report-content">
            <!-- 日报内容将动态加载 -->
          </div>
        </div>
        <div class="modal-footer">
          <div class="d-flex gap-2 w-100">
            <button type="button" class="btn btn-outline-success flex-grow-1" id="uploadToKnowledgeBtn">
              <i class="bi bi-cloud-upload"></i> 上传至知识库
            </button>
            <button type="button" class="btn btn-outline-secondary flex-grow-1" id="viewRawDataBtn">
              <i class="bi bi-code"></i> 查看原始数据
            </button>
            <button type="button" class="btn btn-outline-danger" id="deleteReportBtn" onclick="confirmDeleteReport()">
              <i class="bi bi-trash"></i> 删除
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 删除日报确认模态框 -->
  <div class="modal fade" id="deleteReportConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">确认删除</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <p>您确定要删除这份日报吗？此操作无法撤销。</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" onclick="deleteReport()">确认删除</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 多条件告警规则模态框 -->
  <div class="modal fade" id="multiConditionAlarmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-gear-wide-connected"></i> 添加多条件告警规则
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="multiConditionAlarmForm">
            <div class="mb-3">
              <label for="multiAlarmRuleName" class="form-label">规则名称 *</label>
              <input type="text" class="form-control" id="multiAlarmRuleName" placeholder="例如：调节池提升泵2号故障告警" required>
            </div>
            
            <div class="mb-3">
              <label for="multiAlarmCategory" class="form-label">告警分类 *</label>
              <select class="form-select" id="multiAlarmCategory" required>
                <option value="">请选择告警分类</option>
                <option value="1">类型1 - 电流异常</option>
                <option value="2">类型2 - 热保护停机</option>
                <option value="3">类型3 - 程序异常</option>
                <option value="4">类型4 - 水流异常</option>
                <option value="5">类型5 - 手动操作</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="multiAlarmContent" class="form-label">告警内容</label>
              <textarea class="form-control" id="multiAlarmContent" rows="2" placeholder="告警内容将根据选择的分类自动生成，也可手动修改"></textarea>
              <div class="form-text">告警内容会根据选择的分类自动生成默认模板，您也可以自定义修改</div>
            </div>
            
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <label class="form-label mb-0">告警条件设置 *</label>
                <button type="button" class="btn btn-sm btn-outline-primary" id="addConditionBtn">
                  <i class="bi bi-plus"></i> 添加条件
                </button>
              </div>
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                多条件告警规则需要<strong>所有条件同时满足</strong>才会触发告警。例如：当设备状态为"开启"且电流值为"0"时触发故障告警。
              </div>
              <div id="conditionsContainer">
                <!-- 条件将动态添加到这里 -->
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="multiAlarmLevel" class="form-label">告警级别</label>
                  <select class="form-select" id="multiAlarmLevel">
                    <option value="low">低级</option>
                    <option value="medium" selected>中级</option>
                    <option value="high">高级</option>
                    <option value="critical">紧急</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="multiAlarmConsecutiveCount" class="form-label">连续触发次数</label>
                  <select class="form-select" id="multiAlarmConsecutiveCount">
                    <option value="1">1次 (立即触发)</option>
                    <option value="2" selected>2次 (连续2次)</option>
                    <option value="3">3次 (连续3次)</option>
                    <option value="4">4次 (连续4次)</option>
                    <option value="5">5次 (连续5次)</option>
                  </select>
                  <div class="form-text">设置连续触发次数可避免信号传输延迟造成的误报警</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="multiAlarmEnabled" class="form-label">启用状态</label>
                  <select class="form-select" id="multiAlarmEnabled">
                    <option value="true" selected>启用</option>
                    <option value="false">禁用</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveMultiConditionAlarmBtn">
            <i class="bi bi-save"></i> 保存规则
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 批量导入数据点模态框 -->
  <div class="modal fade" id="batchImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-upload"></i> 批量导入数据点
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <h6 class="alert-heading"><i class="bi bi-info-circle"></i> 导入说明</h6>
            <ul class="mb-0">
              <li>支持.xlsx和.xls格式的Excel文件</li>
              <li>文件大小不能超过10MB</li>
              <li>请使用标准模板格式，可点击"下载模板"获取</li>
              <li>必填字段：数据点名称、标识符</li>
              <li>导入前会验证数据格式和重复性</li>
            </ul>
          </div>
          
          <form id="batchImportForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="excelFileInput" class="form-label">选择Excel文件</label>
              <input type="file" class="form-control" id="excelFileInput" name="excelFile" 
                     accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" required>
              <div class="form-text">请选择包含数据点配置的Excel文件</div>
            </div>
            
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="skipDuplicatesCheck">
                <label class="form-check-label" for="skipDuplicatesCheck">
                  跳过重复的标识符（不选择则覆盖现有数据点）
                </label>
              </div>
            </div>
            
            <!-- 导入进度显示 -->
            <div id="importProgress" style="display: none;">
              <div class="mb-3">
                <label class="form-label">导入进度</label>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: 0%" id="importProgressBar">0%</div>
                </div>
              </div>
              <div id="importStatus" class="text-muted">准备导入...</div>
            </div>
            
            <!-- 导入结果显示 -->
            <div id="importResults" style="display: none;">
              <div class="alert alert-success" id="importSuccessAlert" style="display: none;">
                <h6 class="alert-heading"><i class="bi bi-check-circle"></i> 导入完成</h6>
                <p class="mb-0" id="importSuccessMessage"></p>
              </div>
              
              <div class="alert alert-warning" id="importWarningAlert" style="display: none;">
                <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> 部分导入失败</h6>
                <p class="mb-0" id="importWarningMessage"></p>
              </div>
              
              <div class="alert alert-danger" id="importErrorAlert" style="display: none;">
                <h6 class="alert-heading"><i class="bi bi-x-circle"></i> 导入失败</h6>
                <p class="mb-0" id="importErrorMessage"></p>
              </div>
              
              <!-- 详细结果表格 -->
              <div id="importDetailsContainer" style="display: none;">
                <h6>导入详情</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                  <table class="table table-sm">
                    <thead class="table-light">
                      <tr>
                        <th>行号</th>
                        <th>数据点名称</th>
                        <th>标识符</th>
                        <th>状态</th>
                        <th>错误信息</th>
                      </tr>
                    </thead>
                    <tbody id="importDetailsTableBody">
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-primary" onclick="downloadTemplate()">
            <i class="bi bi-download"></i> 下载模板
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-success" id="startImportBtn">
            <i class="bi bi-upload"></i> 开始导入
          </button>
          <button type="button" class="btn btn-primary" id="closeImportModalBtn" style="display: none;" data-bs-dismiss="modal">
            <i class="bi bi-check"></i> 完成
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript库 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/js/modbus.js"></script>
  <script src="/js/modbus-fix.js"></script>
  <script src="/js/modbus-data-point-fix.js"></script>
  
  <!-- 侧边栏导航和页面切换功能 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 侧边栏导航处理
      const sidebarLinks = document.querySelectorAll('.sidebar-nav-link');
      const viewContainers = document.querySelectorAll('.view-container');
      const toggleSidebarBtn = document.querySelector('.toggle-sidebar');
      const sidebar = document.querySelector('.sidebar');
      const contentWrapper = document.querySelector('.content-wrapper');
      
      // 设置默认视图
      const defaultView = document.getElementById('data-display');
      if (defaultView) {
        defaultView.classList.add('active');
      }
      
      // 设置默认激活导航项
      const defaultNavLink = document.querySelector('.sidebar-nav-link[data-view="data-display"]');
      if (defaultNavLink) {
        defaultNavLink.classList.add('active');
      }
      
      // 在点击导航链接时切换视图
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          // 检查是否有data-view属性，如果没有则是外部链接，不需要阻止默认行为
          const targetViewId = this.getAttribute('data-view');
          if (!targetViewId) {
            return; // 允许浏览器正常导航到href指定的页面
          }
          
          e.preventDefault();
          
          // 移除所有链接的激活状态
          sidebarLinks.forEach(l => l.classList.remove('active'));
          
          // 添加当前链接的激活状态
          this.classList.add('active');
          
          // 隐藏所有视图
          viewContainers.forEach(container => {
            container.classList.remove('active');
          });
          
          // 显示目标视图
          document.getElementById(targetViewId).classList.add('active');
          
          // 在移动设备上点击导航后自动收起侧边栏
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('show');
            contentWrapper.classList.remove('sidebar-open');
            toggleSidebarBtn.classList.remove('collapsed');
          }
        });
      });
      
      // 切换侧边栏按钮
      toggleSidebarBtn.addEventListener('click', function() {
        sidebar.classList.toggle('show');
        contentWrapper.classList.toggle('sidebar-open');
        this.classList.toggle('collapsed');
        
        // 切换图标
        const icon = this.querySelector('i');
        if (icon.classList.contains('bi-chevron-left')) {
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        } else {
          icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
        }
      });
      
      // 响应式处理
      function handleResponsiveLayout() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('show');
          contentWrapper.classList.remove('sidebar-open');
          toggleSidebarBtn.classList.add('collapsed');
          toggleSidebarBtn.querySelector('i').classList.replace('bi-chevron-left', 'bi-chevron-right');
        } else {
          sidebar.classList.remove('show'); // 移除移动端的类
          contentWrapper.classList.remove('sidebar-open');
          toggleSidebarBtn.classList.remove('collapsed');
          toggleSidebarBtn.querySelector('i').classList.replace('bi-chevron-right', 'bi-chevron-left');
        }
      }
      
      // 初始化时处理布局
      handleResponsiveLayout();
      
      // 窗口大小变化时重新处理布局
      window.addEventListener('resize', handleResponsiveLayout);
      
      // AI聊天功能
      const chatInput = document.getElementById('chatInput');
      const sendChatBtn = document.getElementById('sendChatBtn');
      const chatMessages = document.getElementById('chatMessages');
      
      // 发送消息处理
      function sendChatMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // 添加用户消息到聊天区
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message message-user';
        userMessageDiv.textContent = message;
        chatMessages.appendChild(userMessageDiv);
        
        // 清空输入框
        chatInput.value = '';
        
        // 滚动到底部
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // 模拟AI响应
        setTimeout(() => {
          const aiMessageDiv = document.createElement('div');
          aiMessageDiv.className = 'message message-ai';
          aiMessageDiv.textContent = `我收到了您的消息: "${message}"。这是一个示例响应。在实际应用中，这里会调用AI服务进行回复。`;
          chatMessages.appendChild(aiMessageDiv);
          
          // 滚动到底部
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 1000);
      }
      
      // 点击发送按钮发送消息
      sendChatBtn.addEventListener('click', sendChatMessage);
      
      // 按回车键发送消息
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendChatMessage();
        }
      });
    });
  </script>

  <!-- 主要脚本 -->
  <script>
    // 全局变量
    let ws; // WebSocket连接
    let dataPoints = {}; // 存储数据点
    let alarmsEnabled = true; // 告警是否启用
    let refreshInterval; // 刷新间隔ID
    let statusCheckInterval; // 状态检查间隔ID
    let dataPointsMap = new Map(); // 数据点映射
    let dataPointConfigs = []; // 数据点配置
    let systemPreferences = {}; // 系统首选项
    
    // MQTT数据源相关
    let mqttEnabled = false; // MQTT是否启用
    let mqttDataPoints = {}; // MQTT数据点
    
    // 告警音频相关变量
    let alarmAudioInterval = null; // 告警音频循环定时器
    let currentAlarmData = null; // 当前告警数据
    let alarmAudioEnabled = true; // 告警音频是否启用
    
    // 告警倒计时相关变量
    let alarmCountdownIntervals = new Map(); // 存储每个告警的倒计时定时器
    let alarmNextPlayTimes = new Map(); // 存储每个告警的下次播放时间
    
    // 在页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM加载完成，开始初始化...');
      
      // 初始化WebSocket连接
      initWebSocket();
      
      // 手动触发一次表格行调试
      setTimeout(() => {
        console.log('执行初始表格调试...');
        const tableBody = document.getElementById('dataPointsTableBody');
        if (tableBody) {
          console.log('表格元素结构:', tableBody);
          console.log('表格行数量:', tableBody.querySelectorAll('tr').length);
          console.log('表格行内容:', Array.from(tableBody.querySelectorAll('tr')).map(tr => ({
            id: tr.id,
            html: tr.innerHTML.substring(0, 100) + '...',
            cells: tr.querySelectorAll('td').length
          })));
        }
      }, 2000);
      
      // 初始化告警容器和状态 - 只处理新的告警组件
      const newAlarmsList = document.getElementById('newAlarmsList');
      const newNoAlarms = document.getElementById('newNoAlarms');
      
      if (newAlarmsList && newNoAlarms) {
        // 确保新告警组件正确初始化
        console.log('初始化新告警组件');
        // 确保新告警列表为空时显示"无告警"提示
        if (newAlarmsList.children.length === 0) {
          newNoAlarms.style.display = 'block';
        } else {
          newNoAlarms.style.display = 'none';
          console.log('检测到现有告警，隐藏新的"无告警"提示');
        }
      } else {
        console.error('找不到新的告警组件元素');
      }
      
      // 启用告警功能
      alarmsEnabled = true;
      console.log('已启用告警功能');
      
      // 立即加载数据点配置，并等待加载完成后再初始化表格
      console.log('开始加载数据点配置...');
      loadDataPointConfigs().then((configs) => {
        console.log('数据点配置加载完成，配置数量:', configs.length);
        
        // 确保配置已存储，并设置标识符作为索引
        dataPointConfigs = configs;
        console.log('数据点配置已保存，开始初始化表格...');
        
        // 初始化表格
        initDataPointsTable();
        
        // 调试：打印表格中所有行的ID
        const tableBody = document.getElementById('dataPointsTableBody');
        if (tableBody) {
          console.log('表格行ID:', Array.from(tableBody.querySelectorAll('tr')).map(tr => tr.id));
        }
        
        // 5秒后重新检查表格状态
        setTimeout(() => {
          console.log('5秒后检查表格状态...');
          const tableBody = document.getElementById('dataPointsTableBody');
          if (tableBody) {
            console.log('表格行数量:', tableBody.querySelectorAll('tr').length);
            console.log('表格行ID:', Array.from(tableBody.querySelectorAll('tr')).map(tr => tr.id));
            console.log('表格行内容:', Array.from(tableBody.querySelectorAll('tr')).map(tr => ({
              id: tr.id,
              attributes: Array.from(tr.attributes).map(attr => `${attr.name}="${attr.value}"`).join(' '),
              cells: tr.querySelectorAll('td').length
            })));
          }
        }, 5000);
      }).catch(error => {
        console.error('初始化数据点配置失败:', error);
        
        // 即使加载失败，也初始化表格显示现有的数据点
        console.log('使用现有配置初始化表格...');
        initDataPointsTable();
      });
      
      // 加载系统首选项
      loadSystemPreferences();
      
      // 检查数据源类型
      checkDataSourceType();
      
      // 初始化事件监听器
      initEventListeners();
      
      // 初始化告警音频按钮状态
      updateAlarmAudioButtonState();
      
      // 注释掉自动刷新和状态检查
      // startRefreshTimer();
      // startStatusCheck();
    });
    
    // 初始化WebSocket连接
    function initWebSocket() {
      // 创建WebSocket连接
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      
      console.log(`连接到WebSocket: ${wsUrl}`);
      ws = new WebSocket(wsUrl);
      
      // 连接打开时
      ws.onopen = function() {
        console.log('WebSocket连接已打开');
        showToast('服务器连接成功', 'success');
      };
      
      // 接收到消息时
      ws.onmessage = function(event) {
        console.log('收到WebSocket原始消息:', event.data);
        try {
          const message = JSON.parse(event.data);
          processWebSocketMessage(message);
        } catch (error) {
          console.error('处理WebSocket消息失败:', error);
          console.error('原始消息内容:', event.data);
        }
      };
      
      // 连接关闭时
      ws.onclose = function() {
        console.log('WebSocket连接已关闭');
        showToast('服务器连接已断开，正在尝试重新连接...', 'warning');
        
        // 一秒后尝试重新连接
        setTimeout(initWebSocket, 1000);
      };
      
      // 连接出错时
      ws.onerror = function(error) {
        console.error('WebSocket错误:', error);
      };
    }
    
    // 处理WebSocket消息
    function processWebSocketMessage(message) {
      console.log('收到WebSocket消息:', message);
      
      // 添加消息去重机制
      if (message.type === 'mqtt_data' || message.type === 'data_points') {
        // 使用消息内容和时间戳创建唯一键
        const messageKey = `${message.type}_${message.topic || message.identifier}_${JSON.stringify(message.data)}`;
        console.log('WebSocket消息键:', messageKey);
        
        // 检查最近处理过的消息
        if (window.recentProcessedMessages && window.recentProcessedMessages.has(messageKey)) {
          console.log('跳过重复消息:', messageKey);
          return; // 跳过重复消息
        }
        
        // 记录此消息已处理
        if (!window.recentProcessedMessages) {
          window.recentProcessedMessages = new Map();
        }
        window.recentProcessedMessages.set(messageKey, Date.now());
        
        // 清理旧消息记录（5秒后自动清理）
        setTimeout(() => {
          if (window.recentProcessedMessages) {
            window.recentProcessedMessages.delete(messageKey);
          }
        }, 5000);
      }
      
      // 处理不同类型的消息
      switch (message.type) {
        case 'mqtt_data':
          // 处理MQTT数据
          console.log('准备处理MQTT数据:', message);
          processMQTTData(message);
          break;
        
        case 'data_points':
          // 处理MQTT数据点
          console.log('准备处理MQTT数据点:', message);
          processMQTTDataPoints(message);
          break;
          
        case 'modbus_status':
          // 处理Modbus状态 - 静默处理，不显示告警
          // updateModbusStatus(message.data);
          break;
          
        case 'modbus_data':
          // 处理Modbus数据 - 将其重定向到处理MQTT数据点的函数
          console.log('准备处理Modbus数据:', message);
          if (message.data) {
            processMQTTDataPoints({
              identifier: message.identifier,
              data: message.data
            });
          } else if (message.value !== undefined) {
            // 单个数据点值
            const data = {};
            data[message.identifier] = message.value;
            processMQTTDataPoints({
              identifier: 'modbus',
              data: data
            });
          }
          break;
          
        case 'alarm':
          // 处理告警消息
          console.log('准备处理告警消息:', message.data);
          processAlarmMessage(message.data);
          break;
          
        case 'alarmCleared':
          // 处理告警解除消息
          console.log('准备处理告警解除消息:', message.data);
          processAlarmClearedMessage(message.data);
          break;
          
        case 'single_point_alarm':
          // 处理单点报警消息
          console.log('准备处理单点报警消息:', message.data);
          processAlarmMessage(message.data);
          break;
          
        case 'single_point_alarm_cleared':
          // 处理单点报警解除消息
          console.log('准备处理单点报警解除消息:', message.data);
          processAlarmClearedMessage(message.data);
          break;
          
        case 'multi_condition_alarm':
          // 处理多条件告警消息
          console.log('准备处理多条件告警消息:', message.data);
          processMultiConditionAlarmMessage(message.data);
          break;
          
        case 'multi_condition_alarm_cleared':
          // 处理多条件告警解除消息
          console.log('准备处理多条件告警解除消息:', message.data);
          processMultiConditionAlarmClearedMessage(message.data);
          break;
        
        // 其他消息类型处理...
        default:
          console.log('收到未知类型消息:', message.type);
      }
    }
    
    // 处理MQTT数据
    function processMQTTData(message) {
      console.log('处理MQTT消息:', message.topic);
      console.log('MQTT消息数据:', message.data);
      console.log('当前数据点配置数量:', dataPointConfigs.length);
      console.log('当前数据点配置:', dataPointConfigs);
      
      // 如果还没有加载数据点配置，先加载
      if (!dataPointConfigs || dataPointConfigs.length === 0) {
        console.log('没有数据点配置，开始加载...');
        loadDataPointConfigs().then(() => {
          // 加载完成后继续处理消息
          console.log('数据点配置加载完成，继续处理MQTT消息');
          processMQTTDataInternal(message);
        }).catch(error => {
          console.error('加载数据点配置失败，无法处理MQTT消息:', error);
        });
      } else {
        // 直接处理消息
        processMQTTDataInternal(message);
      }
    }
    
    // 内部MQTT数据处理函数
    function processMQTTDataInternal(message) {
      console.log('开始内部MQTT数据处理');
      
      // 如果是JSON数据，尝试提取键值对
      if (typeof message.data === 'object') {
        console.log('处理JSON格式MQTT数据');
        // 遍历所有键值对
        for (const [key, value] of Object.entries(message.data)) {
          console.log(`处理数据点键值对: ${key} = ${value}`);
          
          // 检查是否存在匹配的数据点
          const matchedConfig = dataPointConfigs.find(c => c.identifier === key);
          console.log('是否找到匹配的数据点配置:', matchedConfig ? '是' : '否');
          
          if (matchedConfig) {
            // 找到匹配的数据点，更新数据
            console.log(`更新匹配的数据点: ${key} = ${value}, 配置:`, matchedConfig);
            
            // 更新数据点映射
            dataPointsMap.set(key, {
              config: matchedConfig,
              value: value,
              timestamp: new Date().toISOString(),
              source: 'mqtt'
            });
            console.log(`数据点已添加到映射, 当前映射大小: ${dataPointsMap.size}`);
            
            // 只更新UI，不重建表格
            console.log(`准备更新UI: ${key}`);
            updateDataPointUI(key);
            
            // 只更新表格中的值，不改变表格结构
            console.log(`准备更新表格: ${key}`);
            updateDataPointInTable(key, value);
          } else {
            // 未找到匹配的数据点，在后台打印
            console.warn(`未找到匹配的数据点: ${key} = ${value}`);
            console.log('可用的数据点标识符:', dataPointConfigs.map(c => c.identifier));
          }
        }
      } else {
        console.log('处理非JSON格式MQTT数据');
        // 如果是简单数据，尝试使用主题作为标识符
        const topicParts = message.topic.split('/');
        const identifier = topicParts[topicParts.length - 1];
        console.log(`从主题提取的标识符: ${identifier}`);
        
        // 检查是否存在匹配的数据点
        const matchedConfig = dataPointConfigs.find(c => c.identifier === identifier);
        console.log('是否找到匹配的数据点配置:', matchedConfig ? '是' : '否');
        
        if (matchedConfig) {
          console.log(`更新匹配的数据点(使用主题作为标识符): ${identifier} = ${message.data}`);
          
          // 更新数据点映射
          dataPointsMap.set(identifier, {
            config: matchedConfig,
            value: message.data,
            timestamp: new Date().toISOString(),
            source: 'mqtt'
          });
          console.log(`数据点已添加到映射, 当前映射大小: ${dataPointsMap.size}`);
          
          // 只更新UI，不重建表格
          console.log(`准备更新UI: ${identifier}`);
          updateDataPointUI(identifier);
          
          // 只更新表格中的值，不改变表格结构
          console.log(`准备更新表格: ${identifier}`);
          updateDataPointInTable(identifier, message.data);
        } else {
          console.warn(`未找到匹配的数据点(使用主题作为标识符): ${identifier} = ${message.data}`);
          console.log('可用的数据点标识符:', dataPointConfigs.map(c => c.identifier));
        }
      }
    }
    
    // 处理MQTT数据点
    function processMQTTDataPoints(message) {
      console.log('处理MQTT数据点:', message.identifier);
      console.log('MQTT数据点数据:', message.data);
      
      // 调试：显示当前数据点配置状态
      console.log('当前数据点配置数量:', dataPointConfigs ? dataPointConfigs.length : '未定义');
      if (dataPointConfigs && dataPointConfigs.length > 0) {
        console.log('前5个数据点配置:', dataPointConfigs.slice(0, 5).map(dp => ({
          identifier: dp.identifier,
          name: dp.name,
          format: dp.format
        })));
        console.log('所有数据点标识符:', dataPointConfigs.map(dp => dp.identifier));
      } else {
        console.warn('数据点配置为空或未加载，尝试重新加载...');
        // 尝试重新加载数据点配置
        loadDataPointConfigs().then(configs => {
          console.log('重新加载的数据点配置数量:', configs ? configs.length : 0);
          if (configs && configs.length > 0) {
            dataPointConfigs = configs;
            console.log('数据点配置已重新加载，重新处理消息');
            // 重新处理消息
            processMQTTDataPointsInternal(message);
          }
        }).catch(error => {
          console.error('重新加载数据点配置失败:', error);
        });
        return;
      }
      
      processMQTTDataPointsInternal(message);
    }
    
    // 内部处理MQTT数据点的函数
    function processMQTTDataPointsInternal(message) {
      // 初始化无效数据点缓存（减少重复日志输出）
      if (!window.invalidDataPointsCache) {
        window.invalidDataPointsCache = new Set();
      }
      
      // 收集所有更新的数据点值，用于告警检查
      const updatedValues = {};
      
      // 遍历所有数据点
      for (const [key, value] of Object.entries(message.data)) {
        // 尝试两种可能的标识符格式
        const fullIdentifier = `${message.identifier}.${key}`;
        const simpleIdentifier = key;
        
        console.log(`处理数据点: 键=${key}, 值=${value}`);
        console.log(`尝试的标识符: 完整=${fullIdentifier}, 简单=${simpleIdentifier}`);
        
        // 查找匹配的数据点配置
        let matchedConfig = dataPointConfigs.find(c => c.identifier === fullIdentifier);
        
        if (!matchedConfig) {
          // 尝试使用简单标识符
          matchedConfig = dataPointConfigs.find(c => c.identifier === simpleIdentifier);
        }
        
        console.log('是否找到匹配的数据点配置:', matchedConfig ? '是' : '否');
        if (matchedConfig) {
          console.log('匹配的配置:', matchedConfig);
        }
        
        if (matchedConfig) {
          // 找到匹配的数据点
          const identifier = matchedConfig.identifier;
          console.log(`更新匹配的数据点: ${identifier} = ${value}`);
          
          // 更新数据点映射
          dataPointsMap.set(identifier, {
            config: matchedConfig,
            value: value,
            timestamp: new Date().toISOString(),
            source: 'mqtt'
          });
          console.log(`数据点已添加到映射, 当前映射大小: ${dataPointsMap.size}`);
          
          // 收集数据用于告警检查
          updatedValues[matchedConfig.name] = {
            value: value,
            formatted: value.toString(),
            timestamp: new Date().toISOString(),
            quality: 'GOOD'
          };
          
          // 只更新UI，不重建表格
          console.log(`准备更新UI: ${identifier}`);
          updateDataPointUI(identifier);
          
          // 只更新表格中的值，不改变表格结构
          console.log(`准备更新表格: ${identifier}`);
          updateDataPointInTable(identifier, value);
        } else {
          // 检查是否已经记录过这个无效数据点
          const cacheKey = `${fullIdentifier}_${simpleIdentifier}`;
          if (!window.invalidDataPointsCache.has(cacheKey)) {
            // 第一次遇到这个无效数据点，记录日志
            console.warn(`未找到匹配的数据点: ${fullIdentifier} 或 ${simpleIdentifier} = ${value}`);
            console.log('可用的数据点标识符:', dataPointConfigs.map(c => c.identifier));
            
            // 添加到缓存，避免重复日志
            window.invalidDataPointsCache.add(cacheKey);
            
            // 限制缓存大小，避免内存泄漏
            if (window.invalidDataPointsCache.size > 100) {
              // 清空一半的缓存
              const cacheArray = Array.from(window.invalidDataPointsCache);
              window.invalidDataPointsCache = new Set(cacheArray.slice(-50));
            }
          }
          // 如果已经缓存过，就不再输出日志
        }
      }
      
      // 处理POINT格式数据点的实时解析
      console.log('开始处理POINT格式数据点的实时解析...');
      processPointDataPointsFromMQTT(message.data);
      
      // 检查告警状态 - 包括MQTT数据和POINT解析后的数据
      console.log('[告警调试] MQTT数据处理完成，开始检查告警状态');
      if (Object.keys(updatedValues).length > 0) {
        // 合并当前数据值和新更新的值
        const allValues = { ...window.currentDataValues, ...updatedValues };
        
        // 调用告警检查函数
        if (typeof checkAlarmStatus === 'function') {
          checkAlarmStatus(allValues);
        } else {
          console.warn('[告警调试] checkAlarmStatus函数不可用');
        }
      }
    }
    
    // 更新数据点表格中的数据点
    function updateDataPointInTable(identifier, value) {
      console.log(`开始更新表格中的数据点: ${identifier} = ${value}`);
      
      const tableBody = document.getElementById('dataPointsTableBody');
      if (!tableBody) {
        console.error('找不到表格体元素 dataPointsTableBody');
        return;
      }

      // 直接查找值和时间单元格，不依赖行ID
      const valueCell = document.getElementById(`table-value-${identifier}`);
      const timeCell = document.getElementById(`table-time-${identifier}`);
      
      console.log(`查找单元格: valueCell=${valueCell ? '找到' : '未找到'}, timeCell=${timeCell ? '找到' : '未找到'}`);
      
      // 如果找不到单元格，尝试使用更可靠的选择器
      let valueCellAlternative = null;
      let timeCellAlternative = null;
      
      if (!valueCell || !timeCell) {
        // 通过标识符属性查找行
        const row = tableBody.querySelector(`tr[data-identifier="${identifier}"]`);
        console.log(`尝试通过data-identifier查找行: ${row ? '找到' : '未找到'}`);
        
        if (row) {
          // 找到行后，获取第3个和第4个单元格（值和时间）
          const cells = row.querySelectorAll('td');
          if (cells.length >= 4) {
            valueCellAlternative = cells[2]; // 第3个单元格是值
            timeCellAlternative = cells[3];  // 第4个单元格是时间
            console.log('通过行和单元格索引找到值和时间单元格');
          }
        } else {
          // 如果还是找不到，直接获取所有行，检查标识符单元格
          const allRows = tableBody.querySelectorAll('tr');
          console.log(`表格中有 ${allRows.length} 行，尝试匹配标识符`);
          
          for (const r of allRows) {
            const cells = r.querySelectorAll('td');
            if (cells.length >= 4) {
              // 检查第2个单元格是否包含标识符
              if (cells[1].textContent.trim() === identifier) {
                valueCellAlternative = cells[2]; // 第3个单元格是值
                timeCellAlternative = cells[3];  // 第4个单元格是时间
                console.log(`找到标识符为 ${identifier} 的行，通过单元格索引获取值和时间单元格`);
                break;
              }
            }
          }
        }
      }
      
      // 使用找到的单元格更新内容
      const finalValueCell = valueCell || valueCellAlternative;
      const finalTimeCell = timeCell || timeCellAlternative;
      
      if (finalValueCell) {
        finalValueCell.textContent = formatValue(value);
        console.log(`已更新值单元格: ${formatValue(value)}`);
      } else {
        console.error(`无法找到值单元格: ${identifier}`);
      }
      
      if (finalTimeCell) {
        finalTimeCell.textContent = formatTimestamp(new Date().toISOString());
        console.log(`已更新时间单元格: ${formatTimestamp(new Date().toISOString())}`);
      } else {
        console.error(`无法找到时间单元格: ${identifier}`);
      }
    }
    
    // 检查数据源类型
    function checkDataSourceType() {
      fetch('/api/mqtt/settings')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.settings) {
            mqttEnabled = data.settings.dataSourceType === 'mqtt';
            console.log(`MQTT数据源${mqttEnabled ? '启用' : '禁用'}`);
            
            // 更新UI
            updateDataSourceUI();
            
            // 如果启用了MQTT，确保加载数据点配置
            if (mqttEnabled) {
              loadDataPointConfigs();
            }
          }
        })
        .catch(error => {
          console.error('获取MQTT设置失败:', error);
        });
    }
    
    // 更新数据源UI
    function updateDataSourceUI() {
      const dataSourceBadge = document.getElementById('dataSourceBadge');
      if (dataSourceBadge) {
        dataSourceBadge.textContent = mqttEnabled ? 'MQTT' : 'ModbusTCP';
        dataSourceBadge.className = `badge rounded-pill ${mqttEnabled ? 'bg-info' : 'bg-primary'} text-white`;
      }
    }
    
    // 更新数据点UI
    function updateDataPointUI(identifier) {
      console.log(`开始更新数据点UI: ${identifier}`);
      
      // 获取数据点信息
      const dataPoint = dataPointsMap.get(identifier);
      if (!dataPoint) {
        console.error(`数据点不存在于映射中: ${identifier}`);
        return;
      }
      
      console.log(`数据点信息:`, dataPoint);
      
      // 获取数据点元素
      let dpElement = document.getElementById(`dp-${identifier}`);
      
      // 如果元素不存在，创建新元素
      if (!dpElement) {
        console.log(`元素不存在: dp-${identifier}`);
        
        // 检查数据点区域是否存在
        let dataPointsContainer = document.getElementById('dataPointsContainer');
        if (!dataPointsContainer) {
          console.error('找不到数据点容器: dataPointsContainer');
          console.log('当前页面中的数据点相关元素:', Array.from(document.querySelectorAll('[id^="dp-"]')).map(el => el.id));
          return;
        }
        
        // 创建新的数据点卡片
        const card = document.createElement('div');
        card.className = 'col-md-3 mb-3';
        card.id = `dp-card-${identifier}`;
        console.log(`创建新卡片: dp-card-${identifier}`);
        
        // 设置卡片内容
        card.innerHTML = `
          <div class="card h-100 ${dataPoint.source === 'mqtt' ? 'border-info' : ''}">
            <div class="card-body">
              <h5 class="card-title">
                ${dataPoint.config.name}
                ${dataPoint.source === 'mqtt' ? '<span class="badge bg-info">MQTT</span>' : ''}
              </h5>
              <h2 class="card-text" id="dp-${identifier}">
                ${formatValue(dataPoint.value, dataPoint.config)} ${dataPoint.config.unit || ''}
              </h2>
              <p class="text-muted small">
                ${dataPoint.source === 'mqtt' ? `主题: ${dataPoint.config.address}` : `地址: ${dataPoint.config.address}`}
              </p>
              <p class="timestamp">
                更新时间: <span id="dp-time-${identifier}">${formatTimestamp(dataPoint.timestamp)}</span>
              </p>
            </div>
          </div>
        `;
        
        // 添加到容器
        dataPointsContainer.appendChild(card);
        console.log(`卡片已添加到容器`);
      } else {
        // 更新现有元素
        console.log(`更新现有元素: dp-${identifier}`);
        dpElement.innerHTML = `${formatValue(dataPoint.value, dataPoint.config)} ${dataPoint.config.unit || ''}`;
        
        // 更新时间戳
        const timeElement = document.getElementById(`dp-time-${identifier}`);
        if (timeElement) {
          timeElement.textContent = formatTimestamp(dataPoint.timestamp);
          console.log(`时间戳已更新: ${formatTimestamp(dataPoint.timestamp)}`);
        } else {
          console.error(`找不到时间戳元素: dp-time-${identifier}`);
        }
      }
    }
    
    // 格式化数值
    function formatValue(value, dataPointConfig = null) {
      // 如果提供了数据点配置，根据格式特殊处理
      if (dataPointConfig) {
        if (dataPointConfig.format === 'BIT' || dataPointConfig.format === 'POINT') {
          // 对于位值和点位值，使用徽章样式
          const bitValue = value === 1 || value === true;
          return `<span class="badge ${bitValue ? 'bg-success' : 'bg-secondary'}">${bitValue ? '1' : '0'}</span>`;
        }
      }
      
      if (typeof value === 'number') {
        // 如果是数字，保留2位小数
        return Number.isInteger(value) ? value : value.toFixed(2);
      } else if (typeof value === 'boolean') {
        // 如果是布尔值，转换为是/否
        return value ? '是' : '否';
      } else {
        // 其他类型直接返回
        return value;
      }
    }
    
    // 格式化时间戳
    function formatTimestamp(timestamp) {
      try {
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN');
      } catch (error) {
        return timestamp;
      }
    }
    
    // 加载数据点配置
    function loadDataPointConfigs() {
      return new Promise((resolve, reject) => {
        console.log('开始加载数据点配置...');
        
        fetch('/api/modbus/data-points')
          .then(response => {
            // 检查HTTP响应状态
            if (!response.ok) {
              console.error(`加载数据点配置失败，HTTP错误: ${response.status}`);
              return response.text().then(text => {
                try {
                  // 尝试解析为JSON
                  return JSON.parse(text);
                } catch (e) {
                  // 如果不是JSON，抛出错误
                  throw new Error(`服务器返回: ${text}`);
                }
              });
            }
            return response.json();
          })
          .then(data => {
            console.log('收到数据点配置响应:', data);
            
            if (data.success && data.dataPoints) {
              // 保存已有配置，不添加默认值
              dataPointConfigs = data.dataPoints || [];
              console.log(`已加载${dataPointConfigs.length}个数据点配置`);
              
              // 打印详细的配置信息，包括标识符
              if (dataPointConfigs.length > 0) {
                console.log('加载的数据点标识符:', dataPointConfigs.map(c => c.identifier));
                console.log('加载的第一个数据点详情:', dataPointConfigs[0]);
              }
              
              resolve(dataPointConfigs);
            } else if (Array.isArray(data)) {
              // 兼容直接返回数组的格式
              dataPointConfigs = data;
              console.log(`已加载${dataPointConfigs.length}个数据点配置(数组格式)`);
              
              // 打印详细的配置信息，包括标识符
              if (dataPointConfigs.length > 0) {
                console.log('加载的数据点标识符:', dataPointConfigs.map(c => c.identifier));
                console.log('加载的第一个数据点详情:', dataPointConfigs[0]);
              }
              
              resolve(dataPointConfigs);
            } else {
              console.error('加载数据点配置失败:', data.error || '未知错误');
              // 即使失败，也保留现有的数据点配置
              reject(new Error(data.error || '未知错误'));
            }
          })
          .catch(error => {
            console.error('加载数据点配置失败:', error);
            // 保留现有的数据点配置，不添加默认值
            reject(error);
          });
      });
    }
    
    // 加载系统首选项
    function loadSystemPreferences() {
      fetch('/api/modbus/preferences')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            systemPreferences = data.preferences || {};
            console.log('已加载系统首选项');
          }
        })
        .catch(error => {
          console.error('加载系统首选项失败:', error);
        });
    }
    
    // 显示提示消息
    function showToast(message, type = 'info') {
      // 检查是否已有toast容器
      let toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        // 创建toast容器
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
      }
      
      // 创建toast元素
      const toastId = `toast-${Date.now()}`;
      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      // 设置toast内容
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭"></button>
        </div>
      `;
      
      // 添加到容器
      toastContainer.appendChild(toast);
      
      // 显示toast
      const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
      bsToast.show();
      
      // 删除已显示的toast
      toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
      });
    }
    
    // 初始化事件监听器
    function initEventListeners() {
      // 获取连接按钮
      const connectBtn = document.getElementById('connectBtn');
      if (connectBtn) {
        // 添加点击事件
        connectBtn.addEventListener('click', toggleConnection);
      }
      
      // 获取刷新按钮
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        // 添加点击事件
        refreshBtn.addEventListener('click', refreshData);
      }
      
      // 获取添加数据点按钮
      const addDataPointBtn = document.getElementById('addDataPointBtn');
      if (addDataPointBtn) {
        // 添加点击事件
        addDataPointBtn.addEventListener('click', showAddDataPointModal);
      }
    }
    
    // 切换连接状态
    function toggleConnection() {
      // 检查连接状态
      const connectionStatus = document.getElementById('connectionStatus');
      const connectBtn = document.getElementById('connectBtn');
      
      if (!connectionStatus || !connectBtn) return;
      
      // 当前是否已连接
      const isConnected = connectionStatus.classList.contains('status-connected');
      
      if (isConnected) {
        // 断开连接
        disconnectModbus();
      } else {
        // 连接
        connectModbus();
      }
    }
    
    // 连接Modbus
    function connectModbus() {
      // 发送连接请求
      fetch('/api/modbus/connect', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('连接成功', 'success');
            updateConnectionStatus(true);
          } else {
            showToast(`连接失败: ${data.error}`, 'danger');
          }
        })
        .catch(error => {
          console.error('连接请求失败:', error);
          showToast('连接请求失败', 'danger');
        });
    }
    
    // 断开Modbus连接
    function disconnectModbus() {
      // 发送断开连接请求
      fetch('/api/modbus/disconnect', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('已断开连接', 'info');
            updateConnectionStatus(false);
          } else {
            showToast(`断开连接失败: ${data.error}`, 'danger');
          }
        })
        .catch(error => {
          console.error('断开连接请求失败:', error);
          showToast('断开连接请求失败', 'danger');
        });
    }
    
    // 更新连接状态UI
    function updateConnectionStatus(isConnected) {
      // 如果已禁用告警，则静默处理
      if (!alarmsEnabled) {
        return;
      }
      
      // 获取连接状态元素
      const connectionStatus = document.getElementById('connectionStatus');
      const connectBtn = document.getElementById('connectBtn');
      
      if (!connectionStatus || !connectBtn) return;
      
      // 更新连接状态
      if (isConnected) {
        connectionStatus.textContent = '已连接';
        connectionStatus.className = 'connection-status status-connected';
        connectBtn.innerHTML = '<i class="bi bi-plug-fill"></i> 断开连接';
        connectBtn.classList.remove('btn-outline-primary');
        connectBtn.classList.add('btn-outline-danger');
      } else {
        connectionStatus.textContent = '未连接';
        connectionStatus.className = 'connection-status status-disconnected';
        connectBtn.innerHTML = '<i class="bi bi-plug"></i> 连接';
        connectBtn.classList.remove('btn-outline-danger');
        connectBtn.classList.add('btn-outline-primary');
      }
    }
    
    // 刷新数据
    function refreshData() {
      // 发送刷新请求
      fetch('/api/modbus/refresh', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('数据已刷新', 'success');
          } else {
            showToast(`刷新失败: ${data.error}`, 'danger');
          }
        })
        .catch(error => {
          console.error('刷新请求失败:', error);
          showToast('刷新请求失败', 'danger');
        });
    }
    
    // 开始定时刷新 - 已禁用，只保留函数定义
    function startRefreshTimer() {
      console.log('自动刷新已禁用');
      // 检查是否已有定时器
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }
    
    // 开始状态检查 - 已禁用，只保留函数定义
    function startStatusCheck() {
      console.log('自动状态检查已禁用');
      // 检查是否已有定时器
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
      }
    }
    
    // 检查Modbus状态 - 修改为只在用户手动操作时调用
    function checkModbusStatus() {
      // 不自动检查状态，避免404错误
      console.log('手动检查Modbus状态');
    }

    // 显示数据点配置
    function showDataPointConfigs() {
      console.log('当前加载的数据点配置:', dataPointConfigs);
      
      // 创建可读的数据点信息文本
      let configText = '当前加载的数据点配置：\n\n';
      
      if (dataPointConfigs.length === 0) {
        configText += '没有数据点配置';
      } else {
        dataPointConfigs.forEach((config, index) => {
          configText += `${index + 1}. ${config.name || '无名称'}\n`;
          configText += `   标识符: ${config.identifier}\n`;
          configText += `   地址: ${config.address || '无地址'}\n`;
          configText += `   类型: ${config.type || '未知'}\n`;
          configText += `   单位: ${config.unit || '无单位'}\n\n`;
        });
      }
      
      // 显示弹窗
      alert(configText);
    }
    
    // 刷新数据点
    function refreshDataPoints() {
      // 显示加载指示器
      const loaderContainer = document.getElementById('loaderContainer');
      if (loaderContainer) loaderContainer.style.display = 'flex';
      
      // 加载数据点配置
      loadDataPointConfigs();
      
      // 刷新数据
      refreshData();
      
      // 3秒后隐藏加载指示器
      setTimeout(() => {
        if (loaderContainer) loaderContainer.style.display = 'none';
      }, 1000);
    }

    // 测试MQTT数据点功能
    function testMQTTDataPoint() {
      // 弹出输入框
      const identifier = prompt('请输入数据点标识符', 'XHY2GZ2');
      if (identifier === null) return; // 用户取消
      
      const value = prompt('请输入数据点值', '22');
      if (value === null) return; // 用户取消
      
      // 显示加载指示器
      const loaderContainer = document.getElementById('loaderContainer');
      if (loaderContainer) loaderContainer.style.display = 'flex';
      
      console.log(`开始测试MQTT数据点: ${identifier} = ${value}`);
      
      // 先确保数据点配置已加载
      loadDataPointConfigs().then(() => {
        console.log(`数据点配置加载完成，共${dataPointConfigs.length}个配置`);
        
        // 检查是否有匹配的数据点配置，没有则在控制台警告但继续执行
        let matchedConfig = dataPointConfigs.find(c => c.identifier === identifier);
        if (!matchedConfig) {
          console.warn(`警告：未找到标识符为 ${identifier} 的数据点配置，测试数据可能不会显示在表格中`);
          // 不再自动添加临时配置
        } else {
          console.log(`找到匹配的数据点配置: ${matchedConfig.name || matchedConfig.identifier}`);
        }
        
        // 发送测试请求
        console.log('发送MQTT测试数据点请求...');
        return fetch('/api/mqtt/test-datapoint', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            identifier: identifier, 
            value: typeof value === 'number' || !isNaN(Number(value)) ? Number(value) : value 
          })
        });
      })
      .then(response => {
        // 检查HTTP响应状态
        if (!response.ok) {
          console.error(`HTTP错误: ${response.status} ${response.statusText}`);
          return response.text().then(text => {
            try {
              // 尝试解析为JSON
              return JSON.parse(text);
            } catch (e) {
              // 如果不是JSON，返回一个包含文本的错误对象
              throw new Error(`服务器返回: ${text}`);
            }
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('MQTT测试响应:', data);
        if (data.success) {
          showToast(`测试数据已发送: ${identifier} = ${value}`, 'success');
          
          // 只有在已存在匹配的配置时才更新UI
          const matchedConfig = dataPointConfigs.find(c => c.identifier === identifier);
          if (matchedConfig) {
            // 更新数据点映射
            dataPointsMap.set(identifier, {
              config: matchedConfig,
              value: value,
              timestamp: new Date().toISOString(),
              source: 'mqtt'
            });
            
            // 只更新UI，不重建表格
            updateDataPointUI(identifier);
            
            // 只更新表格中的值，不改变表格结构
            updateDataPointInTable(identifier, value);
          } else {
            console.log(`测试数据已发送，但未在表格中更新（没有匹配的数据点配置）`);
          }
        } else {
          throw new Error(data.error || '测试失败，未知错误');
        }
      })
      .catch(error => {
        console.error('测试MQTT数据点失败:', error);
        showToast(`测试失败: ${error.message || '未知错误'}`, 'danger');
      })
      .finally(() => {
        // 隐藏加载指示器
        if (loaderContainer) loaderContainer.style.display = 'none';
      });
    }

    // 初始化数据点表格
    function initDataPointsTable() {
      console.log('初始化数据点表格');
      const tableBody = document.getElementById('dataPointsTableBody');
      if (!tableBody) {
        console.error('找不到表格体元素 dataPointsTableBody');
        return;
      }
      
      // 清空表格
      tableBody.innerHTML = '';
      console.log('表格已清空');
      
      // 如果没有数据点配置，显示提示
      if (!dataPointConfigs || dataPointConfigs.length === 0) {
        console.log('没有数据点配置，显示提示');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="5" class="text-center">没有数据点配置，请添加数据点</td>
        `;
        tableBody.appendChild(row);
      } else {
        console.log(`有 ${dataPointConfigs.length} 个数据点配置，创建表格行`);
        // 遍历数据点配置，创建表格行
        dataPointConfigs.forEach(config => {
          const identifier = config.identifier;
          console.log(`创建行: ${identifier}`);
          
          // 使用DOM API创建行和单元格，确保ID正确设置
          const row = document.createElement('tr');
          // 明确设置行ID
          row.id = `table-row-${identifier}`;
          row.setAttribute('data-identifier', identifier);
          
          // 名称单元格
          const nameCell = document.createElement('td');
          nameCell.textContent = config.name || identifier;
          
          // 标识符单元格
          const idCell = document.createElement('td');
          idCell.textContent = identifier;
          
          // 值单元格
          const valueCell = document.createElement('td');
          valueCell.id = `table-value-${identifier}`;
          valueCell.textContent = '无数据';
          
          // 时间单元格
          const timeCell = document.createElement('td');
          timeCell.id = `table-time-${identifier}`;
          timeCell.textContent = '-';
          
          // 操作单元格
          const actionCell = document.createElement('td');
          actionCell.className = 'text-end';
          
          // 添加所有单元格到行
          row.appendChild(nameCell);
          row.appendChild(idCell);
          row.appendChild(valueCell);
          row.appendChild(timeCell);
          row.appendChild(actionCell);
          
          // 添加到表格
          tableBody.appendChild(row);
          console.log(`行已添加: ${row.id}，行元素:`, row);
        });
      }
      
      // 验证行ID是否正确设置
      const rows = tableBody.querySelectorAll('tr');
      console.log('验证表格行ID:', Array.from(rows).map(tr => tr.id));
      console.log('表格初始化完成');
    }

    // 确保有默认数据点配置 - 移除此函数的使用
    function ensureDefaultDataPoints() {
      // 不再自动添加默认数据点
      console.log('保留现有数据点配置，不添加默认数据点');
    }
    
    // 手动添加数据点配置
    function addManualDataPoint(identifier, name) {
      // 检查是否已存在
      const existingConfig = dataPointConfigs.find(c => c.identifier === identifier);
      if (existingConfig) {
        console.log(`数据点 ${identifier} 已存在，无需添加`);
        return existingConfig;
      }
      
      // 创建新的数据点配置
      const newConfig = {
        id: `manual_${Date.now()}`,
        name: name || identifier,
        identifier: identifier,
        unit: '',
        type: 'string',
        address: 'data/modbus',
        source: 'mqtt'
      };
      
      // 添加到配置列表
      dataPointConfigs.push(newConfig);
      console.log(`手动添加了数据点配置: ${identifier}`);
      
      // 更新表格
      initDataPointsTable();
      
      return newConfig;
    }

    // 调试表格函数
    function debugDataPointsTable() {
      console.log('======= 表格调试信息 =======');
      
      // 检查数据点配置
      console.log('数据点配置数量:', dataPointConfigs.length);
      console.log('数据点配置:', dataPointConfigs);
      
      // 检查表格结构
      const tableBody = document.getElementById('dataPointsTableBody');
      if (tableBody) {
        const rows = tableBody.querySelectorAll('tr');
        console.log('表格行数量:', rows.length);
        console.log('表格行ID:', Array.from(rows).map(tr => tr.id));
        
        // 检查单元格
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          console.log(`行ID: ${row.id}, 单元格数量: ${cells.length}`);
          if (cells.length > 0) {
            console.log('单元格内容:', Array.from(cells).map(td => td.textContent.trim()));
          }
        });
      } else {
        console.error('找不到表格体元素 dataPointsTableBody');
      }
      
      // 检查数据点映射
      console.log('数据点映射大小:', dataPointsMap.size);
      console.log('数据点映射内容:', Array.from(dataPointsMap.entries()));
      
      // 显示结果弹窗
      alert(`调试信息已输出到控制台\n\n数据点配置数量: ${dataPointConfigs.length}\n表格行数量: ${tableBody ? tableBody.querySelectorAll('tr').length : '未找到表格'}\n数据点映射大小: ${dataPointsMap.size}`);
    }

    // 从数据库加载最新数据点值
    function loadLatestFromDB() {
      // 显示加载指示器
      const loaderContainer = document.getElementById('loaderContainer');
      if (loaderContainer) loaderContainer.style.display = 'flex';
      
      console.log('从数据库加载最新数据点值...');
      
      // 请求最新值
      fetch('/api/modbus/db-latest-values')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            console.log(`成功从数据库加载 ${data.meta.count} 个数据点值`);
            console.log('数据库数据:', data.data);
            
            // 更新表格数据
            updateTableFromDBData(data.data);
            
            showToast('成功从数据库加载数据', 'success');
          } else {
            throw new Error(data.error || '加载失败');
          }
        })
        .catch(error => {
          console.error('从数据库加载数据失败:', error);
          showToast(`加载失败: ${error.message}`, 'danger');
        })
        .finally(() => {
          // 隐藏加载指示器
          if (loaderContainer) loaderContainer.style.display = 'none';
        });
    }
    
    // 从数据库数据更新表格
    function updateTableFromDBData(dbData) {
      console.log('开始更新表格数据...');
      
      // 遍历所有数据点
      for (const [identifier, value] of Object.entries(dbData)) {
        console.log(`更新数据点: ${identifier} = ${value.value}`);
        
        // 更新数据点映射
        dataPointsMap.set(identifier, {
          config: { 
            identifier: identifier,
            name: value.name || identifier
          },
          value: value.value,
          timestamp: value.timestamp,
          source: 'database'
        });
        
        // 更新UI
        updateDataPointUI(identifier);
        
        // 更新表格
        updateDataPointInTable(identifier, value.value);
      }
      
      console.log('表格更新完成');
    }

    // 处理告警消息 - 使用新的独立组件
    function processAlarmMessage(alarmData) {
      console.log('处理告警消息:', alarmData);
      
      // 🔧 修复：统一处理单点报警和其他告警的字段差异
      // 单点报警使用 dataPointId，其他告警使用 identifier
      const identifier = alarmData.identifier || alarmData.dataPointId || alarmData.id;
      const dataPointName = alarmData.dataPointName || alarmData.name || identifier;
      
      console.log('标准化后的告警数据:', {
        原始identifier: alarmData.identifier,
        原始dataPointId: alarmData.dataPointId,
        最终identifier: identifier,
        最终dataPointName: dataPointName
      });
      
      if (!identifier) {
        console.error('告警消息缺少有效的标识符字段', alarmData);
        return;
      }
      
      // 获取新的告警组件
      const newAlarmsList = document.getElementById('newAlarmsList');
      const newNoAlarms = document.getElementById('newNoAlarms');
      const newAlarmsContainer = document.getElementById('newAlarmsContainer');
      
      console.log('新告警组件查找结果:', {
        newAlarmsList: newAlarmsList,
        newNoAlarms: newNoAlarms,
        newAlarmsContainer: newAlarmsContainer,
        alarmsListExists: !!newAlarmsList,
        noAlarmsExists: !!newNoAlarms
      });
      
      if (!newAlarmsList || !newNoAlarms) {
        console.error('未找到新的告警组件元素');
        return;
      }
      
      // 检查当前告警列表状态
      console.log('当前新告警列表状态:', {
        childrenCount: newAlarmsList.children.length,
        innerHTML: newAlarmsList.innerHTML,
        noAlarmsDisplay: newNoAlarms.style.display
      });
      
      // 隐藏"无告警"提示
      newNoAlarms.style.display = 'none';
      console.log('已隐藏新的"无告警"提示');
      
      // 检查是否已存在该告警（使用统一的identifier）
      const existingAlarm = document.getElementById(`new-alarm-${identifier}`);
      if (existingAlarm) {
        console.log('已存在相同标识符的告警，更新时间并重置倒计时');
        // 更新告警时间
        const timeElement = existingAlarm.querySelector('.new-alarm-time');
        if (timeElement) {
          const triggerTime = new Date(alarmData.timestamp);
          timeElement.textContent = `触发时间: ${triggerTime.toLocaleString()}`;
        }
        
        // 重置倒计时
        startAlarmCountdown(identifier);
        
        return;
      }
      
      // 创建新的告警元素
      const newAlarmElement = document.createElement('div');
      newAlarmElement.className = 'new-alarm-item';
      newAlarmElement.id = `new-alarm-${identifier}`;  // 使用统一的identifier
      
      // 格式化时间
      const triggerTime = new Date(alarmData.timestamp);
      
      // 设置告警内容和样式
      newAlarmElement.innerHTML = `
        <div class="new-alarm-title" style="font-weight: bold; color: #dc3545; margin-bottom: 8px;">
          <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
          ${dataPointName}
        </div>
        <div class="new-alarm-desc" style="color: #666; font-size: 0.9em; margin-bottom: 8px;">
          ${alarmData.content}
        </div>
        <div class="new-alarm-time" style="color: #999; font-size: 0.8em; margin-bottom: 8px;">
          触发时间: ${triggerTime.toLocaleString()}
        </div>
        <div class="new-alarm-countdown" style="color: #007bff; font-size: 0.8em; margin-bottom: 8px; font-weight: bold;">
          <i class="bi bi-clock me-1"></i>下次播报: <span id="countdown-${identifier}">5:00</span>
        </div>
        <div class="mt-2">
          <span class="new-alarm-alert" style="display: inline-block; padding: 4px 8px; border-radius: 3px; background-color: rgba(220, 53, 69, 0.1); color: #dc3545;">
            <i class="bi bi-bell-fill me-1"></i> 告警中
          </span>
        </div>
      `;
      
      // 强制设置告警元素样式
      newAlarmElement.style.cssText = `
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        padding: 15px !important;
        margin-bottom: 10px !important;
        border-radius: 5px !important;
        background-color: #fff !important;
        border-left: 4px solid #dc3545 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        z-index: 1 !important;
      `;
      
      console.log('创建的新告警元素:', {
        element: newAlarmElement,
        id: newAlarmElement.id,
        className: newAlarmElement.className,
        identifier: identifier,
        dataPointName: dataPointName,
        innerHTML: newAlarmElement.innerHTML.substring(0, 100) + '...',
        styles: newAlarmElement.style.cssText
      });
      
      // 添加到新的告警列表容器
      newAlarmsList.appendChild(newAlarmElement);
      console.log('已添加新告警到新列表', newAlarmElement);
      
      // 强制确保新告警列表容器可见
      newAlarmsList.style.cssText = `
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 50px !important;
      `;
      
      // 验证添加结果
      console.log('添加后的新告警列表状态:', {
        childrenCount: newAlarmsList.children.length,
        firstChildId: newAlarmsList.firstElementChild ? newAlarmsList.firstElementChild.id : 'none',
        allChildrenIds: Array.from(newAlarmsList.children).map(child => child.id),
        listStyles: newAlarmsList.style.cssText
      });
      
      // 确保实时告警视图可见
      const realTimeAlarmsView = document.getElementById('real-time-alarms');
      console.log('实时告警视图元素:', realTimeAlarmsView);
      
      if (realTimeAlarmsView) {
        realTimeAlarmsView.classList.add('active');
        console.log('已激活实时告警视图');
      } else {
        console.error('未找到实时告警视图元素');
      }
      
      document.querySelectorAll('.view-container').forEach(container => {
        if (container.id !== 'real-time-alarms') {
          container.classList.remove('active');
        }
      });
      
      // 更新侧边栏导航项的激活状态
      document.querySelectorAll('.sidebar-nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-view') === 'real-time-alarms') {
          link.classList.add('active');
        }
      });
      
      console.log('已切换到实时告警视图');
      
      // 最终验证：检查告警是否真的在DOM中
      setTimeout(() => {
        const verifyElement = document.getElementById(`new-alarm-${identifier}`);
        const verifyList = document.getElementById('newAlarmsList');
        const verifyNoAlarms = document.getElementById('newNoAlarms');
        
        console.log('新组件最终验证结果:', {
          alarmElementExists: !!verifyElement,
          alarmElementId: verifyElement ? verifyElement.id : null,
          alarmElementParent: verifyElement ? verifyElement.parentNode : null,
          listChildrenCount: verifyList ? verifyList.children.length : 0,
          noAlarmsDisplay: verifyNoAlarms ? verifyNoAlarms.style.display : 'not found',
          currentView: document.querySelector('.view-container.active')?.id
        });
        
        // 强制确保告警显示正确
        if (verifyList && verifyList.children.length > 0 && verifyNoAlarms) {
          if (verifyNoAlarms.style.display !== 'none') {
            console.log('强制隐藏新的"无告警"提示');
            verifyNoAlarms.style.display = 'none';
          }
        }
      }, 100);
      
      // 启动告警音频循环（广播提示音+文本转语音，5分钟间隔）
      startAlarmAudioLoop(alarmData);
      
      // 启动倒计时显示（使用统一的identifier）
      startAlarmCountdown(identifier);
      
      // 存储告警到数据库
      storeAlarmToDatabase(alarmData);
    }

    // 处理告警解除消息 - 使用新的独立组件
    function processAlarmClearedMessage(alarmData) {
      console.log('处理告警解除消息:', alarmData);
      
      // 🔧 修复：统一处理单点报警和其他告警的字段差异
      const identifier = alarmData.identifier || alarmData.dataPointId || alarmData.id;
      
      console.log('告警解除标准化处理:', {
        原始identifier: alarmData.identifier,
        原始dataPointId: alarmData.dataPointId,
        最终identifier: identifier
      });
      
      if (!identifier) {
        console.error('告警解除消息缺少有效的标识符字段', alarmData);
        return;
      }
      
      // 停止告警音频循环
      stopAlarmAudioLoop();
      
      // 停止对应告警的倒计时（使用统一的identifier）
      stopAlarmCountdown(identifier);
      
      // 更新数据库中的告警状态为已解除
      clearAlarmInDatabase(alarmData);
      
      // 获取新的告警组件
      const newAlarmsList = document.getElementById('newAlarmsList');
      const newNoAlarms = document.getElementById('newNoAlarms');
      
      if (!newAlarmsList) {
        console.error('未找到新的告警列表容器元素');
        return;
      }
      
      // 查找对应的告警元素（使用统一的identifier）
      const alarmElement = document.getElementById(`new-alarm-${identifier}`);
      if (alarmElement) {
        console.log('找到告警元素，立即移除（告警已解除）');
        
        // 立即移除告警元素
        alarmElement.parentNode.removeChild(alarmElement);
        console.log('告警元素已移除:', identifier);
        
        // 检查是否还有其他告警
        if (newAlarmsList.children.length === 0) {
          if (newNoAlarms) {
            newNoAlarms.style.display = 'block';
            console.log('无更多告警，显示新的"无告警"提示');
          }
        }
      } else {
        console.warn(`未找到对应的告警元素: new-alarm-${identifier}`);
        console.log('当前告警列表中的所有元素ID:', Array.from(newAlarmsList.children).map(child => child.id));
      }
    }

    // 播放告警声音 - 新的广播提示音+文本转语音系统
    function playAlarmSound(alarmData = null) {
      if (!alarmAudioEnabled) {
        console.log('告警音频已禁用，跳过播放');
        return;
      }
      
      console.log('开始播放告警音频（广播提示音+文本转语音）');
      console.log('接收到的参数类型:', typeof alarmData);
      console.log('接收到的参数内容:', alarmData);
      
      // 处理不同类型的参数
      let processedAlarmData = null;
      
      if (Array.isArray(alarmData)) {
        // 如果是数组（来自modbus.js的checkAlarmStatus调用）
        console.log('检测到数组参数，来自modbus.js的告警检查');
        if (alarmData.length > 0) {
          // 将字符串数组转换为告警数据对象
          processedAlarmData = {
            identifier: 'ALARM_FROM_MODBUS_JS',
            content: alarmData[0], // 使用第一个告警内容
            timestamp: new Date().toISOString(),
            dataPointName: '设备告警'
          };
          console.log('已转换为告警数据对象:', processedAlarmData);
        } else {
          console.log('数组为空，无告警内容');
          return;
        }
      } else if (alarmData && typeof alarmData === 'object') {
        // 如果是对象（来自WebSocket消息）
        console.log('检测到对象参数，来自WebSocket告警消息');
        processedAlarmData = alarmData;
      } else if (typeof alarmData === 'string') {
        // 如果是字符串
        console.log('检测到字符串参数');
        processedAlarmData = {
          identifier: 'ALARM_FROM_STRING',
          content: alarmData,
          timestamp: new Date().toISOString(),
          dataPointName: '设备告警'
        };
      } else {
        console.log('无效的告警数据，使用当前存储的告警数据');
        processedAlarmData = currentAlarmData;
      }
      
      // 保存当前告警数据
      if (processedAlarmData) {
        currentAlarmData = processedAlarmData;
        console.log('已保存当前告警数据:', currentAlarmData);
      } else {
        console.error('无法处理告警数据，跳过播放');
        return;
      }
      
      // 播放广播提示音
      playBroadcastAlert().then(() => {
        // 广播提示音播放完成后，播放文本转语音
        if (currentAlarmData) {
          playTextToSpeech(currentAlarmData);
        }
      }).catch(error => {
        console.error('播放广播提示音失败:', error);
        // 即使广播提示音失败，也尝试播放文本转语音
        if (currentAlarmData) {
          playTextToSpeech(currentAlarmData);
        }
      });
    }
    
    // 播放广播提示音
    function playBroadcastAlert() {
      return new Promise((resolve, reject) => {
        console.log('播放广播提示音: /audio/Broadcastalert.mp3');
        
        const audio = new Audio('/audio/Broadcastalert.mp3');
        audio.volume = 0.7; // 设置音量为70%
        
        // 音频加载完成事件
        audio.addEventListener('canplaythrough', () => {
          console.log('广播提示音加载完成');
        });
        
        // 音频播放结束事件
        audio.addEventListener('ended', () => {
          console.log('广播提示音播放完成');
          resolve();
        });
        
        // 音频播放错误事件
        audio.addEventListener('error', (error) => {
          console.error('广播提示音播放错误:', error);
          reject(error);
        });
        
        // 开始播放
        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            console.log('广播提示音开始播放');
          }).catch(err => {
            console.error('广播提示音播放失败:', err);
            reject(err);
          });
        }
      });
    }
    
    // 播放文本转语音
    function playTextToSpeech(alarmData) {
      if (!window.speechSynthesis) {
        console.warn('浏览器不支持语音合成');
        return;
      }
      
      console.log('开始文本转语音播报');
      console.log('接收到的alarmData:', alarmData);
      console.log('alarmData类型:', typeof alarmData);
      console.log('alarmData是否为null:', alarmData === null);
      console.log('alarmData是否为undefined:', alarmData === undefined);
      
      // 检查alarmData是否有效
      if (!alarmData) {
        console.error('alarmData为空，无法进行语音播报');
        return;
      }
      
      // 构建语音文本
      let speechText = '';
      
      // 尝试多种方式构建语音文本
      if (alarmData.content) {
        speechText = `告警提示：${alarmData.dataPointName || alarmData.identifier || '未知设备'}，${alarmData.content}`;
      } else if (typeof alarmData === 'string') {
        // 如果alarmData本身就是字符串
        speechText = `告警提示：${alarmData}`;
      } else {
        console.error('无法从alarmData中提取告警内容:', alarmData);
        speechText = '告警提示：检测到设备异常，请检查设备状态';
      }
      
      console.log('构建的语音文本:', speechText);
      
      // 创建语音合成实例
      const utterance = new SpeechSynthesisUtterance(speechText);
      
      // 设置语音参数
      utterance.lang = 'zh-CN'; // 中文
      utterance.rate = 0.9; // 语速稍慢
      utterance.pitch = 1.0; // 音调正常
      utterance.volume = 0.8; // 音量80%
      
      // 语音播放事件
      utterance.onstart = () => {
        console.log('文本转语音开始播放');
        console.log('播放的语音内容:', speechText);
      };
      
      utterance.onend = () => {
        console.log('文本转语音播放完成');
      };
      
      utterance.onerror = (error) => {
        console.error('文本转语音播放错误:', error);
      };
      
      // 开始语音播放
      window.speechSynthesis.speak(utterance);
    }
    
    // 开始告警音频循环（5分钟间隔）
    function startAlarmAudioLoop(alarmData) {
      if (!alarmAudioEnabled) {
        console.log('告警音频已禁用，不启动循环');
        return;
      }
      
      console.log('启动告警音频循环，间隔5分钟');
      
      // 清除现有的循环
      stopAlarmAudioLoop();
      
      // 保存告警数据
      currentAlarmData = alarmData;
      
      // 立即播放一次
      playAlarmSound(alarmData);
      
      // 设置5分钟循环
      alarmAudioInterval = setInterval(() => {
        console.log('5分钟循环：播放告警音频');
        playAlarmSound(currentAlarmData);
        
        // 重置倒计时（如果告警元素还存在）
        if (document.getElementById(`new-alarm-${currentAlarmData.identifier}`)) {
          startAlarmCountdown(currentAlarmData.identifier);
        }
      }, 5 * 60 * 1000); // 5分钟 = 300000毫秒
      
      console.log('告警音频循环已启动');
    }
    
    // 停止告警音频循环
    function stopAlarmAudioLoop() {
      if (alarmAudioInterval) {
        console.log('停止告警音频循环');
        clearInterval(alarmAudioInterval);
        alarmAudioInterval = null;
        
        // 停止当前正在播放的语音
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
        }
        
        // 停止所有告警倒计时
        stopAllAlarmCountdowns();
        
        console.log('告警音频循环已停止');
      }
    }
    
    // 切换告警音频状态
    function toggleAlarmAudio() {
      alarmAudioEnabled = !alarmAudioEnabled;
      console.log(`告警音频${alarmAudioEnabled ? '启用' : '禁用'}`);
      
      if (!alarmAudioEnabled) {
        // 禁用时停止循环
        stopAlarmAudioLoop();
      }
      
      // 更新UI按钮状态
      updateAlarmAudioButtonState();
      
      return alarmAudioEnabled;
    }
    
    // 更新告警音频按钮状态
    function updateAlarmAudioButtonState() {
      const pauseBtn = document.getElementById('pauseAlarmsBtn');
      const stopBtn = document.getElementById('stopAlarmsBtn');
      
      if (pauseBtn) {
        if (alarmAudioEnabled) {
          pauseBtn.className = 'btn btn-warning me-2';
          pauseBtn.innerHTML = '<i class="bi bi-pause-circle"></i> 暂停告警';
        } else {
          pauseBtn.className = 'btn btn-success me-2';
          pauseBtn.innerHTML = '<i class="bi bi-play-circle"></i> 恢复告警';
        }
      }
      
      if (stopBtn) {
        stopBtn.disabled = !alarmAudioInterval; // 只有在有循环时才能停止
      }
    }
    
    // 切换告警暂停状态
    function toggleAlarmPause() {
      const enabled = toggleAlarmAudio();
      showToast(enabled ? '告警音频已恢复' : '告警音频已暂停', enabled ? 'success' : 'warning');
    }
    
    // 停止告警循环
    function stopAlarmLoop() {
      stopAlarmAudioLoop();
      showToast('告警音频循环已停止', 'info');
      updateAlarmAudioButtonState();
    }
    
    // 启动告警倒计时显示
    function startAlarmCountdown(identifier) {
      console.log('启动告警倒计时:', identifier);
      
      // 停止现有的倒计时
      stopAlarmCountdown(identifier);
      
      // 设置下次播放时间（5分钟后）
      const nextPlayTime = Date.now() + (5 * 60 * 1000);
      alarmNextPlayTimes.set(identifier, nextPlayTime);
      
      // 启动倒计时更新
      const countdownInterval = setInterval(() => {
        updateCountdownDisplay(identifier);
      }, 1000); // 每秒更新一次
      
      alarmCountdownIntervals.set(identifier, countdownInterval);
      
      // 立即更新一次显示
      updateCountdownDisplay(identifier);
    }
    
    // 停止告警倒计时
    function stopAlarmCountdown(identifier) {
      console.log('停止告警倒计时:', identifier);
      
      const interval = alarmCountdownIntervals.get(identifier);
      if (interval) {
        clearInterval(interval);
        alarmCountdownIntervals.delete(identifier);
      }
      
      alarmNextPlayTimes.delete(identifier);
    }
    
    // 更新倒计时显示
    function updateCountdownDisplay(identifier) {
      const countdownElement = document.getElementById(`countdown-${identifier}`);
      if (!countdownElement) {
        console.warn('找不到倒计时元素:', `countdown-${identifier}`);
        return;
      }
      
      const nextPlayTime = alarmNextPlayTimes.get(identifier);
      if (!nextPlayTime) {
        console.warn('找不到下次播放时间:', identifier);
        return;
      }
      
      const now = Date.now();
      const remainingTime = nextPlayTime - now;
      
      if (remainingTime <= 0) {
        // 时间到了，重置为下一个5分钟
        const newNextPlayTime = Date.now() + (5 * 60 * 1000);
        alarmNextPlayTimes.set(identifier, newNextPlayTime);
        countdownElement.textContent = '5:00';
        countdownElement.style.color = '#007bff';
      } else {
        // 计算剩余的分钟和秒
        const minutes = Math.floor(remainingTime / (60 * 1000));
        const seconds = Math.floor((remainingTime % (60 * 1000)) / 1000);
        
        // 格式化显示
        const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        countdownElement.textContent = formattedTime;
        
        // 最后30秒变红色提醒
        if (remainingTime <= 30000) {
          countdownElement.style.color = '#dc3545';
        } else {
          countdownElement.style.color = '#007bff';
        }
      }
    }
    
    // 停止所有告警倒计时
    function stopAllAlarmCountdowns() {
      console.log('停止所有告警倒计时');
      
      alarmCountdownIntervals.forEach((interval, identifier) => {
        clearInterval(interval);
        console.log('已停止倒计时:', identifier);
      });
      
      alarmCountdownIntervals.clear();
      alarmNextPlayTimes.clear();
    }
    
    // 存储告警到数据库
    function storeAlarmToDatabase(alarmData) {
      console.log('存储告警到数据库:', alarmData);
      
      const data = {
        identifier: alarmData.identifier,
        content: alarmData.content,
        triggerTime: alarmData.timestamp,
        dataPointName: alarmData.dataPointName || alarmData.identifier
      };
      
      console.log('发送告警数据到API:', data);
      
      fetch('/api/modbus/alarms/store', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP错误: ${response.status}`);
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          console.log('告警已成功存储到数据库:', result.alarm);
          showToast('告警已记录到数据库', 'success');
        } else {
          console.error('存储告警失败:', result.error);
          showToast('告警记录失败: ' + result.error, 'warning');
        }
      })
      .catch(error => {
        console.error('存储告警到数据库失败:', error);
        showToast('告警记录失败: ' + error.message, 'danger');
        
        // 存储到本地作为备份
        storeAlarmLocally(alarmData);
      });
    }
    
    // 清除数据库中的告警状态
    function clearAlarmInDatabase(alarmData) {
      console.log('更新数据库中的告警状态为已解除:', alarmData);
      
      const data = {
        identifier: alarmData.identifier,
        clearedTime: alarmData.timestamp
      };
      
      console.log('发送告警解除数据到API:', data);
      
      fetch('/api/modbus/alarms/clear', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP错误: ${response.status}`);
        }
        return response.json();
      })
      .then(result => {
        if (result.success) {
          console.log('告警状态已成功更新为已解除:', result);
          showToast('告警已解除并更新数据库', 'info');
        } else {
          console.error('更新告警状态失败:', result.error);
          showToast('告警解除记录失败: ' + result.error, 'warning');
        }
      })
      .catch(error => {
        console.error('更新告警状态失败:', error);
        showToast('告警解除记录失败: ' + error.message, 'danger');
      });
    }
    
    // 本地存储告警（备份机制）
    function storeAlarmLocally(alarmData) {
      try {
        console.log('存储告警到本地存储:', alarmData);
        
        // 获取现有的本地告警
        let localAlarms = [];
        const localStorageKey = 'modbus_local_alarms';
        
        try {
          const existingData = localStorage.getItem(localStorageKey);
          if (existingData) {
            localAlarms = JSON.parse(existingData);
          }
        } catch (error) {
          console.error('读取本地告警存储失败:', error);
        }
        
        // 添加新告警
        localAlarms.push({
          ...alarmData,
          savedAt: new Date().toISOString(),
          synced: false
        });
        
        // 保存回本地存储
        localStorage.setItem(localStorageKey, JSON.stringify(localAlarms));
        console.log('告警已存储到本地存储');
        
        showToast('告警已保存到本地存储', 'info');
      } catch (error) {
        console.error('存储告警到本地失败:', error);
      }
    }
    
    // 调试函数：检查告警列表状态
    function debugAlarmsList() {
      const alarmsList = document.getElementById('alarmsList');
      const noAlarms = document.getElementById('noAlarms');
      const realTimeAlarmsView = document.getElementById('real-time-alarms');
      const activeView = document.querySelector('.view-container.active');
      
      console.log('=== 告警列表调试信息 ===');
      console.log('告警列表容器:', alarmsList);
      console.log('无告警提示:', noAlarms);
      console.log('实时告警视图:', realTimeAlarmsView);
      console.log('当前激活视图:', activeView);
      
      if (alarmsList) {
        console.log('告警列表详情:', {
          childrenCount: alarmsList.children.length,
          innerHTML: alarmsList.innerHTML,
          style: alarmsList.style.cssText,
          computedStyle: window.getComputedStyle(alarmsList).display
        });
        
        console.log('告警列表子元素:');
        Array.from(alarmsList.children).forEach((child, index) => {
          console.log(`  ${index}: ${child.id} - ${child.className}`);
        });
      }
      
      if (noAlarms) {
        console.log('无告警提示详情:', {
          display: noAlarms.style.display,
          computedDisplay: window.getComputedStyle(noAlarms).display,
          innerHTML: noAlarms.innerHTML
        });
      }
      
      if (realTimeAlarmsView) {
        console.log('实时告警视图详情:', {
          classList: Array.from(realTimeAlarmsView.classList),
          isActive: realTimeAlarmsView.classList.contains('active'),
          display: window.getComputedStyle(realTimeAlarmsView).display
        });
      }
      
      console.log('=== 调试信息结束 ===');
    }
    
    // 手动添加测试告警的函数
    function addTestAlarm() {
      const testAlarmData = {
        identifier: 'TEST_ALARM',
        content: '这是一个测试告警消息',
        timestamp: new Date().toISOString(),
        dataPointName: '测试数据点'
      };
      
      console.log('添加测试告警:', testAlarmData);
      processAlarmMessage(testAlarmData);
    }
    
    // 将调试函数暴露到全局作用域
    window.debugAlarmsList = debugAlarmsList;
    window.addTestAlarm = addTestAlarm;
    
    // 测试新的音频系统
    window.testNewAudioSystem = function() {
      const testAlarmData = {
        identifier: 'AUDIO_TEST',
        content: '这是音频系统测试',
        timestamp: new Date().toISOString(),
        dataPointName: '音频测试数据点'
      };
      
      console.log('测试新的音频系统:', testAlarmData);
      
      // 测试单次播放
      playAlarmSound(testAlarmData);
      
      // 提示用户
      alert('音频测试已开始，请检查是否能听到广播提示音和语音播报');
    };
    
    // 测试音频循环
    window.testAudioLoop = function() {
      const testAlarmData = {
        identifier: 'LOOP_TEST',
        content: '这是音频循环测试',
        timestamp: new Date().toISOString(),
        dataPointName: '循环测试数据点'
      };
      
      console.log('测试音频循环系统:', testAlarmData);
      
      // 启动循环测试（缩短为30秒间隔用于测试）
      if (alarmAudioInterval) {
        stopAlarmAudioLoop();
      }
      
      currentAlarmData = testAlarmData;
      playAlarmSound(testAlarmData);
      
      // 设置30秒循环用于测试
      alarmAudioInterval = setInterval(() => {
        console.log('30秒测试循环：播放告警音频');
        playAlarmSound(currentAlarmData);
      }, 30000); // 30秒
      
      alert('音频循环测试已开始（30秒间隔），请使用stopAlarmLoop()停止测试');
    };
    
    // 测试倒计时功能
    window.testCountdown = function() {
      const testAlarmData = {
        identifier: 'COUNTDOWN_TEST',
        content: '这是倒计时测试告警',
        timestamp: new Date().toISOString(),
        dataPointName: '倒计时测试数据点'
      };
      
      console.log('测试倒计时功能:', testAlarmData);
      
      // 创建测试告警并启动倒计时
      processAlarmMessage(testAlarmData);
      
      alert('倒计时测试已开始，请查看告警列表中的倒计时显示');
    };
    
    // 测试快速倒计时（30秒间隔）
    window.testFastCountdown = function() {
      const testAlarmData = {
        identifier: 'FAST_TEST',
        content: '这是快速倒计时测试',
        timestamp: new Date().toISOString(),
        dataPointName: '快速测试数据点'
      };
      
      console.log('测试快速倒计时:', testAlarmData);
      
      // 手动创建告警元素
      processAlarmMessage(testAlarmData);
      
      // 修改倒计时为30秒用于测试
      setTimeout(() => {
        const nextPlayTime = Date.now() + 30000; // 30秒
        alarmNextPlayTimes.set(testAlarmData.identifier, nextPlayTime);
        console.log('已设置30秒倒计时用于测试');
      }, 100);
      
      alert('快速倒计时测试已开始（30秒），请观察倒计时变化');
    };
    
    // 测试数据库存储功能
    window.testDatabaseStorage = function() {
      const testAlarmData = {
        identifier: 'DB_TEST',
        content: '这是数据库存储测试告警',
        timestamp: new Date().toISOString(),
        dataPointName: '数据库测试数据点'
      };
      
      console.log('测试数据库存储功能:', testAlarmData);
      
      // 直接测试存储功能
      storeAlarmToDatabase(testAlarmData);
      
      alert('数据库存储测试已开始，请查看控制台和提示消息');
    };
    
    // 测试告警解除功能
    window.testAlarmClear = function() {
      const identifier = prompt('请输入要解除的告警标识符', 'DB_TEST');
      if (!identifier) return;
      
      const clearData = {
        identifier: identifier,
        timestamp: new Date().toISOString()
      };
      
      console.log('测试告警解除功能:', clearData);
      
      // 直接测试解除功能
      clearAlarmInDatabase(clearData);
      
      alert('告警解除测试已开始，请查看控制台和提示消息');
    };
    
    // 测试完整的告警流程（触发+解除）
    window.testFullAlarmFlow = function() {
      const testAlarmData = {
        identifier: 'FULL_TEST',
        content: '这是完整流程测试告警',
        timestamp: new Date().toISOString(),
        dataPointName: '完整测试数据点'
      };
      
      console.log('测试完整告警流程:', testAlarmData);
      
      // 1. 触发告警（包含数据库存储）
      processAlarmMessage(testAlarmData);
      
      // 2. 10秒后自动解除告警
      setTimeout(() => {
        const clearData = {
          identifier: testAlarmData.identifier,
          timestamp: new Date().toISOString()
        };
        
        console.log('10秒后自动解除告警:', clearData);
        processAlarmClearedMessage(clearData);
      }, 10000);
      
      alert('完整告警流程测试已开始，10秒后将自动解除告警');
    };
    
    // 查看数据库中的告警记录
    window.viewDatabaseAlarms = function() {
      console.log('查询数据库中的告警记录...');
      
      fetch('/api/modbus/alarms/active')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
          }
          return response.json();
        })
        .then(alarms => {
          console.log('数据库中的告警记录:', alarms);
          
          if (alarms.length === 0) {
            alert('数据库中没有告警记录');
          } else {
            let message = `数据库中共有 ${alarms.length} 条告警记录：\n\n`;
            alarms.forEach((alarm, index) => {
              message += `${index + 1}. ${alarm.content || alarm.alarm_content}\n`;
              message += `   标识符: ${alarm.identifier || alarm.alarm_identifier}\n`;
              message += `   状态: ${alarm.status}\n`;
              message += `   触发时间: ${alarm.triggered_time || alarm.triggerTime}\n`;
              if (alarm.cleared_time) {
                message += `   解除时间: ${alarm.cleared_time}\n`;
              }
              message += '\n';
            });
            
            alert(message);
          }
        })
        .catch(error => {
          console.error('查询告警记录失败:', error);
          alert('查询告警记录失败: ' + error.message);
        });
    };
    
    // 处理POINT格式数据点的实时解析（从MQTT数据）
    function processPointDataPointsFromMQTT(mqttData) {
      console.log('[POINT解析] 开始处理MQTT消息中的POINT格式数据点解析...', mqttData);
      
      // 查找所有POINT格式的数据点
      const pointDataPoints = dataPointConfigs.filter(dp => dp.format === 'POINT');
      
      if (pointDataPoints.length === 0) {
        console.log('[POINT解析] 没有POINT格式数据点需要处理');
        return;
      }
      
      console.log(`[POINT解析] 找到 ${pointDataPoints.length} 个POINT格式数据点需要处理解析`);
      
      // 创建当前有效数据点标识符的集合，用于快速查找
      const validIdentifiers = new Set(dataPointConfigs.map(dp => dp.identifier).filter(id => id));
      const validNames = new Set(dataPointConfigs.map(dp => dp.name).filter(name => name));
      
      // 收集解析后的POINT数据用于保存到数据库
      const pointDataToSave = {};
      // 收集解析后的POINT数据用于告警检查
      const pointDataForAlarm = {};
      let processedCount = 0;
      
      // 确保window.currentDataValues存在
      if (!window.currentDataValues) {
        window.currentDataValues = {};
      }
      
      pointDataPoints.forEach(pointDP => {
        console.log(`[POINT解析] 检查POINT数据点: ${pointDP.name} (${pointDP.identifier})`);
        
        // 检查源数据点是否在本次MQTT数据中有更新
        const sourceIdentifier = pointDP.sourceDataPointIdentifier;
        if (!sourceIdentifier) {
          console.warn(`[POINT解析] POINT数据点 ${pointDP.name} 没有配置源数据点标识符，跳过`);
          return;
        }
        
        console.log(`[POINT解析] 源数据点标识符: ${sourceIdentifier}, 位位置: ${pointDP.pointBitPosition}`);
        
        // 验证源数据点是否仍然存在于当前配置中
        if (!validIdentifiers.has(sourceIdentifier) && !validNames.has(sourceIdentifier)) {
          console.warn(`[POINT解析] POINT数据点 ${pointDP.name} 的源数据点 ${sourceIdentifier} 已不存在，跳过解析`);
          return;
        }
        
        // 检查MQTT数据中是否包含源数据点的值
        let sourceValue = null;
        if (mqttData[sourceIdentifier] !== undefined) {
          sourceValue = mqttData[sourceIdentifier];
        } else {
          // 尝试通过数据点名称查找
          const sourceDataPoint = dataPointConfigs.find(dp => dp.identifier === sourceIdentifier);
          if (sourceDataPoint && mqttData[sourceDataPoint.name] !== undefined) {
            sourceValue = mqttData[sourceDataPoint.name];
          }
        }
        
        if (sourceValue === null || sourceValue === undefined) {
          console.log(`[POINT解析] 源数据点 ${sourceIdentifier} 在本次MQTT数据中没有更新`);
          return;
        }
        
        console.log(`[POINT解析] 处理POINT数据点 ${pointDP.name}，源数据点 ${sourceIdentifier} 值: ${sourceValue}`);
        
        // 执行位运算解析
        const numValue = parseInt(sourceValue);
        if (isNaN(numValue)) {
          console.warn(`[POINT解析] 源数据点 ${sourceIdentifier} 的值 ${sourceValue} 不是有效数字，跳过解析`);
          return;
        }
        
        const pointBitPosition = parseInt(pointDP.pointBitPosition);
        if (isNaN(pointBitPosition) || pointBitPosition < 0 || pointBitPosition > 15) {
          console.warn(`[POINT解析] POINT数据点 ${pointDP.name} 的位位置 ${pointDP.pointBitPosition} 无效，跳过解析`);
          return;
        }
        
        // 执行位运算：(numValue >> bitPosition) & 1
        const pointValue = (numValue >> pointBitPosition) & 1;
        
        console.log(`[POINT解析] POINT解析结果: ${pointDP.name} = ${pointValue} (源值: ${numValue}, 位位置: ${pointBitPosition})`);
        
        // 更新数据点映射
        dataPointsMap.set(pointDP.identifier, {
          config: pointDP,
          value: pointValue,
          timestamp: new Date().toISOString(),
          source: 'point_parsing'
        });
        
        console.log(`[POINT解析] POINT数据点 ${pointDP.identifier} 已更新到映射，值: ${pointValue}`);
        
        // 更新window.currentDataValues，用于告警检查
        window.currentDataValues[pointDP.name] = {
          value: pointValue,
          formatted: pointValue.toString(),
          timestamp: new Date().toISOString(),
          quality: 'GOOD'
        };
        
        // 收集数据用于告警检查
        pointDataForAlarm[pointDP.name] = {
          value: pointValue,
          formatted: pointValue.toString(),
          timestamp: new Date().toISOString(),
          quality: 'GOOD'
        };
        
        // 收集数据用于保存到数据库
        pointDataToSave[pointDP.identifier] = pointValue;
        processedCount++;
        
        // 更新UI显示
        updateDataPointUI(pointDP.identifier);
        
        // 更新表格中的值
        updateDataPointInTable(pointDP.identifier, pointValue);
        
        console.log(`[POINT解析] POINT数据点 ${pointDP.name} UI已更新`);
      });
      
      // 如果有解析后的POINT数据，保存到数据库
      if (Object.keys(pointDataToSave).length > 0) {
        console.log(`[POINT解析] 准备保存 ${Object.keys(pointDataToSave).length} 个POINT数据到数据库:`, pointDataToSave);
        savePointDataToDatabase(pointDataToSave);
      } else {
        console.log(`[POINT解析] 没有POINT数据需要保存到数据库，处理了 ${processedCount} 个数据点`);
      }
      
      // 如果有解析后的POINT数据，进行告警检查
      if (Object.keys(pointDataForAlarm).length > 0) {
        console.log(`[POINT解析] 对 ${Object.keys(pointDataForAlarm).length} 个POINT数据点进行告警检查:`, pointDataForAlarm);
        
        // 确保全局数据点变量是最新的
        if (typeof dataPointConfigs !== 'undefined' && dataPointConfigs.length > 0) {
          window.dataPoints = dataPointConfigs;
          console.log(`[POINT解析] 已更新全局数据点配置，数量: ${dataPointConfigs.length}`);
        }
        
        // 调用告警检查函数
        if (typeof checkAlarmStatus === 'function') {
          console.log(`[POINT解析] 调用告警检查函数，传入数据:`, pointDataForAlarm);
          checkAlarmStatus(pointDataForAlarm);
        } else {
          console.warn('[POINT解析] checkAlarmStatus函数不可用');
        }
      }
    }
    
    // 保存POINT数据到数据库
    async function savePointDataToDatabase(pointData) {
      console.log('[POINT保存] 开始保存POINT数据到数据库:', pointData);
      
      try {
        const response = await fetch('/api/modbus/save-point-data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            pointData: pointData,
            timestamp: new Date().toISOString()
          })
        });
        
        console.log('[POINT保存] 发送请求到后端，状态码:', response.status);
        
        if (response.ok) {
          const result = await response.json();
          console.log('[POINT保存] POINT数据保存成功:', result);
        } else {
          const errorText = await response.text();
          console.error('[POINT保存] POINT数据保存失败:', response.status, response.statusText, errorText);
        }
      } catch (error) {
        console.error('[POINT保存] 保存POINT数据到数据库失败:', error);
      }
    }
    
    // 调试函数：检查POINT数据点配置
    window.checkPointDataPoints = async function() {
      console.log('=== 检查POINT数据点配置 ===');
      
      try {
        const dataPointConfigs = await loadDataPointConfigs();
        if (!dataPointConfigs || dataPointConfigs.length === 0) {
          console.log('没有数据点配置');
          return;
        }
        
        // 查找所有POINT格式的数据点
        const pointDataPoints = dataPointConfigs.filter(dp => dp.format === 'POINT');
        
        if (pointDataPoints.length === 0) {
          console.log('没有POINT格式数据点');
          return;
        }
        
        console.log(`找到 ${pointDataPoints.length} 个POINT格式数据点`);
        
        // 创建当前有效数据点标识符的集合
        const validIdentifiers = new Set(dataPointConfigs.map(dp => dp.identifier).filter(id => id));
        const validNames = new Set(dataPointConfigs.map(dp => dp.name).filter(name => name));
        
        const invalidPointDataPoints = [];
        const validPointDataPoints = [];
        
        pointDataPoints.forEach(pointDP => {
          const sourceIdentifier = pointDP.sourceDataPointIdentifier;
          
          if (!sourceIdentifier) {
            invalidPointDataPoints.push({
              point: pointDP,
              reason: '没有配置源数据点标识符'
            });
            return;
          }
          
          if (!validIdentifiers.has(sourceIdentifier) && !validNames.has(sourceIdentifier)) {
            invalidPointDataPoints.push({
              point: pointDP,
              reason: `源数据点 ${sourceIdentifier} 不存在`
            });
            return;
          }
          
          const pointBitPosition = parseInt(pointDP.pointBitPosition);
          if (isNaN(pointBitPosition) || pointBitPosition < 0 || pointBitPosition > 15) {
            invalidPointDataPoints.push({
              point: pointDP,
              reason: `位位置 ${pointDP.pointBitPosition} 无效`
            });
            return;
          }
          
          validPointDataPoints.push(pointDP);
        });
        
        console.log(`有效的POINT数据点: ${validPointDataPoints.length} 个`);
        validPointDataPoints.forEach(dp => {
          console.log(`  ✓ ${dp.name} (${dp.identifier}) -> 源: ${dp.sourceDataPointIdentifier}, 位: ${dp.pointBitPosition}`);
        });
        
        console.log(`无效的POINT数据点: ${invalidPointDataPoints.length} 个`);
        invalidPointDataPoints.forEach(item => {
          console.log(`  ✗ ${item.point.name} (${item.point.identifier}) - ${item.reason}`);
        });
        
        if (invalidPointDataPoints.length > 0) {
          const shouldDelete = confirm(`发现 ${invalidPointDataPoints.length} 个无效的POINT数据点配置，是否删除它们？`);
          if (shouldDelete) {
            for (const item of invalidPointDataPoints) {
              try {
                await deleteDataPoint(item.point.id);
                console.log(`已删除无效POINT数据点: ${item.point.name}`);
              } catch (error) {
                console.error(`删除POINT数据点失败: ${item.point.name}`, error);
              }
            }
            
            // 重新加载数据点配置
            await loadDataPoints();
            console.log('已重新加载数据点配置');
          }
        }
        
        return {
          total: pointDataPoints.length,
          valid: validPointDataPoints.length,
          invalid: invalidPointDataPoints.length,
          invalidDetails: invalidPointDataPoints
        };
        
      } catch (error) {
        console.error('检查POINT数据点配置失败:', error);
      }
    };
    
    // 调试函数：清理无效数据点缓存
    window.clearInvalidDataPointsCache = function() {
      if (window.invalidDataPointsCache) {
        const size = window.invalidDataPointsCache.size;
        window.invalidDataPointsCache.clear();
        console.log(`已清理无效数据点缓存，清理了 ${size} 个条目`);
      } else {
        console.log('无效数据点缓存不存在');
      }
    };
    
    // 调试函数：查看当前缓存状态
    window.viewInvalidDataPointsCache = function() {
      if (window.invalidDataPointsCache) {
        console.log(`无效数据点缓存大小: ${window.invalidDataPointsCache.size}`);
        console.log('缓存内容:', Array.from(window.invalidDataPointsCache));
      } else {
        console.log('无效数据点缓存不存在');
      }
    };
    
    console.log('=== 调试函数已加载 ===');
    console.log('可用的调试函数:');
    console.log('- window.checkPointDataPoints() - 检查POINT数据点配置');
    console.log('- window.clearInvalidDataPointsCache() - 清理无效数据点缓存');
    console.log('- window.viewInvalidDataPointsCache() - 查看缓存状态');
    
    // 调试工具：检查数据点配置状态
    window.checkDataPointConfigs = function() {
      console.log('=== 数据点配置检查 ===');
      console.log('dataPointConfigs 是否定义:', typeof dataPointConfigs !== 'undefined');
      console.log('dataPointConfigs 是否为数组:', Array.isArray(dataPointConfigs));
      console.log('数据点配置数量:', dataPointConfigs ? dataPointConfigs.length : '未定义');
      
      if (dataPointConfigs && dataPointConfigs.length > 0) {
        console.log('前10个数据点配置:');
        dataPointConfigs.slice(0, 10).forEach((config, index) => {
          console.log(`${index + 1}. ${config.identifier} - ${config.name} (${config.format})`);
        });
        
        console.log('所有数据点标识符:', dataPointConfigs.map(dp => dp.identifier));
        
        // 检查是否有JXGSYS等数据点
        const testIdentifiers = ['JXGSYS', 'FJTS', 'TJTSYS', 'ZHSC0', 'ZHSC1'];
        console.log('测试数据点存在情况:');
        testIdentifiers.forEach(id => {
          const found = dataPointConfigs.find(c => c.identifier === id);
          console.log(`${id}: ${found ? '存在' : '不存在'}`);
          if (found) {
            console.log(`  - 名称: ${found.name}`);
            console.log(`  - 格式: ${found.format}`);
          }
        });
      } else {
        console.warn('数据点配置为空或未加载');
        console.log('尝试重新加载数据点配置...');
        loadDataPointConfigs().then(configs => {
          console.log('重新加载结果:', configs ? configs.length : 0, '个数据点');
          if (configs) {
            dataPointConfigs = configs;
            console.log('数据点配置已更新');
          }
        }).catch(error => {
          console.error('重新加载失败:', error);
        });
      }
      
      console.log('dataPointsMap 大小:', dataPointsMap ? dataPointsMap.size : '未定义');
      console.log('=== 检查完成 ===');
    };
    
    // 调试工具：强制重新加载数据点配置
    window.reloadDataPointConfigs = async function() {
      console.log('强制重新加载数据点配置...');
      try {
        const configs = await loadDataPointConfigs();
        console.log('重新加载成功，数据点数量:', configs ? configs.length : 0);
        if (configs) {
          dataPointConfigs = configs;
          console.log('数据点配置已更新');
          // 重新渲染表格
          renderDataDisplayTable(true);
          console.log('表格已重新渲染');
        }
        return configs;
      } catch (error) {
        console.error('重新加载数据点配置失败:', error);
        throw error;
      }
    };
    
    // 调试工具帮助
    window.debugHelp = function() {
      console.log('=== 调试工具帮助 ===');
      console.log('定时器管理:');
      console.log('- window.debugTimers() - 查看所有定时器状态');
      console.log('- window.stopAllTimers() - 停止所有定时器');
      console.log('- window.restartDataRefresh(interval) - 重启数据刷新定时器');
      console.log('');
      console.log('数据点管理:');
      console.log('- window.checkPointDataPoints() - 检查和清理无效的POINT数据点配置');
      console.log('- window.clearInvalidDataPointsCache() - 清理无效数据点缓存');
      console.log('- window.viewInvalidDataPointsCache() - 查看缓存状态');
      console.log('- window.checkDataPointConfigs() - 检查数据点配置状态');
      console.log('- window.reloadDataPointConfigs() - 强制重新加载数据点配置');
      console.log('');
      console.log('使用方法：在浏览器控制台中直接调用这些函数');
      console.log('=== 帮助结束 ===');
    };
  </script>

  <!-- 多条件告警规则JavaScript -->
  <script>
    // 多条件告警规则相关变量
    let multiConditionAlarmRules = [];
    let conditionCounter = 0;
    
    // 告警分类默认内容模板
    const alarmCategoryTemplates = {
      '1': '"数据点名称"运行但是电流为零，可能故障原因是跳闸、变频器报错以及回路硬件故障，请现场查看',
      '2': '"数据点名称"热保护启动，可能故障原因是堵塞、设备电机故障，请现场查看',
      '3': '"数据点名称"运行方式异常，可能故障原因手动切换后未恢复自动运行，请现场查看',
      '4': '"数据点名称"水流异常，可能故障原因是水泵堵塞或者脱管导致未有出水，请现场查看',
      '5': '"数据点名称"切换至手动运行，请问是现场操作吗？需要进行计时提醒操作吗？'
    };
    
    // 页面加载完成后初始化多条件告警规则功能
    document.addEventListener('DOMContentLoaded', function() {
      initMultiConditionAlarmRules();
    });
    
    // 初始化多条件告警规则功能
    function initMultiConditionAlarmRules() {
      // 绑定添加多条件告警规则按钮
      const addMultiConditionAlarmBtn = document.getElementById('addMultiConditionAlarmBtn');
      if (addMultiConditionAlarmBtn) {
        addMultiConditionAlarmBtn.addEventListener('click', showMultiConditionAlarmModal);
      }
      
      // 绑定告警分类选择变化事件
      const multiAlarmCategory = document.getElementById('multiAlarmCategory');
      if (multiAlarmCategory) {
        multiAlarmCategory.addEventListener('change', updateAlarmContentByCategory);
      }
      
      // 绑定规则名称输入变化事件
      const multiAlarmRuleName = document.getElementById('multiAlarmRuleName');
      if (multiAlarmRuleName) {
        multiAlarmRuleName.addEventListener('input', updateAlarmContentByCategory);
      }
      
      // 绑定添加条件按钮
      const addConditionBtn = document.getElementById('addConditionBtn');
      if (addConditionBtn) {
        addConditionBtn.addEventListener('click', addAlarmCondition);
      }
      
      // 绑定保存按钮
      const saveMultiConditionAlarmBtn = document.getElementById('saveMultiConditionAlarmBtn');
      if (saveMultiConditionAlarmBtn) {
        saveMultiConditionAlarmBtn.addEventListener('click', saveMultiConditionAlarmRule);
      }
      
      // 加载已有的多条件告警规则
      loadMultiConditionAlarmRules();
    }
    
    // 显示多条件告警规则模态框
    function showMultiConditionAlarmModal() {
      // 重置表单
      document.getElementById('multiConditionAlarmForm').reset();
      document.getElementById('conditionsContainer').innerHTML = '';
      conditionCounter = 0;
      
      // 添加第一个条件
      addAlarmCondition();
      
      // 显示模态框
      const modal = new bootstrap.Modal(document.getElementById('multiConditionAlarmModal'));
      modal.show();
    }
    
    // 根据告警分类更新告警内容
    function updateAlarmContentByCategory() {
      const category = document.getElementById('multiAlarmCategory').value;
      const contentTextarea = document.getElementById('multiAlarmContent');
      const ruleNameInput = document.getElementById('multiAlarmRuleName');
      
      if (category && alarmCategoryTemplates[category]) {
        let template = alarmCategoryTemplates[category];
        
        // 如果有规则名称，用规则名称替换"数据点名称"占位符
        const ruleName = ruleNameInput.value.trim();
        if (ruleName) {
          template = template.replace('"数据点名称"', `"${ruleName}"`);
        }
        
        contentTextarea.value = template;
      }
    }
    
    // 添加告警条件
    function addAlarmCondition() {
      conditionCounter++;
      const conditionsContainer = document.getElementById('conditionsContainer');
      
      const conditionDiv = document.createElement('div');
      conditionDiv.className = 'condition-item border rounded p-3 mb-3';
      conditionDiv.id = `condition-${conditionCounter}`;
      
      conditionDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">条件 ${conditionCounter}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAlarmCondition(${conditionCounter})">
            <i class="bi bi-trash"></i> 删除
          </button>
        </div>
        
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">数据点 *</label>
            <select class="form-select condition-datapoint" required>
              <option value="">请选择数据点</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">比较操作 *</label>
            <select class="form-select condition-operator" required>
              <option value="equals">等于 (=)</option>
              <option value="not_equals">不等于 (≠)</option>
              <option value="greater_than">大于 (>)</option>
              <option value="greater_equal">大于等于 (≥)</option>
              <option value="less_than">小于 (<)</option>
              <option value="less_equal">小于等于 (≤)</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">目标值 *</label>
            <input type="text" class="form-control condition-value" placeholder="例如：1 或 0" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">逻辑关系</label>
            <select class="form-select condition-logic">
              <option value="and">并且 (AND)</option>
              <option value="or">或者 (OR)</option>
            </select>
          </div>
        </div>
      `;
      
      conditionsContainer.appendChild(conditionDiv);
      
      // 加载数据点选项
      loadDataPointsForCondition(conditionDiv.querySelector('.condition-datapoint'));
      
      // 如果是第一个条件，隐藏逻辑关系选择
      if (conditionCounter === 1) {
        conditionDiv.querySelector('.condition-logic').parentElement.style.display = 'none';
      }
    }
    
    // 删除告警条件
    function removeAlarmCondition(conditionId) {
      const conditionElement = document.getElementById(`condition-${conditionId}`);
      if (conditionElement) {
        conditionElement.remove();
        
        // 重新编号剩余条件
        const remainingConditions = document.querySelectorAll('.condition-item');
        remainingConditions.forEach((condition, index) => {
          const header = condition.querySelector('h6');
          if (header) {
            header.textContent = `条件 ${index + 1}`;
          }
          
          // 第一个条件隐藏逻辑关系
          const logicSelect = condition.querySelector('.condition-logic');
          if (logicSelect) {
            logicSelect.parentElement.style.display = index === 0 ? 'none' : 'block';
          }
        });
      }
    }
    
    // 为条件加载数据点选项
    async function loadDataPointsForCondition(selectElement) {
      try {
        // 使用全局的dataPointConfigs，如果不存在则重新加载
        let configs = window.dataPointConfigs;
        if (!configs || configs.length === 0) {
          console.log('数据点配置为空，尝试重新加载...');
          configs = await loadDataPointConfigs();
          window.dataPointConfigs = configs;
        }
        
        // 清空现有选项
        selectElement.innerHTML = '<option value="">请选择数据点</option>';
        
        // 添加数据点选项
        if (configs && configs.length > 0) {
          configs.forEach(config => {
            const option = document.createElement('option');
            option.value = config.identifier;
            option.textContent = `${config.name} (${config.identifier})`;
            selectElement.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = '暂无数据点配置';
          option.disabled = true;
          selectElement.appendChild(option);
        }
      } catch (error) {
        console.error('加载数据点配置失败:', error);
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '加载数据点失败';
        option.disabled = true;
        selectElement.appendChild(option);
      }
    }
    
    // 保存多条件告警规则
    async function saveMultiConditionAlarmRule() {
      try {
        // 收集表单数据
        const ruleName = document.getElementById('multiAlarmRuleName').value.trim();
        const category = document.getElementById('multiAlarmCategory').value;
        const content = document.getElementById('multiAlarmContent').value.trim();
        const level = document.getElementById('multiAlarmLevel').value;
        const consecutiveCount = parseInt(document.getElementById('multiAlarmConsecutiveCount').value);
        const enabled = document.getElementById('multiAlarmEnabled').value === 'true';
        
        // 验证基本信息
        if (!ruleName) {
          alert('请输入规则名称');
          return;
        }
        
        if (!category) {
          alert('请选择告警分类');
          return;
        }
        
        // 收集条件信息
        const conditions = [];
        const conditionElements = document.querySelectorAll('.condition-item');
        
        if (conditionElements.length === 0) {
          alert('请至少添加一个告警条件');
          return;
        }
        
        for (let i = 0; i < conditionElements.length; i++) {
          const conditionElement = conditionElements[i];
          const datapoint = conditionElement.querySelector('.condition-datapoint').value;
          const operator = conditionElement.querySelector('.condition-operator').value;
          const value = conditionElement.querySelector('.condition-value').value.trim();
          const logic = i === 0 ? 'and' : conditionElement.querySelector('.condition-logic').value;
          
          if (!datapoint || !operator || !value) {
            alert(`请完整填写条件 ${i + 1} 的所有字段`);
            return;
          }
          
          conditions.push({
            datapoint: datapoint,
            operator: operator,
            value: value,
            logic: logic
          });
        }
        
        // 创建规则对象
        const rule = {
          id: Date.now(), // 使用时间戳作为临时ID
          name: ruleName,
          category: category,
          content: content || alarmCategoryTemplates[category] || '多条件告警',
          level: level,
          consecutiveCount: consecutiveCount,
          enabled: enabled,
          conditions: conditions,
          createdAt: new Date().toISOString()
        };
        
        // 保存到后端（这里先模拟保存到本地存储）
        await saveMultiConditionAlarmRuleToBackend(rule);
        
        // 更新本地列表
        multiConditionAlarmRules.push(rule);
        
        // 刷新表格显示
        renderMultiConditionAlarmRulesTable();
        
        // 关闭模态框
        bootstrap.Modal.getInstance(document.getElementById('multiConditionAlarmModal')).hide();
        
        // 显示成功消息
        alert('多条件告警规则保存成功！');
        
      } catch (error) {
        console.error('保存多条件告警规则失败:', error);
        alert('保存失败：' + error.message);
      }
    }
    
    // 保存多条件告警规则到后端
    async function saveMultiConditionAlarmRuleToBackend(rule) {
      try {
        const response = await fetch('/api/multi-condition-alarm-rules', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(rule)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('多条件告警规则保存成功:', result);
        return result;
      } catch (error) {
        console.error('保存多条件告警规则到后端失败:', error);
        
        // 如果后端API不存在，暂时保存到本地存储
        console.log('后端API不可用，保存到本地存储');
        const storedRules = JSON.parse(localStorage.getItem('multiConditionAlarmRules') || '[]');
        storedRules.push(rule);
        localStorage.setItem('multiConditionAlarmRules', JSON.stringify(storedRules));
        
        return { success: true, id: rule.id };
      }
    }
    
    // 加载多条件告警规则
    async function loadMultiConditionAlarmRules() {
      try {
        // 尝试从后端加载
        const response = await fetch('/api/multi-condition-alarm-rules');
        
        if (response.ok) {
          multiConditionAlarmRules = await response.json();
        } else {
          // 从本地存储加载
          multiConditionAlarmRules = JSON.parse(localStorage.getItem('multiConditionAlarmRules') || '[]');
        }
        
        renderMultiConditionAlarmRulesTable();
      } catch (error) {
        console.error('加载多条件告警规则失败:', error);
        // 从本地存储加载
        multiConditionAlarmRules = JSON.parse(localStorage.getItem('multiConditionAlarmRules') || '[]');
        renderMultiConditionAlarmRulesTable();
      }
    }
    
    // 渲染多条件告警规则表格
    function renderMultiConditionAlarmRulesTable() {
      const tableBody = document.getElementById('multiConditionAlarmRulesTableBody');
      const noRulesDiv = document.getElementById('noMultiConditionAlarmRules');
      
      if (!tableBody || !noRulesDiv) return;
      
      if (multiConditionAlarmRules.length === 0) {
        tableBody.innerHTML = '';
        noRulesDiv.style.display = 'block';
        return;
      }
      
      noRulesDiv.style.display = 'none';
      
      tableBody.innerHTML = multiConditionAlarmRules.map(rule => `
        <tr>
          <td>${rule.name}</td>
          <td>
            <span class="badge bg-info">${rule.conditions.length} 个条件</span>
          </td>
          <td>
            <span class="badge bg-secondary">${getCategoryDisplayName(rule.category)}</span>
          </td>
          <td>
            <span class="badge bg-warning text-dark">${rule.consecutiveCount || 1}次</span>
          </td>
          <td>
            <div class="text-truncate" style="max-width: 200px;" title="${rule.content}">
              ${rule.content}
            </div>
          </td>
          <td>
            <span class="badge ${rule.enabled ? 'bg-success' : 'bg-secondary'}">
              ${rule.enabled ? '启用' : '禁用'}
            </span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewMultiConditionAlarmRule(${rule.id})" title="查看详情">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-outline-warning" onclick="editMultiConditionAlarmRule(${rule.id})" title="编辑">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="deleteMultiConditionAlarmRule(${rule.id})" title="删除">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    // 获取分类显示名称
    function getCategoryDisplayName(category) {
      const categoryNames = {
        'pump_fault': '水泵故障',
        'valve_fault': '阀门故障',
        'sensor_fault': '传感器故障',
        'system_fault': '系统故障',
        'communication_fault': '通信故障',
        'power_fault': '电源故障',
        'level_abnormal': '液位异常',
        'pressure_abnormal': '压力异常',
        'flow_abnormal': '流量异常',
        'temperature_abnormal': '温度异常',
        'custom': '自定义'
      };
      return categoryNames[category] || category;
    }
    
    // 查看多条件告警规则详情
    function viewMultiConditionAlarmRule(ruleId) {
      const rule = multiConditionAlarmRules.find(r => r.id === ruleId);
      if (!rule) return;
      
      let conditionsText = rule.conditions.map((condition, index) => {
        const logicText = index === 0 ? '' : ` ${condition.logic === 'and' ? '并且' : '或者'} `;
        return `${logicText}${condition.datapoint} ${getOperatorDisplayName(condition.operator)} ${condition.value}`;
      }).join('');
      
      const consecutiveCountText = rule.consecutiveCount ? `${rule.consecutiveCount}次` : '1次 (立即触发)';
      
      alert(`规则详情：
规则名称：${rule.name}
告警分类：${getCategoryDisplayName(rule.category)}
告警级别：${rule.level}
连续触发次数：${consecutiveCountText}
启用状态：${rule.enabled ? '启用' : '禁用'}
告警条件：${conditionsText}
告警内容：${rule.content}
创建时间：${new Date(rule.createdAt).toLocaleString()}`);
    }
    
    // 获取操作符显示名称
    function getOperatorDisplayName(operator) {
      const operatorNames = {
        'equals': '等于',
        'not_equals': '不等于',
        'greater_than': '大于',
        'greater_equal': '大于等于',
        'less_than': '小于',
        'less_equal': '小于等于'
      };
      return operatorNames[operator] || operator;
    }
    
    // 编辑多条件告警规则
    function editMultiConditionAlarmRule(ruleId) {
      alert('编辑功能开发中...');
    }
    
    // 删除多条件告警规则
    async function deleteMultiConditionAlarmRule(ruleId) {
      if (!confirm('确定要删除这个多条件告警规则吗？')) return;
      
      try {
        // 从后端删除
        const response = await fetch(`/api/multi-condition-alarm-rules/${ruleId}`, {
          method: 'DELETE'
        });
        
        if (!response.ok && response.status !== 404) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // 从本地列表删除
        multiConditionAlarmRules = multiConditionAlarmRules.filter(r => r.id !== ruleId);
        
        // 更新本地存储
        localStorage.setItem('multiConditionAlarmRules', JSON.stringify(multiConditionAlarmRules));
        
        // 刷新表格
        renderMultiConditionAlarmRulesTable();
        
        alert('多条件告警规则删除成功！');
      } catch (error) {
        console.error('删除多条件告警规则失败:', error);
        alert('删除失败：' + error.message);
      }
    }
    
    // 导出函数到全局作用域，供调试使用
    window.multiConditionAlarmDebug = {
      viewRules: () => console.log(multiConditionAlarmRules),
      clearRules: () => {
        multiConditionAlarmRules = [];
        localStorage.removeItem('multiConditionAlarmRules');
        renderMultiConditionAlarmRulesTable();
        console.log('已清空所有多条件告警规则');
      },
      addTestRule: () => {
        const testRule = {
          id: Date.now(),
          name: '测试规则',
          category: 'pump_fault',
          content: '这是一个测试规则',
          level: 'medium',
          enabled: true,
          conditions: [
            { datapoint: 'TEST1', operator: 'equals', value: '1', logic: 'and' },
            { datapoint: 'TEST2', operator: 'equals', value: '0', logic: 'and' }
          ],
          createdAt: new Date().toISOString()
        };
        multiConditionAlarmRules.push(testRule);
        renderMultiConditionAlarmRulesTable();
        console.log('已添加测试规则');
      }
    };

    // 【新增】处理多条件告警消息
    function processMultiConditionAlarmMessage(alarmData) {
      console.log('处理多条件告警消息:', alarmData);
      
      try {
        const { ruleId, ruleName, content, timestamp, level, conditions } = alarmData;
        
        if (!content) {
          console.error('多条件告警消息缺少内容');
          return;
        }
        
        // 构造类似单点告警的数据格式
        const processedAlarmData = {
          identifier: `multi_condition_${ruleId}`,
          content: content,
          timestamp: timestamp,
          dataPointName: `多条件告警: ${ruleName}`,
          level: level,
          ruleId: ruleId,
          ruleName: ruleName,
          conditions: conditions,
          type: 'multi_condition'
        };
        
        console.log('处理后的多条件告警数据:', processedAlarmData);
        
        // 使用现有的告警处理逻辑
        processAlarmMessage(processedAlarmData);
        
        console.log('多条件告警处理完成');
        
      } catch (error) {
        console.error('处理多条件告警消息失败:', error);
      }
    }

    // 【新增】处理多条件告警解除消息
    function processMultiConditionAlarmClearedMessage(alarmData) {
      console.log('处理多条件告警解除消息:', alarmData);
      
      try {
        const { ruleId, ruleName, clearedTime } = alarmData;
        
        // 构造类似单点告警解除的数据格式
        const processedClearedData = {
          identifier: `multi_condition_${ruleId}`,
          timestamp: clearedTime,
          dataPointName: `多条件告警: ${ruleName}`,
          type: 'multi_condition_cleared'
        };
        
        console.log('处理后的多条件告警解除数据:', processedClearedData);
        
        // 使用现有的告警解除处理逻辑
        processAlarmClearedMessage(processedClearedData);
        
        console.log('多条件告警解除处理完成');
        
      } catch (error) {
        console.error('处理多条件告警解除消息失败:', error);
      }
    }

    // 【新增】单点报警规则管理函数
    let singlePointAlarmRules = [];

    // 加载单点报警规则
    async function loadAndRenderMainPageRules() {
      console.log('加载单点报警规则...');
      
      try {
        const response = await fetch('/api/single-point-alarm/rules');
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            singlePointAlarmRules = result.data;
            console.log('单点报警规则加载成功:', singlePointAlarmRules);
            renderSinglePointAlarmRulesTable();
          } else {
            console.error('加载单点报警规则失败:', result.error);
          }
        } else {
          console.error('加载单点报警规则失败:', response.status);
        }
      } catch (error) {
        console.error('加载单点报警规则失败:', error);
      }
    }

    // 渲染单点报警规则表格
    function renderSinglePointAlarmRulesTable() {
      const tableBody = document.getElementById('alarmRulesTableBody');
      const noRulesDiv = document.getElementById('noAlarmRules');
      
      if (!tableBody) {
        console.error('未找到单点报警规则表格');
        return;
      }

      // 清空表格
      tableBody.innerHTML = '';

      if (singlePointAlarmRules.length === 0) {
        if (noRulesDiv) {
          noRulesDiv.style.display = 'block';
        }
        return;
      }

      if (noRulesDiv) {
        noRulesDiv.style.display = 'none';
      }

      // 渲染每个规则
      singlePointAlarmRules.forEach(rule => {
        const row = document.createElement('tr');
        
        // 格式化告警类型
        const alarmTypeText = rule.alarmType === 'no_update' ? '无更新报警' : '阈值报警';
        
        // 格式化阈值信息
        let thresholdText = '-';
        if (rule.alarmType === 'threshold' && rule.config) {
          const operatorText = {
            'greater_than': '大于',
            'greater_equal': '大于等于',
            'less_than': '小于',
            'less_equal': '小于等于',
            'equals': '等于',
            'not_equals': '不等于'
          }[rule.config.operator] || rule.config.operator;
          thresholdText = `${operatorText} ${rule.config.value}`;
        } else if (rule.alarmType === 'no_update' && rule.config) {
          thresholdText = `${rule.config.timeout}秒`;
        }
        
        // 格式化告警级别
        const levelText = {
          'low': '低级',
          'medium': '中级',
          'high': '高级'
        }[rule.level] || rule.level;
        
        // 格式化通知方式
        const notifications = [];
        if (rule.notifications.page) notifications.push('页面通知');
        if (rule.notifications.sound) notifications.push('声音报警');
        const notificationText = notifications.length > 0 ? notifications.join(', ') : '无';
        
        // 状态
        const statusBadge = rule.enabled ? 
          '<span class="badge bg-success">启用</span>' : 
          '<span class="badge bg-secondary">禁用</span>';

        row.innerHTML = `
          <td>${rule.dataPointName || rule.dataPointId}</td>
          <td>${alarmTypeText}</td>
          <td>${thresholdText}</td>
          <td><span class="badge bg-${rule.level === 'high' ? 'danger' : rule.level === 'medium' ? 'warning' : 'info'}">${levelText}</span></td>
          <td>${notificationText}</td>
          <td>${statusBadge}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewSinglePointAlarmRule(${rule.id})" title="查看详情">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-warning me-1" onclick="editSinglePointAlarmRule(${rule.id})" title="编辑">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-${rule.enabled ? 'secondary' : 'success'} me-1" onclick="toggleSinglePointAlarmRule(${rule.id})" title="${rule.enabled ? '禁用' : '启用'}">
              <i class="bi bi-${rule.enabled ? 'pause' : 'play'}"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSinglePointAlarmRule(${rule.id})" title="删除">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });

      console.log(`单点报警规则表格渲染完成，共 ${singlePointAlarmRules.length} 条规则`);
    }

    // 查看单点报警规则详情
    function viewSinglePointAlarmRule(ruleId) {
      const rule = singlePointAlarmRules.find(r => r.id === ruleId);
      if (!rule) {
        alert('规则不存在');
        return;
      }

      let configText = '';
      if (rule.alarmType === 'no_update') {
        configText = `超时时间: ${rule.config.timeout}秒`;
      } else if (rule.alarmType === 'threshold') {
        const operatorText = {
          'greater_than': '大于',
          'greater_equal': '大于等于',
          'less_than': '小于',
          'less_equal': '小于等于',
          'equals': '等于',
          'not_equals': '不等于'
        }[rule.config.operator] || rule.config.operator;
        configText = `条件: 数值 ${operatorText} ${rule.config.value}\n持续时间: ${rule.config.duration}秒\n检查间隔: ${rule.config.checkInterval}秒`;
      }

      const notifications = [];
      if (rule.notifications.page) notifications.push('页面通知');
      if (rule.notifications.sound) notifications.push('声音报警');

      alert(`单点报警规则详情：
规则名称：${rule.name}
数据点：${rule.dataPointName} (${rule.dataPointId})
告警类型：${rule.alarmType === 'no_update' ? '无更新报警' : '阈值报警'}
${configText}
告警级别：${rule.level}
告警内容：${rule.content}
通知方式：${notifications.join(', ') || '无'}
启用状态：${rule.enabled ? '启用' : '禁用'}
创建时间：${new Date(rule.createdAt).toLocaleString()}`);
    }

    // 编辑单点报警规则
    function editSinglePointAlarmRule(ruleId) {
      alert('编辑功能开发中...');
    }

    // 切换单点报警规则状态
    async function toggleSinglePointAlarmRule(ruleId) {
      try {
        const response = await fetch(`/api/single-point-alarm/rules/${ruleId}/toggle`, {
          method: 'PATCH'
        });

        if (response.ok) {
          const result = await response.json();
          console.log('规则状态切换成功:', result);
          
          // 重新加载规则列表
          await loadAndRenderMainPageRules();
          
          alert('规则状态切换成功！');
        } else {
          const error = await response.json();
          throw new Error(error.error || '切换失败');
        }
      } catch (error) {
        console.error('切换规则状态失败:', error);
        alert('切换失败: ' + error.message);
      }
    }

    // 删除单点报警规则
    async function deleteSinglePointAlarmRule(ruleId) {
      const rule = singlePointAlarmRules.find(r => r.id === ruleId);
      if (!rule) {
        alert('规则不存在');
        return;
      }

      if (!confirm(`确定要删除单点报警规则"${rule.name}"吗？`)) {
        return;
      }

      try {
        const response = await fetch(`/api/single-point-alarm/rules/${ruleId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          const result = await response.json();
          console.log('规则删除成功:', result);
          
          // 重新加载规则列表
          await loadAndRenderMainPageRules();
          
          alert('单点报警规则删除成功！');
        } else {
          const error = await response.json();
          throw new Error(error.error || '删除失败');
        }
      } catch (error) {
        console.error('删除规则失败:', error);
        alert('删除失败: ' + error.message);
      }
    }

    // 页面加载时自动加载单点报警规则
    document.addEventListener('DOMContentLoaded', function() {
      // 延迟加载，确保页面完全初始化
      setTimeout(() => {
        loadAndRenderMainPageRules();
      }, 1000);
    });
  </script>

  <!-- 单点报警模态框 (动态加载) -->
  <div id="singlePointAlarmModalContainer"></div>

  <!-- 加载单点报警相关文件 -->
  <script>
    // 单点报警模块初始化状态
    let singlePointAlarmModuleReady = false;
    let modalHtmlLoaded = false;
    let scriptLoaded = false;

    // 动态加载单点报警HTML模态框
    function loadSinglePointAlarmModal() {
      console.log('开始加载单点报警模态框HTML...');
      fetch('/html/single-point-alarm-modal.html')
        .then(response => {
          if (response.ok) {
            return response.text();
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        })
        .then(html => {
          document.getElementById('singlePointAlarmModalContainer').innerHTML = html;
          modalHtmlLoaded = true;
          console.log('单点报警模态框HTML加载成功');
          checkModuleReady();
        })
        .catch(error => {
          console.error('加载单点报警模态框失败:', error);
          alert('单点报警模态框加载失败，请刷新页面重试');
        });
    }

    // 动态加载单点报警JavaScript
    function loadSinglePointAlarmScript() {
      console.log('开始加载单点报警JavaScript...');
      
      // 检查是否已经有脚本标签
      const existingScripts = Array.from(document.querySelectorAll('script')).filter(s => 
        s.src && s.src.includes('single-point-alarm.js'));
      if (existingScripts.length > 0) {
        console.log('发现已存在的脚本标签:', existingScripts.length);
        existingScripts.forEach(script => {
          console.log('脚本状态:', {
            src: script.src,
            loaded: script.readyState,
            error: script.error
          });
        });
      }
      
      const script = document.createElement('script');
      script.src = '/js/single-point-alarm.js?t=' + Date.now(); // 添加时间戳避免缓存
      script.type = 'text/javascript';
      
      script.onload = function() {
        console.log('✓ 单点报警JavaScript文件加载成功');
        console.log('脚本执行后window对象检查:', {
          showSinglePointAlarmModal: typeof window.showSinglePointAlarmModal,
          loadDataPoints: typeof window.loadDataPoints,
          onAlarmTypeChange: typeof window.onAlarmTypeChange
        });
        
        scriptLoaded = true;
        
        // 等待一小段时间确保脚本执行完毕
        setTimeout(() => {
          console.log('延迟检查函数是否已注册到window:', {
            showSinglePointAlarmModal: typeof window.showSinglePointAlarmModal,
            allWindowKeys: Object.keys(window).filter(key => key.includes('showSingle') || key.includes('alarm'))
          });
          
          checkModuleReady();
          
          // 立即再次检查函数是否存在，有时需要额外时间
          setTimeout(() => {
            if (typeof window.showSinglePointAlarmModal === 'function' && !singlePointAlarmModuleReady) {
              console.log('函数已存在但模块未标记为就绪，立即更新状态');
              singlePointAlarmModuleReady = true;
              bindSinglePointAlarmButton();
            } else if (typeof window.showSinglePointAlarmModal !== 'function') {
              console.error('❌ 函数仍然不存在，检查脚本执行');
              // 尝试手动执行脚本内容
              fetch('/js/single-point-alarm.js')
                .then(response => response.text())
                .then(scriptText => {
                  console.log('手动执行脚本内容...');
                  try {
                    eval(scriptText);
                    console.log('手动执行成功，重新检查函数:', typeof window.showSinglePointAlarmModal);
                    if (typeof window.showSinglePointAlarmModal === 'function') {
                      singlePointAlarmModuleReady = true;
                      checkModuleReady();
                    }
                  } catch (evalError) {
                    console.error('手动执行脚本失败:', evalError);
                  }
                })
                .catch(fetchError => {
                  console.error('获取脚本内容失败:', fetchError);
                });
            }
          }, 200);
        }, 100);
      };
      
      script.onerror = function(error) {
        console.error('❌ 加载单点报警JavaScript失败', error);
        console.error('脚本路径:', script.src);
        console.error('错误详情:', {
          type: error.type,
          target: error.target,
          message: error.message
        });
        
        // 尝试直接请求检查文件是否存在
        fetch('/js/single-point-alarm.js')
          .then(response => {
            if (response.ok) {
              console.log('文件存在但加载失败，状态:', response.status);
              return response.text();
            } else {
              console.error('文件不存在，HTTP状态:', response.status);
              throw new Error('File not found: ' + response.status);
            }
          })
          .then(content => {
            console.log('文件内容长度:', content.length);
            console.log('文件开头:', content.substring(0, 200));
          })
          .catch(fetchError => {
            console.error('fetch检查失败:', fetchError);
          });
          
        alert('单点报警功能加载失败，请检查网络连接并刷新页面重试');
      };
      
      console.log('准备添加脚本标签到head:', script.src);
      document.head.appendChild(script);
      
      // 设置超时检查
      setTimeout(() => {
        if (!scriptLoaded) {
          console.error('❌ 脚本加载超时');
          script.onerror(new Error('Script load timeout'));
        }
      }, 10000); // 10秒超时
    }

    // 检查模块是否完全准备就绪
    function checkModuleReady() {
      console.log('检查模块状态:', {
        modalHtmlLoaded: modalHtmlLoaded,
        scriptLoaded: scriptLoaded,
        functionExists: typeof window.showSinglePointAlarmModal === 'function'
      });
      
      if (modalHtmlLoaded && scriptLoaded && typeof window.showSinglePointAlarmModal === 'function') {
        singlePointAlarmModuleReady = true;
        console.log('单点报警模块完全准备就绪');
        
        // 绑定按钮事件
        bindSinglePointAlarmButton();
      } else {
        console.log('模块尚未完全准备就绪，详情:', {
          modalHtmlLoaded: modalHtmlLoaded,
          scriptLoaded: scriptLoaded,
          functionExists: typeof window.showSinglePointAlarmModal === 'function'
        });
        
        // 如果HTML和脚本都已加载但函数不存在，延迟重试
        if (modalHtmlLoaded && scriptLoaded && typeof window.showSinglePointAlarmModal !== 'function') {
          setTimeout(() => {
            console.log('延迟重试检查函数是否存在...');
            if (typeof window.showSinglePointAlarmModal === 'function') {
              singlePointAlarmModuleReady = true;
              console.log('延迟重试成功，模块已就绪');
              bindSinglePointAlarmButton();
            }
          }, 1000);
        }
      }
    }

    // 绑定单点报警管理按钮事件
    function bindSinglePointAlarmButton() {
      console.log('=== 开始绑定单点报警按钮事件 ===');
      const singlePointAlarmBtn = document.getElementById('singlePointAlarmManageBtn');
      
      if (singlePointAlarmBtn) {
        console.log('✓ 找到单点报警管理按钮');
        console.log('当前模块状态:', {
          modalHtmlLoaded: modalHtmlLoaded,
          scriptLoaded: scriptLoaded,
          singlePointAlarmModuleReady: singlePointAlarmModuleReady,
          functionExists: typeof window.showSinglePointAlarmModal === 'function'
        });
        
        // 移除可能存在的旧事件监听器
        singlePointAlarmBtn.replaceWith(singlePointAlarmBtn.cloneNode(true));
        const newBtn = document.getElementById('singlePointAlarmManageBtn');
        
        newBtn.addEventListener('click', function(event) {
          console.log('=== 单点报警管理按钮被点击 ===');
          event.preventDefault();
          
          console.log('点击时模块状态:', {
            modalHtmlLoaded: modalHtmlLoaded,
            scriptLoaded: scriptLoaded,
            singlePointAlarmModuleReady: singlePointAlarmModuleReady,
            functionExists: typeof window.showSinglePointAlarmModal === 'function'
          });
          
          // 检查模态框容器是否存在
          const modalContainer = document.getElementById('singlePointAlarmModalContainer');
          console.log('模态框容器状态:', {
            exists: !!modalContainer,
            hasContent: modalContainer ? modalContainer.innerHTML.length > 0 : false
          });
          
          // 检查模态框元素是否存在
          const modal = document.getElementById('singlePointAlarmModal');
          console.log('模态框元素存在:', !!modal);
          
          // 简化判断逻辑，直接检查函数是否存在
          if (typeof window.showSinglePointAlarmModal === 'function') {
            try {
              console.log('✓ 准备调用showSinglePointAlarmModal函数');
              window.showSinglePointAlarmModal();
              console.log('✓ showSinglePointAlarmModal调用成功');
            } catch (error) {
              console.error('❌ 调用showSinglePointAlarmModal失败:', error);
              console.error('错误堆栈:', error.stack);
              alert('打开单点报警配置失败: ' + error.message);
            }
          } else {
            console.log('❌ showSinglePointAlarmModal函数不存在');
            console.log('详细状态检查:');
            console.log('- modalHtmlLoaded:', modalHtmlLoaded);
            console.log('- scriptLoaded:', scriptLoaded);
            console.log('- showSinglePointAlarmModal function:', typeof window.showSinglePointAlarmModal);
            
            // 尝试重新加载和初始化
            alert('单点报警模块正在初始化中，正在重新加载...');
            
            // 强制重新加载
            if (!modalHtmlLoaded) {
              console.log('重新加载模态框HTML...');
              loadSinglePointAlarmModal();
            }
            
            if (!scriptLoaded) {
              console.log('重新加载JavaScript...');
              loadSinglePointAlarmScript();
            }
            
            // 延迟重试
            setTimeout(() => {
              console.log('延迟重试检查模块状态...');
              if (typeof window.showSinglePointAlarmModal === 'function') {
                console.log('✓ 延迟重试成功，调用showSinglePointAlarmModal');
                singlePointAlarmModuleReady = true;
                window.showSinglePointAlarmModal();
              } else {
                console.log('❌ 延迟重试仍然失败');
                alert('单点报警模块加载失败，请刷新页面重试');
              }
            }, 2000);
          }
        });
        
        console.log('✓ 单点报警管理按钮事件绑定成功');
      } else {
        console.error('❌ 未找到单点报警管理按钮 (ID: singlePointAlarmManageBtn)');
        console.log('当前页面中的按钮元素:', document.querySelectorAll('button[id*="alarm"]'));
        
        // 延迟重试查找按钮
        setTimeout(() => {
          console.log('延迟重试查找单点报警按钮...');
          bindSinglePointAlarmButton();
        }, 1000);
      }
    }

    // 页面加载时初始化单点报警模块
    document.addEventListener('DOMContentLoaded', function() {
      console.log('开始初始化单点报警模块...');
      
      // 顺序加载，先加载HTML再加载JS
      loadSinglePointAlarmModal();
      
      // 延迟加载JavaScript，确保HTML先加载
      setTimeout(() => {
        loadSinglePointAlarmScript();
      }, 500);
      
      // 绑定调试按钮
      setTimeout(() => {
        const debugBtn = document.getElementById('debugSinglePointAlarmBtn');
        if (debugBtn) {
          debugBtn.addEventListener('click', function() {
            console.log('=== 单点报警模块调试信息 ===');
            console.log('模块状态:', {
              modalHtmlLoaded: modalHtmlLoaded,
              scriptLoaded: scriptLoaded,
              singlePointAlarmModuleReady: singlePointAlarmModuleReady,
              functionExists: typeof window.showSinglePointAlarmModal === 'function'
            });
            
            const modalContainer = document.getElementById('singlePointAlarmModalContainer');
            console.log('模态框容器:', {
              exists: !!modalContainer,
              hasContent: modalContainer ? modalContainer.innerHTML.length : 0,
              content: modalContainer ? modalContainer.innerHTML.substring(0, 200) : null
            });
            
            const modal = document.getElementById('singlePointAlarmModal');
            console.log('模态框元素存在:', !!modal);
            
            // 检查脚本文件是否存在
            const scripts = Array.from(document.querySelectorAll('script')).filter(s => 
              s.src && s.src.includes('single-point-alarm.js'));
            console.log('JavaScript脚本:', scripts.length > 0 ? scripts[0].src : 'not found');
            
            // 强制重新初始化
            if (!modalHtmlLoaded || !scriptLoaded) {
              console.log('强制重新初始化...');
              modalHtmlLoaded = false;
              scriptLoaded = false;
              singlePointAlarmModuleReady = false;
              
              loadSinglePointAlarmModal();
              setTimeout(() => {
                loadSinglePointAlarmScript();
              }, 500);
            } else if (typeof window.showSinglePointAlarmModal === 'function') {
              console.log('模块已就绪，尝试直接调用...');
              try {
                window.showSinglePointAlarmModal();
              } catch (error) {
                console.error('直接调用失败:', error);
              }
            } else {
              console.log('函数不存在，尝试强制重新加载脚本...');
              // 强制重新加载JavaScript文件
              fetch('/js/single-point-alarm.js?t=' + Date.now())
                .then(response => response.text())
                .then(scriptContent => {
                  console.log('获取到脚本内容，长度:', scriptContent.length);
                  console.log('脚本开头:', scriptContent.substring(0, 300));
                  console.log('脚本结尾:', scriptContent.substring(scriptContent.length - 300));
                  
                  // 直接执行脚本
                  try {
                    eval(scriptContent);
                    console.log('手动执行脚本完成');
                    console.log('执行后函数检查:', {
                      showSinglePointAlarmModal: typeof window.showSinglePointAlarmModal,
                      loadDataPoints: typeof window.loadDataPoints,
                      onAlarmTypeChange: typeof window.onAlarmTypeChange
                    });
                    
                    if (typeof window.showSinglePointAlarmModal === 'function') {
                      singlePointAlarmModuleReady = true;
                      scriptLoaded = true;
                      console.log('手动执行成功，尝试调用函数...');
                      window.showSinglePointAlarmModal();
                    }
                  } catch (execError) {
                    console.error('手动执行脚本失败:', execError);
                    console.error('执行错误堆栈:', execError.stack);
                  }
                })
                .catch(fetchError => {
                  console.error('获取脚本内容失败:', fetchError);
                });
            }
          });
          console.log('调试按钮绑定成功');
        }
      }, 1000);
      
      // 最终检查，确保模块在所有情况下都能正确初始化
      setTimeout(() => {
        console.log('执行最终模块状态检查...');
        if (typeof window.showSinglePointAlarmModal === 'function' && !singlePointAlarmModuleReady) {
          console.log('最终检查发现函数已存在但模块未就绪，立即修复');
          singlePointAlarmModuleReady = true;
          bindSinglePointAlarmButton();
        } else if (!singlePointAlarmModuleReady) {
          console.log('最终检查：模块仍未就绪，状态:', {
            modalHtmlLoaded: modalHtmlLoaded,
            scriptLoaded: scriptLoaded,
            functionExists: typeof window.showSinglePointAlarmModal === 'function'
          });
        } else {
          console.log('最终检查：模块状态正常');
        }
      }, 3000);
    });
  </script>
</body>
</html> 